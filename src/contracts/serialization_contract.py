"""
Архитектурный контракт для сериализации компонентов системы.

Определяет интерфейсы и гарантии для методов to_dict() во всех компонентах.
Обеспечивает thread-safety, эффективность и отказоустойчивость сериализации.
"""

from abc import ABC, abstractmethod
from typing import Dict, Any, Protocol, runtime_checkable


@runtime_checkable
class Serializable(Protocol):
    """
    Базовый протокол для сериализуемых компонентов.

    Гарантирует только базовую функциональность сериализации.
    Не накладывает ограничений на thread-safety или другие аспекты.
    """

    def to_dict(self) -> Dict[str, Any]:
        """
        Сериализовать состояние компонента в словарь.

        Returns:
            Dict[str, Any]: Словарь с состоянием компонента

        Примечание: Этот протокол не гарантирует thread-safety.
        Для thread-safe сериализации используйте ThreadSafeSerializable.
        """
        ...


@runtime_checkable
class MetadataProvider(Protocol):
    """
    Протокол для компонентов, предоставляющих метаданные сериализации.

    Отделяет ответственность за метаданные от базовой сериализации.
    """

    def get_serialization_metadata(self) -> Dict[str, Any]:
        """
        Получить метаданные сериализации для валидации и отладки.

        Returns:
            Dict[str, Any]: Метаданные содержащие как минимум:
            - version: str - версия формата сериализации
            - timestamp: float - время сериализации
            - component_type: str - тип компонента
        """
        ...


@runtime_checkable
class ThreadSafeSerializable(Serializable, MetadataProvider, Protocol):
    """
    Композитный протокол для полностью thread-safe сериализуемых компонентов.

    Комбинирует базовую сериализацию с метаданными и гарантиями thread-safety.
    """

    def to_dict(self) -> Dict[str, Any]:
        """
        Thread-safe сериализация состояния компонента.

        Архитектурные гарантии:
        - Thread-safe: Метод безопасен для вызова из разных потоков
        - Атомарный: Сериализация представляет консистентное состояние
        - Отказоустойчивый: Исключения не должны приводить к повреждению состояния
        - Детерминированный: Для одинакового состояния возвращает одинаковый результат

        Returns:
            Dict[str, Any]: Словарь с состоянием компонента
        """
        ...

    def get_serialization_metadata(self) -> Dict[str, Any]:
        """
        Thread-safe получение метаданных сериализации.

        Returns:
            Dict[str, Any]: Метаданные содержащие как минимум:
            - version: str - версия формата сериализации
            - timestamp: float - время сериализации
            - component_type: str - тип компонента
            - thread_safe: bool - подтверждение thread-safety
        """
        ...


class SerializationContract(ABC, ThreadSafeSerializable):
    """
    Архитектурный контракт для компонентов с полной поддержкой сериализации.

    Определяет стандартные гарантии и интерфейсы для всех сериализуемых компонентов.
    Наследуется от ThreadSafeSerializable для обеспечения полной функциональности.
    """

    @abstractmethod
    def to_dict(self) -> Dict[str, Any]:
        """
        Сериализовать состояние компонента.

        Архитектурный контракт:
        1. Thread-safety: Метод должен быть безопасен для конкурентного доступа
        2. Атомарность: Сериализация должна представлять консистентное состояние
        3. Отказоустойчивость: Исключения не должны повреждать внутреннее состояние
        4. Эффективность: Сериализация должна быть эффективной по ресурсам
        5. Детерминированность: Одинаковое состояние -> одинаковый результат

        Returns:
            Dict[str, Any]: Сериализованное состояние с гарантированной структурой

        Raises:
            SerializationError: Если сериализация невозможна по системным причинам
        """
        pass

    @abstractmethod
    def get_serialization_metadata(self) -> Dict[str, Any]:
        """
        Получить метаданные сериализации для валидации и отладки.

        Returns:
            Dict[str, Any]: Метаданные содержащие как минимум:
            - version: str - версия формата сериализации
            - timestamp: float - время сериализации
            - component_type: str - тип компонента
            - thread_safe: bool - подтверждение thread-safety
        """
        pass


class SerializationError(Exception):
    """
    Исключение при ошибках сериализации.

    Указывает на проблемы с сериализацией состояния компонента.
    """
    pass

