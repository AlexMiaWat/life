name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ (–ª–∏–Ω—Ç–∏–Ω–≥, —Ç–∏–ø–∏–∑–∞—Ü–∏—è)
  quality:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install black ruff isort mypy

    - name: Lint with ruff
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é ruff..."
        ruff check src/ --output-format=github || true

    - name: Format check with black
      run: |
        echo "üé® –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø–æ–º–æ—â—å—é black..."
        black --check src/ || true

    - name: Import sorting check with isort
      run: |
        echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é isort..."
        isort --check-only --profile black src/ || true

    - name: Type check with mypy
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ —Å –ø–æ–º–æ—â—å—é mypy..."
        mypy src/ || true

  # –ú–∞—Ç—Ä–∏—Ü–∞ —Ç–µ—Å—Ç–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  test-matrix:
    runs-on: ubuntu-latest
    needs: quality
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' &&
       (matrix.test-category.run_on_pr == true || contains(github.event.pull_request.labels.*.name, 'full-test-suite')))
    strategy:
      fail-fast: false
      matrix:
        test-category:
          - name: "unit"
            marker: "unit"
            description: "Unit —Ç–µ—Å—Ç—ã (–±—ã—Å—Ç—Ä—ã–µ, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)"
            timeout: 10
            run_on_pr: true
          - name: "static"
            marker: "static"
            description: "Static analysis —Ç–µ—Å—Ç—ã (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Ç–∏–ø—ã)"
            timeout: 5
            run_on_pr: true
          - name: "smoke"
            marker: "smoke"
            description: "Smoke —Ç–µ—Å—Ç—ã (–±–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)"
            timeout: 15
            run_on_pr: true
          - name: "integration"
            marker: "integration"
            description: "Integration —Ç–µ—Å—Ç—ã (–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)"
            timeout: 20
            run_on_pr: false
          - name: "performance"
            marker: "performance"
            description: "Performance —Ç–µ—Å—Ç—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–π"
            timeout: 30
            run_on_pr: false
          - name: "concurrency"
            marker: "concurrency"
            description: "Concurrency —Ç–µ—Å—Ç—ã (–º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å, race conditions)"
            timeout: 25
            run_on_pr: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-order pytest-xdist hypothesis

    - name: Run ${{ matrix.test-category.description }}
      timeout-minutes: ${{ matrix.test-category.timeout }}
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ ${{ matrix.test-category.description }}..."

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ç–µ—Å—Ç–æ–≤
        EXTRA_OPTS=""
        if [ "${{ matrix.test-category.name }}" = "performance" ]; then
          EXTRA_OPTS="--tb=short -x"
        elif [ "${{ matrix.test-category.name }}" = "concurrency" ]; then
          EXTRA_OPTS="--tb=short -n auto"
        else
          EXTRA_OPTS="--tb=short -v"
        fi

        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏
        pytest src/test/ -m "${{ matrix.test-category.marker }}" $EXTRA_OPTS \
          --junitxml=test-results-${{ matrix.test-category.name }}.xml \
          --cov=src --cov-report=xml --cov-report=term-missing \
          --cov-append --cov-branch

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.test-category.name }}
        path: test-results-${{ matrix.test-category.name }}.xml
        retention-days: 30

    - name: Upload coverage data
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-data-${{ matrix.test-category.name }}
        path: .coverage*
        retention-days: 30

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥—Ä–µ—Å—Å–∏–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤–µ—Ç–æ–∫)
  performance-regression:
    runs-on: ubuntu-latest
    needs: test-matrix
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') ||
      contains(github.event.pull_request.labels.*.name, 'performance-check')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Download baseline
      uses: actions/download-artifact@v4
      with:
        name: performance-baseline
        path: data/
      continue-on-error: true

    - name: Initialize baseline if needed
      run: |
        if [ ! -f "data/performance_baseline.json" ]; then
          echo "üìä –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è baseline –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏..."
          python init_performance_baseline.py
        else
          echo "‚úÖ Baseline —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω"
        fi

    - name: Run performance regression check
      run: |
        echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥—Ä–µ—Å—Å–∏–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏..."
        python run_performance_tests.py

    - name: Upload performance report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-regression-report
        path: docs/results/performance_regression_report.md
        retention-days: 30

    - name: Update performance baseline
      if: github.ref == 'refs/heads/main'
      run: |
        echo "üíæ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ baseline –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏..."
        python run_performance_tests.py --update-baseline

    - name: Upload updated baseline
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: performance-baseline
        path: data/performance_baseline.json
        retention-days: 365

  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–≤–æ–¥–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤
  reports:
    runs-on: ubuntu-latest
    needs: [quality, test-matrix, performance-regression]
    if: always()
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Download coverage data
      uses: actions/download-artifact@v4
      with:
        pattern: coverage-data-*
        path: coverage-data/
        merge-multiple: true

    - name: Generate coverage report
      run: |
        echo "üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏..."
        pip install coverage
        coverage combine coverage-data/
        coverage html --title="Life Project Coverage Report"
        coverage xml

    - name: Generate test summary report
      run: |
        echo "üìã –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏..."
        python analyze_test_results.py --results-dir artifacts --output docs/results/ci_test_summary_$(date +%Y%m%d_%H%M%S).md

    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-html
        path: htmlcov/
        retention-days: 30

    - name: Upload coverage XML
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-xml
        path: coverage.xml
        retention-days: 30

    - name: Upload test summary
      uses: actions/upload-artifact@v4
      with:
        name: test-summary-report
        path: docs/results/
        retention-days: 30

  # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
  summary:
    runs-on: ubuntu-latest
    needs: [quality, test-matrix, performance-regression, reports]
    if: always()
    steps:
    - name: CI Pipeline Summary
      run: |
        echo "üéØ CI Pipeline –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo ""
        echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:"
        echo "‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞: ${{ needs.quality.result }}"
        echo "‚úÖ –ú–∞—Ç—Ä–∏—Ü–∞ —Ç–µ—Å—Ç–æ–≤: ${{ needs.test-matrix.result }}"
        echo "‚úÖ –†–µ–≥—Ä–µ—Å—Å–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: ${{ needs.performance-regression.result }}"
        echo "‚úÖ –û—Ç—á–µ—Ç—ã: ${{ needs.reports.result }}"
        echo ""

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å
        if [ "${{ needs.quality.result }}" = "success" ] && \
           [ "${{ needs.test-matrix.result }}" = "success" ] && \
           [ "${{ needs.performance-regression.result }}" != "failure" ] && \
           [ "${{ needs.reports.result }}" = "success" ]; then
          echo "üéâ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
          exit 0
        else
          echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –≤ pipeline"
          echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"
          exit 1
        fi
