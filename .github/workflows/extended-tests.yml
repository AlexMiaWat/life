name: Extended Tests

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
    inputs:
      test_categories:
        description: '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ (slow, real_server, e2e, dev_mode)'
        required: false
        default: 'slow,real_server,e2e,dev_mode'
        type: string
  schedule:
    - cron: '0 2 * * 1-5'  # –ö–∞–∂–¥—É—é –Ω–æ—á—å —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ –ø–æ –ø—è—Ç–Ω–∏—Ü—É –≤ 2:00 UTC

env:
  PYTHON_VERSION: "3.11"

jobs:
  extended-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - test-category:
              name: "slow"
              marker: "slow"
              description: "–ú–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (>30 —Å–µ–∫)"
              timeout: 60  # –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
          - test-category:
              name: "real_server"
              marker: "real_server"
              description: "–¢–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º"
              timeout: 45
          - test-category:
              name: "e2e"
              marker: "e2e"
              description: "End-to-end —Ç–µ—Å—Ç—ã"
              timeout: 30
          - test-category:
              name: "dev_mode"
              marker: "dev_mode"
              description: "–¢–µ—Å—Ç—ã —Ä–µ–∂–∏–º–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
              timeout: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-order pytest-xdist hypothesis

    - name: Run ${{ matrix.test-category.description }}
      timeout-minutes: ${{ matrix.test-category.timeout }}
      if: contains(github.event.inputs.test_categories, matrix.test-category.name) || github.event_name == 'schedule'
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ ${{ matrix.test-category.description }}..."

        # –î–ª—è real_server —Ç–µ—Å—Ç–æ–≤ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
        if [ "${{ matrix.test-category.name }}" = "real_server" ]; then
          echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è real_server —Ç–µ—Å—Ç–æ–≤..."
          # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å–µ—Ä–≤–µ—Ä–∞, –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Ç.–¥.
        fi

        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        pytest src/test/ -m "${{ matrix.test-category.marker }}" --tb=short -v \
          --junitxml=test-results-extended-${{ matrix.test-category.name }}.xml \
          --cov=src --cov-report=xml --cov-report=term-missing \
          --cov-append --cov-branch

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always() && (contains(github.event.inputs.test_categories, matrix.test-category.name) || github.event_name == 'schedule')
      with:
        name: extended-test-results-${{ matrix.test-category.name }}
        path: test-results-extended-${{ matrix.test-category.name }}.xml
        retention-days: 7

    - name: Upload coverage data
      uses: actions/upload-artifact@v4
      if: always() && (contains(github.event.inputs.test_categories, matrix.test-category.name) || github.event_name == 'schedule')
      with:
        name: extended-coverage-data-${{ matrix.test-category.name }}
        path: .coverage*
        retention-days: 7

  notify:
    runs-on: ubuntu-latest
    needs: extended-tests
    if: always() && github.event_name == 'schedule'
    steps:
    - name: Notify about extended test results
      run: |
        if [ "${{ needs.extended-tests.result }}" = "success" ]; then
          echo "‚úÖ Extended tests passed"
        else
          echo "‚ùå Extended tests failed"
          # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        fi
