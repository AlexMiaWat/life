# Компонент Observability

**Последнее обновление:** 2026-01-22
**Статус:** Стабильно
**Архитектурное решение:** [ADR 001](decisions/adr_001_passive_observation_boundaries.md)

---

## Обзор

Компонент Observability предоставляет инструменты для пассивного сбора сырых данных о поведении системы Life. Система спроектирована с строгим соблюдением принципов пассивности и отсутствия влияния на runtime.

## Архитектурные принципы

### 1. Истинная пассивность
- **Нет влияния на производительность**: Сбор данных не замедляет систему Life
- **Внешняя интеграция**: Все компоненты работают вне runtime loop
- **Опциональность**: Система полностью отключаема без потери функциональности

### 2. Только сырые данные
- **Запрещены расчеты**: rate, frequency, averages, trends
- **Только counters**: raw счетчики без интерпретации
- **Без анализа**: отсутствие выводов о поведении системы

### 3. Внешний анализ
- **Экспорт данных**: JSON/CSV для внешних инструментов
- **Отдельные инструменты**: анализ проводится вне системы Life
- **Без обратной связи**: данные не влияют на поведение

## Компоненты системы

### RawDataCollector
**Файл:** `src/observability/external_observer.py`

Сборщик исключительно сырых счетчиков из внешних источников (логи, снимки).

**Собираемые данные:**
- `cycle_count`: количество циклов выполнения
- `uptime_seconds`: время работы в секундах
- `memory_entries_count`: количество записей в памяти
- `error_count`: количество ошибок
- `action_count`: количество действий
- `event_count`: количество событий
- `state_change_count`: количество изменений состояния

### AsyncPassiveObserver
**Файл:** `src/observability/async_passive_observer.py`

Асинхронный наблюдатель, работающий в отдельном потоке.

**Особенности:**
- Отдельный поток выполнения
- Чтение snapshot файлов без доступа к runtime
- Graceful error handling
- Полностью опционален

### ObservationExporter
**Файл:** `src/observability/observation_api.py`

Экспортер данных для внешнего анализа.

**Форматы экспорта:**
- JSON с метаданными
- CSV для табличного анализа
- Фильтрация по времени и типам данных

### DataCollector
**Файл:** `src/observability/data_collector.py`

Хранилище собранных данных с буферизацией.

**Особенности:**
- JSONL формат хранения
- Буферизация для производительности
- Thread-safe операции

## Архитектурные границы

### ✅ Допустимые паттерны

1. **Внешний сбор данных**
   ```python
   # Чтение существующих snapshot файлов
   snapshot = load_snapshot_from_file()
   ```

2. **Только raw counters**
   ```python
   counters = RawSystemCounters(
       cycle_count=1000,
       error_count=5,
       # Никаких расчетов rate/frequency!
   )
   ```

3. **Асинхронная работа**
   ```python
   # Отдельный поток, не влияющий на runtime
   observer = AsyncPassiveObserver()
   ```

### ❌ Запрещенные паттерны

1. **Синхронные вызовы в runtime**
   ```python
   # ЗАПРЕЩЕНО: влияет на производительность
   collect_data_in_runtime_loop()
   ```

2. **Расчетные поля**
   ```python
   # ЗАПРЕЩЕНО: интерпретация данных
   event_processing_rate = events / time  # расчет!
   ```

3. **Обратная связь**
   ```python
   # ЗАПРЕЩЕНО: влияние на поведение
   if observation_data.shows_problem:
       change_system_behavior()
   ```

4. **Интерпретация поведения**
   ```python
   # ЗАПРЕЩЕНО: анализ вместо сбора
   if system_is_learning:
       recommendations = ["увеличить память"]
   ```

## Интеграция

### Отсутствие интеграции в runtime

В соответствии с ADR 001, система observability **полностью исключена** из runtime loop:

```python
# runtime/loop.py - НЕТ интеграции observability
# enable_passive_observation=False  # Удалено
# observation_collection_interval=300  # Удалено
```

### Запуск наблюдения

```python
from src.observability import AsyncPassiveObserver

# Запуск в отдельном процессе/потоке
observer = AsyncPassiveObserver(
    collection_interval=300,  # секунды, не тики!
    snapshots_dir="data/snapshots"
)
```

## Использование данных

### Экспорт для анализа

```python
from src.observability import ObservationExporter

exporter = ObservationExporter(data_collector, history_manager)

# Экспорт в JSON
exporter.export_state_data_json("state_export.json")

# Экспорт в CSV
exporter.export_state_data_csv("state_export.csv")
```

### Внешний анализ

Данные предназначены для анализа внешними инструментами:

- **Графики производительности**: построение графиков на основе raw данных
- **Отладка проблем**: анализ логов и счетчиков ошибок
- **Мониторинг роста**: отслеживание изменения счетчиков со временем

## Тестирование

### Архитектурные тесты
- **Производительность**: измерение влияния на ticks/sec (< 1%)
- **Изоляция**: проверка отсутствия доступа к runtime объектам
- **Пассивность**: проверка только raw данных без расчетов

### Функциональные тесты
- **Экспорт**: корректность JSON/CSV форматов
- **Асинхронность**: работа в отдельном потоке
- **Обработка ошибок**: graceful degradation при проблемах

## Мониторинг и поддержка

### Метрики использования
- Количество собранных записей
- Размер хранилища данных
- Время работы observer thread

### Логирование
- DEBUG: детали сбора данных
- INFO: статус операций
- WARNING: проблемы с доступом к файлам
- ERROR: критические ошибки

## Риски и ограничения

### Производительность
- Потенциальное влияние на диск I/O при большом объеме данных
- Ограничение: < 1% влияния на общую производительность

### Хранение
- Автоматическая ротация файлов
- Ограничение размера хранилища

### Надежность
- Graceful degradation при ошибках
- Отсутствие влияния на стабильность Life

## Будущие улучшения

### Опционально (низкий приоритет)
- Компрессия хранимых данных
- Web-интерфейс для просмотра данных
- Интеграция с внешними инструментами анализа

### Зависит от требований
- Дополнительные метрики (если нужны raw счетчики)
- Оптимизация хранения
- Автоматизация экспорта

---

## Ссылки

- [ADR 001: Границы пассивного наблюдения](decisions/adr_001_passive_observation_boundaries.md)
- [Правила пассивного наблюдения](../concepts/behavior_observation_limits.md)
- [CHANGELOG: История изменений](../../CHANGELOG.md)