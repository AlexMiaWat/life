# Clarity Moments System (Экспериментальная)

## Обзор

**Clarity Moments** - экспериментальная система моментов ясности в проекте Life. Моменты ясности представляют собой особые состояния системы, которые возникают при высоких показателях стабильности и энергии, временно повышая восприимчивость к событиям.

## Архитектурные принципы

### Назначение
Система моментов ясности предназначена для моделирования состояний повышенной осознанности и восприимчивости, которые могут возникать у живых систем в благоприятных условиях.

### Ограничения
- **Экспериментальный статус:** Система находится в стадии экспериментов в `src/experimental/`
- **Условная активация:** Зависит от порогов стабильности и энергии
- **Временный эффект:** Действует ограниченное количество тиков
- **Минимальное воздействие:** Не влияет на основные механизмы принятия решений

## Структура компонента

### Основные классы

#### ClarityMoments
Главный класс системы, отвечающий за:
- Детекцию условий активации моментов ясности
- Управление состоянием clarity
- Создание событий clarity_moment
- Логирование активности

### Ключевые константы

```python
CLARITY_STABILITY_THRESHOLD = 0.8    # Минимальная стабильность
CLARITY_ENERGY_THRESHOLD = 0.7       # Минимальная энергия
CLARITY_DURATION_TICKS = 50          # Длительность эффекта в тиках
CLARITY_CHECK_INTERVAL = 10           # Частота проверки условий
CLARITY_SIGNIFICANCE_BOOST = 1.5     # Коэффициент усиления значимости
```

## Механизм работы

### 1. Детекция условий
Система проверяет условия активации каждые `CLARITY_CHECK_INTERVAL` тиков:

```python
stability_ok = self_state.stability >= CLARITY_STABILITY_THRESHOLD
energy_ok = self_state.energy >= CLARITY_ENERGY_THRESHOLD
```

### 2. Активация момента ясности
При выполнении условий:
- Создается событие `clarity_moment`
- Устанавливается состояние `clarity_state = True`
- Запускается таймер длительности `clarity_duration = CLARITY_DURATION_TICKS`
- Применяется модификатор значимости `clarity_modifier = CLARITY_SIGNIFICANCE_BOOST`

### 3. Эффект усиления
Во время активного момента ясности:
- Значимость событий умножается на `CLARITY_SIGNIFICANCE_BOOST`
- Повышается восприимчивость к внешним воздействиям
- Может влиять на процесс принятия решений

### 4. Деактивация
По истечении `CLARITY_DURATION_TICKS`:
- Сбрасывается `clarity_state = False`
- Сбрасывается `clarity_modifier = 1.0`
- Фиксируется окончание момента ясности

## API интерфейс

### Основные методы

#### check_clarity_conditions(self_state)
Проверяет условия для активации момента ясности.

**Параметры:**
- `self_state`: Текущее состояние системы

**Возвращает:**
- `Dict` с данными события clarity_moment при выполнении условий
- `None` при невыполнении условий или активном clarity

#### activate_clarity_moment(self_state)
Активирует момент ясности.

**Параметры:**
- `self_state`: Состояние системы для модификации

#### update_clarity_state(self_state)
Обновляет состояние clarity каждый тик.

**Параметры:**
- `self_state`: Текущее состояние системы

**Возвращает:**
- `bool`: True если clarity активен, False если истек

#### deactivate_clarity_moment(self_state)
Принудительно деактивирует момент ясности.

#### get_clarity_modifier(self_state)
Возвращает текущий модификатор clarity.

**Возвращает:**
- `float`: CLARITY_SIGNIFICANCE_BOOST при активном clarity, 1.0 при неактивном

#### is_clarity_active(self_state)
Проверяет активность момента ясности.

**Возвращает:**
- `bool`: Статус активности clarity

#### get_clarity_status(self_state)
Возвращает полную информацию о состоянии clarity.

**Возвращает:**
- `Dict` с ключами: active, duration_remaining, total_events, modifier

## Интеграция с системой

### Runtime Loop
ClarityMoments интегрируется в основной цикл выполнения:

```python
# Проверка условий активации
clarity_event = clarity.check_clarity_conditions(self_state)
if clarity_event:
    # Обработка события clarity_moment
    pass

# Обновление состояния clarity
clarity.update_clarity_state(self_state)

# Применение модификатора в MeaningEngine
modifier = clarity.get_clarity_modifier(self_state)
significance *= modifier
```

### MeaningEngine
Система clarity влияет на оценку значимости событий:

```python
# Получение модификатора clarity
clarity_modifier = clarity.get_clarity_modifier(self_state)

# Применение к расчету значимости
base_significance = calculate_base_significance(event)
final_significance = base_significance * clarity_modifier
```

## Структура события clarity_moment

```python
{
    "type": "clarity_moment",
    "data": {
        "clarity_id": 1,           # Уникальный ID момента ясности
        "trigger_conditions": {    # Условия активации
            "stability": 0.85,
            "energy": 0.78,
            "tick": 150
        },
        "duration_ticks": 50,      # Планируемая длительность
        "significance_boost": 1.5  # Коэффициент усиления
    },
    "timestamp": 1234567890.123,
    "subjective_timestamp": 150.5
}
```

## Мониторинг и отладка

### Метрики состояния
- `clarity_state`: Флаг активности момента ясности
- `clarity_duration`: Оставшаяся длительность в тиках
- `clarity_modifier`: Текущий коэффициент усиления
- `_clarity_events_count`: Общее количество активированных моментов

### Логирование
Система использует структурированное логирование для отслеживания:
- Активации моментов ясности
- Деактивации моментов ясности
- Ошибок в работе системы

## Производительность

### Характеристики
- **Частота проверок:** Каждые 10 тиков (CLARITY_CHECK_INTERVAL)
- **Длительность эффекта:** 50 тиков (CLARITY_DURATION_TICKS)
- **Нагрузка:** Минимальная, только проверки условий и счетчики
- **Память:** Небольшой overhead на атрибуты состояния

### Оптимизации
- Проверка условий только через интервалы
- Легковесные операции сравнения
- Отсутствие сложных вычислений

## Тестирование

### Покрытие тестами
- **Smoke тесты:** Базовая функциональность и обработка ошибок
- **Static тесты:** Валидация констант и структур
- **Integration тесты:** Взаимодействие с SelfState и Runtime Loop

### Ключевые тестовые сценарии
1. **Базовая активация:** Проверка создания события при выполнении условий
2. **Управление состоянием:** Активация/деактивация и обновление счетчиков
3. **API интерфейс:** Все публичные методы возвращают корректные значения
4. **Обработка ошибок:** Graceful handling отсутствующих атрибутов
5. **Реалистичные сценарии:** Имитация полного цикла работы в runtime loop

## Будущие развития

### Потенциальные улучшения
- **Адаптивные пороги:** Динамическая настройка условий активации
- **Типы моментов ясности:** Разные виды clarity с различными эффектами
- **Накопительная механика:** Эффекты от частоты активации
- **Взаимодействие с памятью:** Влияние clarity на процессы запоминания

### Исследовательские вопросы
- **Поведенческий эффект:** Влияние на долгосрочное поведение системы
- **Оптимальные параметры:** Калибровка порогов и длительности
- **Интеграция с другими системами:** Взаимодействие с Learning и Adaptation

## Связанные документы

* [runtime-loop.md](./runtime-loop.md) — интеграция в основной цикл выполнения
* [meaning.md](./meaning.md) — влияние на оценку значимости событий
* [self-state.md](./self-state.md) — хранение состояния clarity
* [testing/clarity-moments.md](../testing/clarity-moments.md) — документация тестирования