# 04_MONITOR.md — Система наблюдения

## Назначение
Monitor — это инструмент для наблюдения за жизнью **Life** со стороны человека.
Он работает в режиме "только чтение" и не влияет на процессы внутри системы.

## Текущий статус
✅ **Реализован** (v1.1)
*   Файл: [`src/monitor/console.py`](../../src/monitor/console.py)
*   Поддерживает консольный вывод (Heartbeat) и логирование в файл.
*   **Обновления:** Улучшенное логирование в `generator_cli.py` с уровнями и флагами (--verbose)
*   **v1.1:** Отображение субъективного времени наряду с физическим временем

## Функции

### 1. Console Heartbeat
Выводит текущее состояние в консоль в реальном времени (одна строка, обновляется каждый такт).

Формат:
```text
• [000123] возраст: 60.5/61.2 сек. energy=98.0 int=1.00 stab=0.99
```
*   `•` — индикатор такта (мигает).
*   `[ticks]` — счетчик тактов.
*   `возраст: {age}/{subjective_time} сек.` — физический возраст и субъективное время (v1.1).
*   `energy`, `int`, `stab` — жизненные показатели.

### 2. File Logging
Сохраняет детальную историю каждого такта в JSONL файл.
*   Путь: `data/tick_log.jsonl`
*   Формат: JSON Lines (один объект JSON на строку).

Пример записи:
```json
{
  "timestamp": 1704987654.321,
  "ticks": 123,
  "age": 60.5,
  "subjective_time": 61.2,
  "energy": 98.0,
  "integrity": 1.0,
  "stability": 0.99,
  "active": true
}
```

## Принципы

1.  **Невмешательство:** Монитор никогда не пишет в `Self-State`.
2.  **Объективность:** Монитор показывает цифры, а не интерпретации ("энергия 10%", а не "я устал").
3.  **Отказоустойчивость:** Ошибка в мониторе не должна убивать Life.

## Использование

Монитор подключается к Runtime Loop как callback-функция:

```python
from monitor.console import console_monitor
from runtime.loop import run_loop

run_loop(..., monitor=console_monitor)
```

## Логирование с уровнями

### Централизованное логирование

Все компоненты мониторинга используют централизованную систему логирования из модуля `src/logging_config.py`. Это обеспечивает консистентность форматов и уровней логирования во всем проекте.

### Улучшенное логирование в Generator CLI

**Файл:** [`src/environment/generator_cli.py`](../../src/environment/generator_cli.py)

**Особенности:**
- Замена `print()` на структурированное логирование с уровнями
- Флаг `--verbose/-v` для включения подробного вывода
- Использование централизованной конфигурации логирования

### Уровни логирования

#### INFO уровень (по умолчанию в production)
- Стартовые сообщения: `logger.info("start: host={} port={} interval={}s")`
- Сообщения о завершении: `logger.info("Stopped")`
- Важная информация без засорения вывода

#### DEBUG уровень (с флагом --verbose или в dev-режиме)
- Детальная информация о каждом отправленном событии
- Сообщения от зависимостей (urllib3, requests)
- Диагностическая информация для отладки

#### WARNING уровень
- Сообщения об ошибках отправки событий
- Предупреждения о проблемах с подключением

### Настройка логирования

Логирование настраивается через централизованную функцию:

```python
from src.logging_config import setup_logging

# В verbose режиме
setup_logging(verbose=True)  # DEBUG уровень

# По умолчанию (production)
setup_logging(verbose=False)  # INFO уровень
```

### Модуль logging_config.py

```python
def setup_logging(verbose: bool = False) -> None:
    """Настройка логирования для приложения."""
    level = logging.DEBUG if verbose else logging.INFO
    logging.basicConfig(
        level=level,
        format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
        datefmt="%Y-%m-%d %H:%M:%S",
    )

    # Подавление verbose логов внешних библиотек в production
    if not verbose:
        logging.getLogger("requests").setLevel(logging.WARNING)
        logging.getLogger("urllib3").setLevel(logging.WARNING)
```

### Использование

```bash
# Обычный режим (только INFO и WARNING)
python -m environment.generator_cli --interval 5 --host localhost --port 8000

# Подробный режим (включая DEBUG)
python -m environment.generator_cli --verbose --interval 5 --host localhost --port 8000
```

### Преимущества централизованного логирования

1. **Управляемость:** Уровень детализации контролируется через флаги командной строки
2. **Производительность:** DEBUG логи не влияют на производительность в обычном режиме
3. **Чистота кода:** Убраны диагностические print-блоки, которые засоряли вывод
4. **Стандартизация:** Все компоненты используют унифицированную систему логирования
5. **Консистентность:** Единый формат и поведение логирования во всем проекте
