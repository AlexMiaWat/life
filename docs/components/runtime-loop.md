# 02_RUNTIME_LOOP.md — Главный цикл жизни

## Назначение
Runtime Loop — это сердце системы **Life**. Это бесконечный цикл, который обеспечивает непрерывное течение времени и оркестрирует все процессы жизнедеятельности.

Если Loop остановился — только слабость и бессилие.

## Текущий статус
✅ **Реализован** (v1.0)
*   Файл: [`src/runtime/loop.py`](../../src/runtime/loop.py)
*   Поддерживает реальное время (Wall Clock) и субъективное время (Subjective Time).
*   Интегрирован с Environment, Self-State, Meaning Engine, Memory, Intelligence, Planning.
*   Полная обработка событий через Meaning Engine с сохранением в память.
*   Модель субъективного времени на основе интенсивности событий и стабильности системы.

## Алгоритм такта (Tick)

Каждый такт (Tick) выполняется последовательно:

1.  **Time Update:** Обновление возраста (`age`), счетчика тактов (`ticks`) и субъективного времени (`subjective_time`).
2.  **Feedback:** Наблюдение последствий прошлых действий и сохранение Feedback в Memory.
3.  **Perception:** Получение событий из очереди `EventQueue`.
4.  **Interpretation:** Интерпретация событий через Meaning Engine и обновление `Self-State`.
5.  **Memory:** Сохранение значимых событий в эпизодическую память.
6.  **Planning:** Фиксация потенциальных последовательностей событий.
7.  **Intelligence:** Минимальная обработка информации из нейтральных источников.
8.  **Learning:** Периодический вызов Learning Engine (раз в `learning_interval` тиков).
9.  **Adaptation:** Периодический вызов Adaptation Manager (раз в `adaptation_interval` тиков).
10. **Memory Decay:** Периодическое затухание весов памяти (раз в `decay_interval` тиков, v2.0). Механизм забывания - веса записей уменьшаются со временем, более значимые записи забываются медленнее.
11. **Archive:** Периодическая архивация памяти (раз в `archive_interval` тиков, v2.0). Старые записи (старше 7 дней или с весом < 0.1) автоматически переносятся в архив.
12. **Metabolism:** Расчет "физиологических" изменений (усталость, потребление энергии, слабость).
12. **Monitoring:** Отправка состояния в Monitor.
13. **Snapshot:** Периодическое сохранение состояния на диск.
14. **Sleep:** Ожидание следующего такта для поддержания стабильного `tick_interval`.

## Ключевые параметры

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `tick_interval` | 1.0 сек | Длительность одного такта. |
| `snapshot_period` | 10 тактов | Как часто сохранять полное состояние на диск. |
| `learning_interval` | 75 тактов | Как часто вызывать Learning Engine (Этап 14). |
| `adaptation_interval` | 100 тактов | Как часто вызывать Adaptation Manager (Этап 15). |
| `decay_interval` | 10 тактов | Как часто применять затухание весов памяти (v2.0). |
| `archive_interval` | 50 тактов | Как часто выполнять архивацию памяти (v2.0). |

## Обработка сбоев

*   Любое исключение внутри цикла логируется, но не останавливает жизнь (если возможно).
*   Исключения наносят урон `integrity`.

### Критические исправления (task_1768908574)

#### Улучшение обработки ошибок

**Проблема:** Использование `pass` для обработки ошибок означало полное игнорирование ошибок без отслеживания их частоты.

**Решение:** Добавлены счетчики ошибок для отслеживания проблем:
- `learning_errors` - счетчик ошибок в Learning Engine
- `adaptation_errors` - счетчик ошибок в Adaptation Manager
- `max_errors_before_warning = 10` - порог для предупреждения о частых ошибках

При достижении порога выводится предупреждение о возможной деградации функциональности.

**Код:**
```python
learning_errors += 1
logger.error(f"Критическая ошибка в Learning (параметры): {e}", exc_info=True)
if learning_errors >= max_errors_before_warning:
    logger.warning(
        f"Обнаружено {learning_errors} ошибок в Learning. "
        "Возможна деградация функциональности."
    )
```

#### Устранение fallback с временными объектами

**Проблема:** В коде оставались места, где создавались временные объекты `SelfState()` для получения параметров по умолчанию.

**Решение:** Все fallback заменены на использование вспомогательных функций `_get_default_learning_params()` и `_get_default_adaptation_params()` без создания временных объектов.

**Изменения:**
- Убраны все `temp_state = SelfState()` из `runtime/loop.py`
- Используются только вспомогательные функции для получения параметров по умолчанию

#### Константы

Все константы Runtime Loop определены в модуле и имеют документацию:
- Интервалы вызова компонентов (`LEARNING_INTERVAL`, `ADAPTATION_INTERVAL`, и т.д.)
- Константы для работы с памятью (`MEMORY_DECAY_FACTOR`, `MEMORY_MIN_WEIGHT`, и т.д.)
- Константы для логики слабости (`WEAKNESS_THRESHOLD`, `WEAKNESS_PENALTY_COEFFICIENT`, и т.д.)
- Константы для обработки ошибок (`ERROR_INTEGRITY_PENALTY`, `MAX_ERRORS_BEFORE_WARNING`)
*   Если жизненные показатели (`energy`, `integrity`, `stability`) падают до 0, цикл прерывается через `self_state.set_active(False)`.
*   Для обновления vital параметров используется метод `apply_delta()`, который автоматически валидирует изменения через `__setattr__()` (см. [self-state.md](self-state.md)).

## Пример использования

```python
from runtime.loop import run_loop
from state.self_state import create_initial_state
from monitor.console import console_monitor

# Инициализация
state = create_initial_state()

# Запуск (блокирует поток)
run_loop(
    self_state=state,
    monitor=console_monitor,
    tick_interval=0.5
)
```

## Субъективное время

Runtime Loop вычисляет субъективное время на основе:
- Физического времени (`dt`)
- Интенсивности последнего события (`last_event_intensity`)
- Стабильности системы (`stability`)
- Параметров субъективного времени из `SelfState`

Субъективное время — это метрика, которая отражает восприятие времени системой:
- Высокая интенсивность → время течет быстрее
- Низкая стабильность → время течет медленнее

Подробнее см. [subjective-time.md](./subjective-time.md).

## Связанные документы

*   [self-state.md](self-state.md) — состояние системы
*   [subjective-time.md](./subjective-time.md) — модель субъективного времени
*   [memory.md](memory.md) — память
*   [meaning-engine.md](meaning-engine.md) — интерпретация событий
*   [intelligence.md](intelligence.md) — обработка информации
*   [planning.md](planning.md) — планирование
*   [learning.md](learning.md) — обучение
*   [adaptation.md](adaptation.md) — адаптация
