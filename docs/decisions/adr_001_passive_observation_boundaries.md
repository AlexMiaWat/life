# ADR 001: Определение границ активного наблюдения в системе Life

**Дата:** 2026-01-22
**Статус:** Принято
**Контекст:** После анализа архитектуры выявлено, что система Life использует активное наблюдение для корректной работы и понимания своего поведения

---

## Проблема

Изначально планировалось реализовать "пассивное наблюдение", но анализ показал фундаментальные противоречия:

1. **Необходимость активного мониторинга**: Система Life требует структурированного логирования для понимания своего поведения
2. **Интеграция в runtime loop**: Синхронное логирование ключевых этапов необходимо для корректной работы
3. **Архитектурная реальность**: Код активно использует StructuredLogger в каждом тике
4. **Отсутствие границ**: Не определено, что допустимо в активном наблюдении системы Life

## Требования к активному наблюдению

### 1. Необходимый мониторинг
- **Разрешено**: Активный сбор данных в runtime loop для понимания поведения
- **Разрешено**: Синхронное логирование ключевых этапов работы системы
- **Разрешено**: Структурированное логирование для debugging и анализа

### 2. Баланс производительности
- **Разрешено**: Сбор структурированных данных с минимальным влиянием на производительность
- **Разрешено**: Кэширование и оптимизации для снижения overhead
- **Запрещено**: Блокирующие операции, влияющие на основной цикл

### 3. Четкие границы
- **Разрешено**: Логирование каждого тика, события, действия, решения
- **Разрешено**: Корреляция между этапами обработки
- **Запрещено**: Интерпретация данных в runtime (расчеты rate, frequency, прогнозы)

## Решение

### Архитектурные границы

#### Основные компоненты активного наблюдения:

1. **StructuredLogger** - структурированное логирование
   - Синхронное логирование ключевых этапов
   - JSONL формат для анализа
   - Корреляция между событиями, смыслом, решениями, действиями
   - Многопоточная безопасность

2. **Runtime Integration** - интеграция в основной цикл
   - Логирование каждого тика
   - Логирование каждого события и действия
   - Минимальный overhead на производительность

3. **External Analysis** - внешний анализ данных
   - Анализ логов внешними инструментами
   - Построение метрик и трендов
   - Отчеты о поведении системы

#### Границы допустимого:

1. **Сырые данные**: логирование фактов без интерпретации
2. **Корреляция**: связь между этапами обработки
3. **Производительность**: оптимизации для минимального влияния
4. **Без обратной связи**: данные только для анализа, не влияют на поведение

### Интеграция в runtime

#### Текущая реализация:
```python
# runtime/loop.py:242
structured_logger=None  # StructuredLogger для активного логирования ключевых этапов
```

#### Решение:
- StructuredLogger интегрирован в runtime loop
- Логирование каждого тика, события, действия
- Оптимизации для многопоточной работы
- Graceful degradation при ошибках

### Тестирование границ

#### Архитектурные тесты:
- Тест на отсутствие влияния на ticks/sec
- Тест на отсутствие доступа к runtime объектам
- Тест на только raw данные (без расчетов)

#### Функциональные тесты:
- Тест экспорта данных
- Тест асинхронного сбора
- Тест graceful degradation при ошибках

## Последствия

### Положительные:
- Четкие архитектурные границы активного наблюдения
- Необходимый мониторинг для понимания поведения системы
- Структурированные данные для анализа и debugging
- Корректная интеграция в runtime loop

### Отрицательные:
- Некоторое влияние на производительность (минимальное)
- Сложность поддержки многопоточной безопасности
- Необходимость оптимизаций для снижения overhead

### Риски:
- Перегрузка системы логированием
- Проблемы с многопоточностью
- Сложность анализа больших объемов данных

## Альтернативы

### Альтернатива 1: Полное удаление observability
- **Плюсы**: Максимальная производительность, отсутствие технического долга
- **Минусы**: Невозможность анализа поведения, debugging, понимания системы

### Альтернатива 2: Пассивное наблюдение
- **Плюсы**: Минимальное влияние на производительность
- **Минусы**: Недостаточно данных для понимания сложной системы как Life

### Альтернатива 3: Статус-кво (активное наблюдение)
- **Плюсы**: Богатые данные, возможность анализа поведения
- **Минусы**: Архитектурные противоречия, неясные границы

## Решение: Принята альтернатива "Активное наблюдение с четкими границами"

Выбрано активное наблюдение как необходимое для функционирования сложной системы Life. Определены четкие границы допустимого и запрещенного.

---

## Реализация

### Фаза 1: Архитектурная чистка (Критично)
1. Удалить мертвый код (PassiveDataSink, AsyncDataSink)
2. Исправить многопоточность StructuredLogger
3. Оптимизировать производительность логирования
4. Убрать противоречия в документации

### Фаза 2: Документация (Важно)
1. Обновить `docs/components/observability.md`
2. Исправить `docs/concepts/behavior_observation_limits.md`
3. Синхронизировать код и документацию

### Фаза 3: Оптимизация (Желательно)
1. Добавить graceful error handling
2. Оптимизировать многопоточную работу
3. Добавить мониторинг производительности

---

*Этот ADR определяет границы активного наблюдения в системе Life и обеспечивает корректную работу observability.*