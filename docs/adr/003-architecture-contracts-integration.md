# ADR 003: Интеграция архитектурных контрактов в runtime

## Статус

✅ **Принято и реализовано**

## Дата

2026-01-22

## Контекст

Проект Life имеет развитую систему архитектурных контрактов (EventGeneratorContract, IntensityAdapterContract, SelfStateContract), но эти контракты не использовались в runtime для валидации компонентов. Это приводило к тому, что нарушения архитектурных гарантий (диапазоны значений, структурная целостность) могли оставаться незамеченными до момента сбоя.

### Проблема

1. **Контракты существуют как декорация** - определены диапазоны значений и интерфейсы, но не проверяются
2. **Отсутствие раннего обнаружения проблем** - нарушения контрактов выявляются только при сбоях
3. **Ложная безопасность** - разработчики полагаются на контракты, которые не работают
4. **Отсутствие мониторинга** - нет данных о соблюдении архитектурных гарантий

## Решение

Интегрировать валидацию архитектурных контрактов в runtime loop с подробным логированием и отчетностью.

### Архитектурные принципы

1. **Runtime валидация** - контракты проверяются при запуске системы
2. **Graceful degradation** - нарушения контрактов логируются, но не останавливают систему
3. **Подробная диагностика** - детальные сообщения об обнаруженных нарушениях
4. **Мониторинг соблюдения** - статистика валидаций для анализа архитектурного здоровья

### Реализация

#### 1. Интеграция ContractManager в runtime loop

```python
from src.contracts.contract_manager import contract_manager

def _validate_architecture_contracts():
    """Проверяет соблюдение архитектурных контрактов системы."""
    logger.info("Validating architecture contracts...")

    violations_found = False

    try:
        # Валидация SelfState
        self_state_violations = contract_manager.validate_component(self_state, "SelfState")
        if self_state_violations:
            violations_found = True
            logger.error(f"SelfState contract violations found: {len(self_state_violations)}")

        # Валидация EventGenerator
        eg_violations = contract_manager.validate_component(event_generator, "EventGenerator")
        if eg_violations:
            violations_found = True
            logger.error(f"EventGenerator contract violations found: {len(eg_violations)}")

    except Exception as e:
        logger.error(f"Error during contract validation: {e}")
        violations_found = True

    if not violations_found:
        logger.info("All architecture contracts validated successfully")
    else:
        logger.warning("Architecture contract violations detected - system may be unstable")

    return violations_found
```

#### 2. Вызов валидации при запуске

```python
# В runtime loop после инициализации компонентов
contracts_violated = _validate_architecture_contracts()
```

#### 3. Структура контрактов

##### EventGeneratorContract
- **Диапазоны значений:**
  - `base_intensity`: [0.0, 1.0]
  - `adapted_intensity`: [0.0, 3.0]
  - `pattern_modifier`: [0.1, 2.0]
  - `dependency_modifier`: [0.5, 2.0]
- **Структурные гарантии:** наличие всех субкомпонентов и их интерфейсов

##### IntensityAdapterContract
- **Диапазоны модификаторов:**
  - `state_modifier`: [0.1, 3.0]
  - `pattern_modifier`: [0.1, 2.0]
  - `smoothing_modifier`: [0.1, 3.0]
  - `adapted_intensity`: [0.0, 3.0]
- **Гарантии истории:** ограничение размера истории модификаторов

##### SelfStateContract
- **Структурная целостность:** наличие всех компонентов состояния
- **Гарантии типов:** правильные типы для всех полей

## Последствия

### Положительные

1. **Раннее обнаружение проблем** - нарушения контрактов выявляются при запуске
2. **Улучшенная стабильность** - превентивное выявление потенциальных проблем
3. **Документированная архитектура** - контракты служат живой документацией
4. **Мониторинг здоровья** - статистика соблюдения архитектурных гарантий

### Отрицательные

1. **Нагрузка на запуск** - дополнительное время на валидацию
2. **Ложные срабатывания** - некоторые "нарушения" могут быть допустимыми в runtime
3. **Сложность отладки** - нужно анализировать логи валидации

### Нейтральные

1. **Подробное логирование** - детальная информация о состоянии компонентов
2. **Гибкость конфигурации** - контракты можно отключать для отладки

## Альтернативы

### Альтернатива 1: Валидация только в тестах
- **Плюсы:** Не влияет на production performance
- **Минусы:** Проблемы выявляются только при тестировании

### Альтернатива 2: Периодическая валидация
- **Плюсы:** Постоянный мониторинг без нагрузки на запуск
- **Минусы:** Сложнее реализовать, periodic overhead

### Альтернатива 3: Компиляционная валидация
- **Плюсы:** Раннее обнаружение, нет runtime overhead
- **Минусы:** Сложно реализовать для динамических структур

Выбрана runtime валидация при запуске как оптимальный баланс между безопасностью и производительностью.

## Реализация

### Этап 1: ✅ Интеграция ContractManager (выполнено)
- Добавлен импорт contract_manager в runtime loop
- Реализована функция _validate_architecture_contracts()

### Этап 2: ✅ Runtime валидация (выполнено)
- Валидация выполняется после инициализации всех компонентов
- Подробное логирование нарушений контрактов

### Этап 3: ✅ Обработка ошибок (выполнено)
- Graceful handling ошибок валидации
- Система продолжает работу даже при нарушениях контрактов

### Этап 4: ✅ Тестирование (выполнено)
- Валидация проходит без нарушений на текущем коде
- Система запускается и работает корректно

## Тестирование

### Функциональные тесты
- [x] Валидация проходит без нарушений на корректных данных
- [x] Нарушения контрактов корректно логируются
- [x] Система продолжает работу при нарушениях

### Регрессионные тесты
- [x] Производительность запуска не degraded значительно
- [x] Все существующие функции работают

### Интеграционные тесты
- [x] Runtime loop запускается с валидацией контрактов
- [x] Компоненты корректно инициализируются

## Связанные ADR

- **ADR 001**: Управление экспериментальными компонентами через Feature Flags
- **ADR 002**: Рефакторинг SelfState - переход на delegation pattern

## Примечания

Интеграция архитектурных контрактов в runtime обеспечивает активный мониторинг соблюдения архитектурных гарантий. Это позволяет выявлять проблемы на ранней стадии и поддерживать высокое качество архитектуры системы.