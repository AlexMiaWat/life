# ADR 010: Subjective Time

## Статус
✅ Принято

## Дата
2026-01-20

## Контекст

Проект Life нуждался в модели субъективного восприятия времени. Физическое время (age) не отражало внутреннее ощущение времени Life - разница между часами на стене и тем, как Life воспринимает течение времени.

### Проблема
- **Отсутствие ощущения "продолжительности Я"**: только счетчик физического времени
- **Нет корректировки на интенсивность**: события влияют на восприятие времени
- **Отсутствие анализа паттернов**: невозможно понять, как Life ощущает время
- **Недостаточная глубина модели**: простое физическое время не отражает психологию

### Требования
- **Детерминированное отображение**: (dt, state, signals) → subjective increment
- **Монотонность**: subjective time только растет
- **Метрика, не контроль**: измерение, не управление поведением
- **Связь с состоянием**: энергия, стабильность, интенсивность событий

## Решение

### Архитектура Subjective Time

#### 1. Отдельный модуль `src/runtime/subjective_time.py`

```python
def compute_subjective_time_rate(
    *,
    base_rate: float,
    intensity: float,
    stability: float,
    energy: float,
    intensity_coeff: float,
    stability_coeff: float,
    energy_coeff: float,
    rate_min: float,
    rate_max: float,
) -> float:
    """Вычисление коэффициента скорости субъективного времени."""
    # intensity: выше → быстрее время (положительный эффект)
    # stability: ниже → медленнее время (отрицательный эффект)
    # energy: выше → быстрее время (положительный эффект)
```

#### 2. Интеграция в SelfState

```python
@dataclass
class SelfState:
    # Основные поля времени
    age: float = 0.0                    # Физическое время (секунды)
    subjective_time: float = 0.0        # Субъективное время (секунды)

    # Параметры модели
    subjective_time_base_rate: float = 1.0
    subjective_time_rate_min: float = 0.1
    subjective_time_rate_max: float = 3.0
    subjective_time_intensity_coeff: float = 1.0
    subjective_time_stability_coeff: float = 0.5
    subjective_time_energy_coeff: float = 0.5
    subjective_time_intensity_smoothing: float = 0.3

    # История и аналитика
    time_ratio_history: list = field(default_factory=list)
    last_event_intensity: float = 0.0
```

#### 3. Алиасы для удобства

```python
@property
def subjective_age(self) -> float:
    """Alias for subjective_time - accumulated subjective time in seconds."""
    return self.subjective_time

@subjective_age.setter
def subjective_age(self, value: float) -> None:
    """Set subjective_time via subjective_age alias."""

@property
def physical_age(self) -> float:
    """Alias for age - physical time in seconds."""
    return self.age
```

### Математическая модель

#### Формула скорости субъективного времени

```
rate = base_rate + intensity_coeff * intensity + stability_term + energy_term

где:
- intensity_term = intensity_coeff * intensity  (положительный вклад)
- stability_term = stability_coeff * (stability - 1.0)  (отрицательный при stability < 1)
- energy_term = energy_coeff * (energy / 100.0)  (положительный вклад)
- rate ∈ [rate_min, rate_max]
```

#### Вычисление приращения

```
subjective_dt = physical_dt * rate
```

### Интеграция в компоненты

#### 1. Runtime Loop
```python
# Каждый тик обновляется субъективное время
# (Временно отключено для производительности, используется простое приращение)
self_state.apply_delta({"subjective_time": dt})
```

#### 2. MeaningEngine
```python
# Использование соотношения physical/subjective для оценки значимости
time_ratio = (
    self_state.subjective_time / self_state.age
    if self_state.age > 0
    else 1.0
)
```

#### 3. Decision Engine
```python
# Анализ восприятия времени для принятия решений
time_ratio = (
    self_state.subjective_time / self_state.age if self_state.age > 0 else 1.0
)
time_perception = (
    "accelerated" if time_ratio > 1.1 else
    "normal" if time_ratio > 0.9 else
    "slowed"
)
```

#### 4. Memory System
```python
# Привязка событий к субъективному времени
MemoryEntry(
    subjective_timestamp=self_state.subjective_time,
    # ... другие поля
)
```

### Параметры модели

#### Настраиваемые коэффициенты
- **base_rate**: Базовая скорость (обычно 1.0)
- **intensity_coeff**: Влияние интенсивности событий
- **stability_coeff**: Влияние стабильности (отрицательное)
- **energy_coeff**: Влияние энергии
- **rate_min/rate_max**: Ограничения скорости

#### Сглаживание интенсивности
```python
# Экспоненциальное сглаживание для стабильности
alpha = self_state.subjective_time_intensity_smoothing
self_state.last_event_intensity = (
    alpha * current_max_intensity
    + (1 - alpha) * self_state.last_event_intensity
)
```

## Обоснование

### За выбранное решение

#### ✅ Детерминированность и предсказуемость
- Четкая математическая формула без случайностей
- Все входы явные, результаты воспроизводимы
- Легко тестировать и отлаживать

#### ✅ Физическая интерпретируемость
- **Интенсивность ↑ → время течет быстрее**: стресс ускоряет восприятие
- **Стабильность ↓ → время течет медленнее**: нестабильность замедляет восприятие
- **Энергия ↑ → время течет быстрее**: бодрость ускоряет восприятие

#### ✅ Метрика, не управление
- Не влияет на поведение (только измеряет восприятие)
- Можно использовать для анализа паттернов
- Не создает петель обратной связи

#### ✅ Интеграция без ломки архитектуры
- Добавляется параллельно физическому времени
- Совместимо с существующими компонентами
- Не требует изменений в основных циклах

### Против альтернатив

#### Альтернатива 1: Только физическое время
- **Против**: Не отражает внутреннее состояние Life
- **Против**: Отсутствие анализа восприятия времени
- **Против**: Недостаточная психологическая глубина

#### Альтернатива 2: Случайные вариации времени
- **Против**: Непредсказуемость усложняет тестирование
- **Против**: Не соответствует deterministic архитектуре
- **Против**: Трудно анализировать и отлаживать

#### Альтернатива 3: Управление поведением через время
- **Против**: Создает петли обратной связи
- **Против**: Увеличивает сложность системы
- **Против**: Нарушает принцип метрики, не контроля

## Последствия

### Положительные

#### ✅ Богатая модель восприятия
- **Анализ паттернов**: соотношение physical/subjective time
- **Психологическая глубина**: отражает "ощущение времени" Life
- **Мониторинг состояния**: косвенная оценка стресса/усталости

#### ✅ Расширенные возможности анализа
- **В привязке памяти**: события индексируются по субъективному времени
- **В принятии решений**: учет восприятия времени
- **В meaning engine**: влияние на оценку значимости

#### ✅ Масштабируемость
- **Настраиваемые параметры**: адаптация под разные сценарии
- **Ограничения скорости**: защита от экстремальных значений
- **Сглаживание**: стабильность показаний

#### ✅ Совместимость
- **Параллельное существование**: physical + subjective time
- **Опциональность**: можно отключить для производительности
- **Backward compatibility**: не ломает существующий код

### Отрицательные

#### ⚠️ Сложность отладки
- Два параллельных счетчика времени
- Необходимость учета обоих в логах и мониторинге
- Увеличение объема данных для анализа

#### ⚠️ Производительность
- Дополнительные вычисления на каждом тике
- (Временно отключено для оптимизации)
- Может влиять на общую производительность

#### ⚠️ Интерпретация результатов
- Сложно объяснить не-техническим специалистам
- Требует понимания психологических аспектов
- Может привести к неправильным выводам

### Риски

#### Риск концептуального дрейфа
- **Описание**: Субъективное время может начать использоваться для управления
- **Митигация**: четкое документирование как "метрика только"
- **Вероятность**: Средняя

#### Риск производительности
- **Описание**: Вычисления на каждом тике могут замедлить систему
- **Митигация**: кэширование, оптимизации, возможность отключения
- **Вероятность**: Низкая (временно отключено)

#### Риск неправильной интерпретации
- **Описание**: Неправильное понимание формулы или значений
- **Митигация**: подробная документация, примеры, тесты
- **Вероятность**: Низкая

## Связанные документы

- [docs/concepts/core-concepts.md](../concepts/core-concepts.md) — базовые концепции
- [src/runtime/subjective_time.py](../../src/runtime/subjective_time.py) — реализация модели
- [src/state/self_state.py](../../src/state/self_state.py) — интеграция в состояние
- [src/meaning/engine.py](../../src/meaning/engine.py) — использование в meaning
- [src/decision/decision.py](../../src/decision/decision.py) — использование в decision
- [src/memory/memory.py](../../src/memory/memory.py) — привязка в памяти
- [src/test/test_subjective_time.py](../../src/test/test_subjective_time.py) — тесты