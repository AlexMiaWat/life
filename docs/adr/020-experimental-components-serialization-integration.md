# ADR 020: Интеграция экспериментальных компонентов в систему сериализации

**Дата:** 2026-01-22
**Статус:** Accepted
**Ответственный:** AI Assistant
**Ревьюеры:** Architecture Team

## Контекст

### Проблема
Экспериментальные компоненты ParallelConsciousnessEngine и ClarityMomentsTracker не имеют контрактов сериализации и не интегрированы в систему сериализации SelfState. Это приводит к:
- Невозможности сохранить состояние экспериментальных компонентов
- Нарушению архитектурной целостности системы
- Потере данных при перезапуске системы
- Отсутствию мониторинга и отладки состояния компонентов

### Текущая ситуация
- ParallelConsciousnessEngine и ClarityMomentsTracker существуют как изолированные компоненты
- SelfState имеет композитную систему сериализации с контрактами
- Отсутствуют контракты сериализации для экспериментальных компонентов
- ClarityMomentsTracker использует неоптимальный dependency injection через функции-провайдеры

### Требования
1. Реализовать контракты сериализации для ParallelConsciousnessEngine и ClarityMomentsTracker
2. Интегрировать компоненты в SelfState сериализацию
3. Исправить dependency injection для ClarityMomentsTracker
4. Обеспечить thread-safety сериализации
5. Сохранить обратную совместимость

### Ограничения
- Система должна оставаться thread-safe
- Нельзя ломать существующие интерфейсы без миграции
- Сериализация должна быть эффективной по ресурсам
- Компоненты должны оставаться опциональными

## Рассмотренные варианты

### Вариант 1: Полная интеграция с контрактами
**Описание:** Реализовать полноценные контракты сериализации ThreadSafeSerializable для обоих компонентов, интегрировать в SelfState как обязательные поля.

**Плюсы:**
- Полная архитектурная целостность
- Гарантированная сериализация всех компонентов
- Лучшая наблюдаемость и отладка

**Минусы:**
- Нарушение принципа опциональности экспериментальных компонентов
- Увеличение сложности SelfState
- Риск поломки при изменении экспериментальных компонентов

**Оценка:** Низкий (слишком инвазивно для экспериментальных компонентов)

### Вариант 2: Опциональная интеграция
**Описание:** Добавить опциональные поля в SelfState, реализовать базовые контракты Serializable с возможностью расширения до ThreadSafeSerializable.

**Плюсы:**
- Сохраняет опциональность компонентов
- Позволяет поэтапную интеграцию
- Минимальное воздействие на существующую архитектуру

**Минусы:**
- Сложнее управлять консистентностью
- Возможны проблемы с версионированием

**Оценка:** Высокий (баланс между функциональностью и безопасностью)

### Вариант 3: Отдельная система сериализации
**Описание:** Создать отдельную систему сериализации для экспериментальных компонентов, независимую от SelfState.

**Плюсы:**
- Полная изоляция экспериментальных компонентов
- Не влияет на основную систему сериализации

**Минусы:**
- Дублирование логики сериализации
- Сложнее обеспечить консистентность состояния
- Нарушает принцип единой точки сериализации

**Оценка:** Низкий (создает архитектурные проблемы)

## Решение

### Выбранный вариант
Вариант 2: Опциональная интеграция с базовыми контрактами сериализации.

### Детали реализации
1. **Контракты сериализации:**
   - Реализовать базовые контракты Serializable для ParallelConsciousnessEngine
   - Реализовать базовые контракты Serializable для ClarityMomentsTracker
   - Обеспечить возможность расширения до ThreadSafeSerializable в будущем

2. **Интеграция в SelfState:**
   - Добавить опциональные поля parallel_consciousness_engine и clarity_moments_tracker
   - Интегрировать в композитную сериализацию _serialize_components_isolated
   - Обновить метаданные сериализации

3. **Dependency injection:**
   - Изменить ClarityMomentsTracker для использования dependency injection через SelfState
   - Сохранить обратную совместимость через fallback
   - Улучшить архитектуру передачи зависимостей

### Архитектурные изменения
```
SelfState
├── identity (обязательный)
├── physical (обязательный)
├── time (обязательный)
├── memory (обязательный)
├── cognitive (обязательный)
├── events (обязательный)
├── memory_hierarchy (опциональный)
├── parallel_consciousness_engine (опциональный) [НОВЫЙ]
└── clarity_moments_tracker (опциональный) [НОВЫЙ]
```

## Последствия

### Положительные
- Восстановлена архитектурная целостность экспериментальных компонентов
- Возможность сериализации и восстановления состояния
- Улучшенная наблюдаемость системы
- Исправлена архитектура dependency injection

### Отрицательные
- Незначительное увеличение сложности SelfState
- Дополнительные проверки на None для опциональных компонентов

### Риски
- **Риск регрессии сериализации:** Может нарушить существующую сериализацию SelfState. Митigation: тщательное тестирование.
- **Проблемы с версионированием:** Изменения в экспериментальных компонентах могут сломать десериализацию. Митigation: семантическое версионирование.
- **Утечки памяти:** Опциональные компоненты могут держать ссылки. Mitigation: слабые ссылки и очистка при shutdown.

### Миграция
1. Развернуть новые версии компонентов с контрактами сериализации
2. Обновить SelfState с опциональными полями
3. Провести тестирование сериализации/десериализации
4. Обновить документацию и примеры использования

## Связанные ADR

- [ADR 016](016-selfstate-composition-refactoring.md) - Композитная архитектура SelfState
- [ADR 018](018-architectural-contracts-system.md) - Система архитектурных контрактов
- [ADR 019](019-serialization-contracts.md) - Контракты сериализации

## Приложения

### Код
```python
# Пример использования новых контрактов
parallel_engine = ParallelConsciousnessEngine()
clarity_tracker = ClarityMomentsTracker(self_state=self_state)

# Сериализация
engine_data = parallel_engine.to_dict()
tracker_data = clarity_tracker.to_dict()
metadata = parallel_engine.get_serialization_metadata()
```

### Метрики
- **Время сериализации:** < 100ms для каждого компонента
- **Размер сериализованных данных:** < 10KB для типичного состояния
- **Thread-safety:** Полная поддержка конкурентного доступа
- **Обратная совместимость:** 100% сохранение существующих интерфейсов</contents>
</xai:function_call">Создать ADR для экспериментальных компонентов