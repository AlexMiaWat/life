# ADR 007: State snapshot for API

## Статус
✅ Принято

## Дата
2026-01-20

## Контекст

Система Life имеет REST API для внешнего доступа к состоянию. API должен предоставлять:

- **Консистентное состояние**: данные не должны меняться во время чтения
- **Безопасность**: исключение внутренних полей и чувствительных данных
- **Производительность**: возможность ограничения размера больших структур
- **Thread-safety**: безопасный доступ в многопоточной среде

Проблема: как обеспечить безопасный и эффективный доступ к состоянию системы через публичное API?

## Решение

### Архитектура сериализации состояния

#### Два уровня сериализации

1. **Snapshot сериализация** (для персистентности):
   - Полная сериализация SelfState для сохранения/восстановления
   - Исключает только несериализуемые объекты (_api_lock, archive_memory)
   - Исключает transient поля (activated_memory, last_pattern)
   - Оптимизирована для производительности (исключает большие history)

2. **API сериализация** (для публичного доступа):
   - Безопасная версия состояния для внешних клиентов
   - Дополнительная фильтрация внутренних и больших полей
   - Query-параметры для динамического ограничения размера

#### Thread-safe доступ

SelfState использует `threading.RLock` для обеспечения консистентности:

```python
_api_lock: threading.RLock = field(default_factory=threading.RLock, init=False, repr=False)
```

Все операции чтения состояния для API выполняются под блокировкой:

```python
with self._api_lock:
    # Чтение состояния для API
    safe_status = self_state.get_safe_status_dict(limits=limits)
```

### Фильтрация полей для публичного API

#### Автоматически исключаемые поля

- **Внутренние поля**: начинающиеся с `_` (приватные атрибуты)
- **Несериализуемые объекты**: `_api_lock`, `archive_memory`, `memory` (по умолчанию)
- **Transient поля**: `activated_memory`, `last_pattern`

#### Опциональные поля (включаются по запросу)

- **Memory**: записи памяти системы (большая структура)
- **Истории**: `energy_history`, `stability_history`, `adaptation_history` (массивы данных)

### API endpoint /status

#### Базовый функционал

```http
GET /status
```

Возвращает безопасное состояние системы с фильтрацией по умолчанию.

#### Query-параметры для ограничения размера

```http
GET /status?memory_limit=50&events_limit=100&energy_history_limit=200
```

- `memory_limit`: количество записей памяти (None = не включать)
- `events_limit`: количество последних событий
- `energy_history_limit`: количество значений истории энергии
- `stability_history_limit`: количество значений истории стабильности
- `adaptation_history_limit`: количество значений истории адаптации

#### Чтение из snapshots

API читает состояние из файлов snapshots, а не из live объекта:

```python
try:
    self_state = SelfState().load_latest_snapshot()
except FileNotFoundError:
    self_state = SelfState()
```

Это обеспечивает:
- **Консистентность**: данные не меняются во время чтения
- **Изоляцию**: API не влияет на работу runtime loop
- **Безопасность**: snapshot содержит только сериализуемые данные

### Метод get_safe_status_dict

```python
def get_safe_status_dict(
    self,
    include_optional: bool = True,
    limits: Optional[dict] = None,
) -> dict:
    """
    Получить безопасный словарь состояния для публичного API.

    Thread-safe: использует lock для обеспечения консистентности данных.
    """
```

#### Логика фильтрации

1. **Базовая фильтрация**: исключение внутренних и проблемных полей
2. **Обработка limits**: ограничение размера больших структур
3. **Memory handling**: опциональное включение с лимитом записей
4. **Истории**: ограничение размера массивов по query-параметрам

## Обоснование

### За выбранное решение

- **Безопасность**: автоматическая фильтрация внутренних и чувствительных данных
- **Производительность**: возможность ограничения больших структур через API
- **Консистентность**: чтение из snapshots предотвращает race conditions
- **Thread-safety**: RLock обеспечивает безопасный доступ в многопоточной среде
- **Гибкость**: query-параметры позволяют клиентам запрашивать нужные данные

### Против альтернатив

#### Альтернатива 1: Live чтение состояния
- **Против**: race conditions при одновременном доступе
- **Против**: данные могут меняться во время сериализации
- **Против**: блокирует runtime loop

#### Альтернатива 2: Полная сериализация всего состояния
- **Против**: утечка внутренних полей (_api_lock, приватные атрибуты)
- **Против**: огромные ответы API с полными историями
- **Против**: снижение производительности API

#### Альтернатива 3: Кастомные DTO классы
- **Против**: дублирование структуры SelfState
- **Против**: сложность синхронизации при изменении SelfState
- **Против**: дополнительная логика маппинга

## Последствия

### Положительные

- ✅ **Безопасность**: автоматическая фильтрация внутренних данных
- ✅ **Производительность**: контролируемый размер ответов API
- ✅ **Консистентность**: чтение из snapshots предотвращает race conditions
- ✅ **Thread-safety**: RLock обеспечивает безопасный многопоточный доступ
- ✅ **Гибкость**: query-параметры для настройки уровня детализации

### Отрицательные

- ⚠️ **Задержки**: чтение из файловой системы медленнее live доступа
- ⚠️ **Сложность**: два уровня сериализации (snapshot + API)
- ⚠️ **Синхронизация**: snapshot может быть устаревшим на момент чтения

### Риски

- **Устаревшие данные**: API возвращает состояние из последнего snapshot
  - **Митигация**: snapshots создаются регулярно (каждые 10 тиков по умолчанию)
- **Производительность**: десериализация больших snapshots
  - **Митигация**: кэширование или оптимизация формата сериализации
- **Безопасность**: недостаточная фильтрация полей
  - **Митигация**: автоматические тесты проверяют исключение внутренних полей

## Связанные документы

- [docs/components/self-state.md](../components/self-state.md) — документация SelfState
- [src/main_server_api.py](../../src/main_server_api.py) — реализация API сервера
- [src/state/self_state.py](../../src/state/self_state.py) — методы сериализации
- [src/test/test_api.py](../../src/test/test_api.py) — тесты API
