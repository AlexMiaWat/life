# ADR 004: Архитектура памяти

## Статус
✅ Принято

## Дата
2026-01-20

## Контекст
Необходимо реализовать систему памяти, которая:
- Хранит значимые события без активного влияния на поведение
- Поддерживает механизм забывания для реалистичности
- Позволяет активацию релевантных воспоминаний
- Масштабируется для долгосрочного хранения

## Решение
Реализовать трехуровневую архитектуру памяти:

### 1. Активная память (Active Memory)
- **Размер**: ограничена 50 записями
- **Хранение**: только наиболее значимые события
- **Механизм очистки**: удаление по весу (decay + eviction)
- **Назначение**: оперативная память для принятия решений

### 2. Архивная память (Archive Memory)
- **Размер**: неограниченный
- **Хранение**: события, перемещенные из активной памяти
- **Критерии перемещения**: возраст > 1 дня ИЛИ вес < 0.3 ИЛИ значимость < 0.5
- **Назначение**: долгосрочное хранение истории

### 3. Активация памяти (Memory Activation)
- **Алгоритм**: поиск по типу события + сортировка по значимости
- **Лимит**: топ-3 наиболее релевантных воспоминания
- **Назначение**: предоставление контекста для Decision

### Механизм забывания
```python
def decay_weights(self, decay_factor=0.99, min_weight=0.0):
    """Затухание весов со временем."""
    for entry in self.entries:
        age_days = (time.time() - entry.timestamp) / 86400
        entry.weight = max(min_weight, entry.weight * (decay_factor ** age_days))
```

## Обоснование

### За трехуровневую архитектуру
- **Реалистичность**: соответствует человеческой памяти (кратковременная + долгосрочная)
- **Производительность**: ограниченная активная память обеспечивает быстрый доступ
- **Масштабируемость**: архив позволяет хранить историю без degradation
- **Простота**: четкое разделение ответственности

### За механизм забывания
- **Научная ценность**: моделирует реальные когнитивные процессы
- **Ресурсы**: предотвращает бесконечный рост памяти
- **Релевантность**: старые воспоминания становятся менее доступными

### За лимит активации
- **Производительность**: ограничение предотвращает перегрузку Decision
- **Релевантность**: только наиболее значимые воспоминания влияют на решения
- **Простота**: детерминированный алгоритм без сложной логики

## Последствия

### Положительные
- Реалистичная модель памяти
- Контролируемое потребление ресурсов
- Быстрый доступ к релевантным данным
- Масштабируемость для долгосрочного хранения

### Отрицательные
- **Сложность**: три уровня требуют координации
- **Настройка**: параметры decay нужно калибровать
- **Производительность**: архивация требует вычислений

### Риски
- **Параметры**: неправильные настройки могут привести к потере данных
- **Сложность тестирования**: временные аспекты трудно тестировать
- **Производительность**: decay на больших объемах может быть медленным

## Альтернативы

### Рассмотренные варианты
1. **Простая очередь**: FIFO без весов — слишком примитивно
2. **База данных**: PostgreSQL/SQLite — избыточная сложность
3. **Векторная память**: embeddings для семантического поиска — нарушает архитектурные принципы

### Почему отклонены
- Очередь: не реалистично, нет забывания
- БД: добавляет внешние зависимости, усложняет развертывание
- Векторы: требует ML моделей, противоречит принципу "без интерпретации"

## Связанные документы
- [docs/components/memory.md](../components/memory.md) — документация компонента
- [docs/concepts/memory-concept.md](../concepts/memory-concept.md) — концепция памяти
