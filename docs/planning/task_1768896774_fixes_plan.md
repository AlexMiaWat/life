# План исправления проблем по задаче task_1768896774

> **Дата:** 2026-01-20
> **Основа:** Отчет скептика из `docs/reviews/skeptic_task_1768896774_20260120.md`
> **Статус:** ✅ Реализовано

---

## Резюме

Выполнены все критические и важные исправления, выявленные в отчете скептика. Реализованы:
- MCP команда `refresh_index()`
- Логирование ошибок
- Ограничение размера кэша с LRU eviction
- Оптимизация обновления индекса
- Валидация входных данных и путей
- Тесты для модуля
- Константы вместо магических чисел
- Защита от path traversal
- Ограничение размера файла

---

## Выполненные исправления

### ✅ Приоритет 1 (Критично)

#### 1. Добавлена MCP команда `refresh_index()`
**Файл:** `mcp_index.py`

**Реализация:**
- Добавлена функция `refresh_index()` как MCP tool
- Вызывает `engine.reindex()` для полной переиндексации
- Возвращает статистику обновления (количество файлов и токенов)

**Код:**
```python
@app.tool()
async def refresh_index() -> str:
    """Обновить индекс документации и TODO файлов."""
    try:
        engine = _get_index_engine()
        engine.reindex()
        cache_size = len(engine.content_cache)
        index_size = len(engine.inverted_index)
        return f"Индекс успешно обновлен.\n\n- Проиндексировано файлов: {cache_size}\n- Уникальных токенов в индексе: {index_size}"
    except Exception as e:
        return f"Ошибка при обновлении индекса: {str(e)}"
```

#### 2. Добавлено логирование ошибок
**Файл:** `mcp_index_engine.py`

**Реализация:**
- Импортирован модуль `logging`
- Создан logger для модуля
- Добавлено логирование во все критические места:
  - Ошибки чтения файлов (ERROR)
  - Пропущенные файлы (WARNING)
  - Информация об индексации (INFO)
  - Отладочная информация (DEBUG)

**Примеры:**
- `logger.error()` - ошибки чтения файлов
- `logger.warning()` - пропущенные файлы, валидация путей
- `logger.info()` - начало/конец индексации
- `logger.debug()` - отладочная информация

#### 3. Добавлено ограничение размера кэша (LRU eviction)
**Файл:** `mcp_index_engine.py`

**Реализация:**
- `content_cache` изменен с `dict` на `OrderedDict` для реализации LRU
- Добавлен параметр `cache_size_limit` в конструктор (по умолчанию 10000)
- Реализован метод `_evict_cache_if_needed()` для удаления старых записей
- Реализован метод `_remove_file_from_cache()` для полного удаления файла из всех индексов
- При добавлении файла в кэш проверяется лимит и удаляются старые записи

**Код:**
```python
def _evict_cache_if_needed(self):
    """Удаляет старые записи из кэша, если превышен лимит (LRU eviction)."""
    while len(self.content_cache) >= self.cache_size_limit:
        oldest_key = next(iter(self.content_cache))
        self._remove_file_from_cache(oldest_key)
```

### ✅ Приоритет 2 (Важно)

#### 4. Оптимизировано обновление индекса
**Файл:** `mcp_index_engine.py`

**Реализация:**
- Добавлен индекс `file_tokens: dict[str, set[str]]` для отслеживания токенов каждого файла
- Метод `_update_index_for_file()` оптимизирован:
  - Вместо двойного прохода по всему индексу используется сравнение множеств
  - Удаляются только токены, которых больше нет
  - Добавляются только новые токены
  - Сложность снижена с O(n*m) до O(k), где k - количество токенов в файле

**Код:**
```python
def _update_index_for_file(self, rel_path: str, content: str):
    new_tokens = self._tokenize_content(content)
    old_tokens = self.file_tokens.get(rel_path, set())
    tokens_to_remove = old_tokens - new_tokens
    tokens_to_add = new_tokens - old_tokens
    # Обновляем только измененные токены
```

#### 5. Добавлена валидация входных данных
**Файл:** `mcp_index_engine.py`

**Реализация:**
- Валидация типов путей (автоматическое преобразование строк в Path)
- Валидация существования директорий
- Валидация пустых запросов поиска
- Валидация лимитов (проверка на <= 0)
- Валидация параметров методов

**Примеры:**
- `index_directory()` - проверка существования и типа директории
- `search_in_directory()` - проверка запроса и лимита
- `update_file()` - проверка типа пути

#### 6. Добавлена валидация путей (защита от path traversal)
**Файл:** `mcp_index_engine.py`

**Реализация:**
- Добавлен метод `_validate_path()` для проверки, что файл находится внутри базовой директории
- Используется `resolve()` для нормализации путей
- Проверка выполняется перед доступом к файлу
- Логирование предупреждений при попытке доступа вне базовой директории

**Код:**
```python
def _validate_path(self, file_path: Path, base_dir: Path) -> bool:
    try:
        resolved_path = file_path.resolve()
        resolved_base = base_dir.resolve()
        return resolved_base in resolved_path.parents or resolved_path.parent == resolved_base
    except Exception:
        return False
```

#### 7. Добавлено ограничение размера файла
**Файл:** `mcp_index_engine.py`

**Реализация:**
- Добавлен параметр `max_file_size` в конструктор (по умолчанию 10MB)
- Проверка размера файла в методе `_load_content()` перед чтением
- Выбрасывается `ValueError` с понятным сообщением при превышении лимита
- Логирование предупреждений при пропуске больших файлов

**Код:**
```python
def _load_content(self, file_path: Path) -> str:
    file_size = file_path.stat().st_size
    if file_size > self.max_file_size:
        raise ValueError(f"Файл {file_path} слишком большой ({file_size} байт). Максимальный размер: {self.max_file_size} байт")
```

### ✅ Приоритет 3 (Желательно)

#### 8. Добавлены константы вместо магических чисел
**Файл:** `mcp_index_engine.py`

**Реализация:**
- `DEFAULT_SEARCH_LIMIT = 10` - лимит результатов поиска по умолчанию
- `DEFAULT_CACHE_SIZE_LIMIT = 10000` - лимит размера кэша
- `MAX_FILE_SIZE = 10 * 1024 * 1024` - максимальный размер файла (10MB)
- Константы используются в методах и конструкторе

#### 9. Созданы тесты для модуля
**Файл:** `src/test/test_mcp_index_engine.py`

**Реализация:**
- Создан полный набор unit-тестов для всех методов класса `IndexEngine`
- Тесты покрывают:
  - Инициализацию
  - Токенизацию
  - Операции с файлами
  - Индексацию
  - Кэширование
  - Поиск
  - Обновление файлов
  - Граничные случаи
- Используются фикстуры для создания временных директорий
- Тесты организованы по классам для удобства

**Покрытие:**
- ✅ `__init__()` - инициализация с разными типами путей
- ✅ `_tokenize_content()` - токенизация различных текстов
- ✅ `_load_content()` - загрузка файлов, обработка больших файлов
- ✅ `_get_base_dir()` - определение базовой директории
- ✅ `_get_relative_path()` - получение относительных путей
- ✅ `_validate_path()` - валидация путей
- ✅ `index_directory()` - индексация директорий
- ✅ `initialize()` - инициализация индекса
- ✅ `reindex()` - переиндексация
- ✅ `_update_index_for_file()` - обновление индекса
- ✅ `_get_content()` - получение и кэширование содержимого
- ✅ `_evict_cache_if_needed()` - удаление старых записей
- ✅ `get_file_content()` - получение из кэша
- ✅ `search_in_directory()` - поиск в директории
- ✅ `update_file()` - обновление одного файла
- ✅ Граничные случаи

---

## Статистика изменений

### Измененные файлы:
1. `mcp_index.py` - добавлена команда `refresh_index()`
2. `mcp_index_engine.py` - комплексные улучшения:
   - Добавлено логирование
   - Добавлены константы
   - Оптимизировано обновление индекса
   - Добавлена валидация
   - Добавлен LRU кэш
   - Добавлена защита от path traversal
   - Добавлено ограничение размера файла

### Новые файлы:
1. `src/test/test_mcp_index_engine.py` - полный набор unit-тестов

### Добавленные функции:
- `refresh_index()` - MCP команда для обновления индекса
- `_validate_path()` - валидация путей
- `_evict_cache_if_needed()` - управление размером кэша
- `_remove_file_from_cache()` - удаление файла из всех индексов

### Улучшенные функции:
- `_update_index_for_file()` - оптимизировано обновление индекса
- `_load_content()` - добавлена проверка размера файла
- `_get_content()` - добавлена валидация и LRU eviction
- `index_directory()` - добавлено логирование и валидация
- `reindex()` - добавлено логирование
- `search_in_directory()` - добавлена валидация входных данных
- `update_file()` - добавлена валидация

---

## Оставшиеся задачи (не критично)

Следующие задачи из отчета скептика не реализованы, так как имеют низкий приоритет или требуют дополнительного планирования:

1. **Умное ранжирование результатов поиска** - отложено (требует проектирования алгоритма релевантности)
2. **Fallback стратегия без индекса** - отложено (индекс строится автоматически, fallback не критичен)
3. **Обработка конкурентного доступа** - отложено (текущее использование не требует многопоточности)
4. **Восстановление после ошибок** - отложено (требует проектирования механизма восстановления)
5. **Документация с примерами** - может быть добавлена позже

---

## Проверка качества

### ✅ Код:
- Все изменения протестированы
- Нет синтаксических ошибок
- Логирование добавлено во все критические места
- Валидация входных данных реализована
- Защита от ошибок улучшена

### ✅ Тесты:
- Создан полный набор unit-тестов
- Покрыты все основные методы
- Тесты проверяют граничные случаи
- Используются временные директории для изоляции

### ✅ Производительность:
- Оптимизировано обновление индекса
- Реализован LRU кэш для управления памятью
- Добавлено ограничение размера файла

### ✅ Безопасность:
- Добавлена валидация путей (защита от path traversal)
- Добавлено ограничение размера файла (защита от переполнения памяти)
- Улучшена обработка ошибок

---

## Заключение

Все критические и важные проблемы из отчета скептика исправлены. Модуль `mcp_index_engine.py` теперь:
- ✅ Имеет полное логирование ошибок
- ✅ Защищен от переполнения памяти (LRU кэш, ограничение размера файла)
- ✅ Оптимизирован для производительности
- ✅ Имеет валидацию входных данных
- ✅ Защищен от path traversal
- ✅ Имеет полный набор тестов
- ✅ Предоставляет MCP команду для обновления индекса

Модуль готов к использованию в production среде.
