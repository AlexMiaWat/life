# Задача #1: Архитектурная эволюция - Реализация субъективного времени и жизненных ритмов

**Идентификатор:** task_1_20260120_212346

**Дата создания:** 2026-01-21

**Статус:** Планирование

---

## 1. Техническое описание задачи

### 1.1. Цель задачи

Реализовать полную систему субъективного времени с адаптивными жизненными ритмами, которая позволит системе Life моделировать восприятие времени подобное живым организмам. Система должна обеспечивать:

- **Субъективное восприятие времени**: скорость течения времени зависит от интенсивности событий, стабильности и энергии системы
- **Адаптивные жизненные ритмы**: циркадные ритмы (день/ночь) с внутренней логикой независимой от внешнего времени
- **Моменты ясности**: особые состояния повышенной восприимчивости при благоприятных условиях
- **Эхо-памяти**: спонтанные всплывания воспоминаний с вероятностной логикой
- **Интеграция в принятие решений**: субъективное время влияет на все модули принятия решений (decision, action, planning, intelligence)

### 1.2. Текущий статус реализации

**Уже реализовано:**
- Базовая математическая модель субъективного времени (`src/runtime/subjective_time.py`)
- Циркадный ритм с параметрами recovery_efficiency и stability_modifier
- Система эхо-памяти с trigger_memory_echo в SelfState
- Clarity Moments система (отключена по умолчанию)
- Частичная интеграция в decision модуль

**Требует доработки:**
- Включение субъективного времени в runtime loop (отключено по соображениям производительности)
- Расширение циркадного ритма до полноценной системы день/ночь
- Активация Clarity Moments после стабилизации системы
- Полная интеграция субъективного времени во все модули принятия решений
- Улучшение механизма эхо-памяти с учетом субъективного времени

### 1.3. Объем изменений

**Затрагиваемые компоненты:**
- `src/runtime/loop.py` - включение субъективного времени
- `src/state/self_state.py` - расширение циркадного ритма
- `src/experimental/clarity_moments.py` - активация системы
- `src/decision/decision.py` - углубление интеграции
- `src/action/action.py` - учет субъективного времени
- `src/planning/planning.py` - адаптация к ритмам
- `src/intelligence/intelligence.py` - восприятие времени
- `src/environment/internal_generator.py` - улучшение эхо-памяти

**Новые компоненты:**
- Расширенная модель циркадного ритма с адаптивными периодами
- Система состояний сознания (ясность/замутнение/спонтанность)
- Улучшенный механизм эхо-памяти с субъективным временем

---

## 2. Архитектурные решения и обоснование

### 2.1. Архитектурные принципы

**Принцип 1: Субъективное время как метрика восприятия**
- Субъективное время не управляет циклом, а измеряет восприятие
- Детерминированные функции без side effects
- Экспоненциальное сглаживание для плавных переходов

**Принцип 2: Независимость внутренних ритмов**
- Циркадный ритм не зависит от внешнего времени суток
- Адаптивная длина "дня" на основе состояния системы
- Внутренняя логика жизненных циклов

**Принцип 3: Интеграция через состояние**
- Все модули получают доступ к субъективному времени через SelfState
- Единый источник истины для временных параметров
- Thread-safe доступ через существующие механизмы

### 2.2. Математическая модель субъективного времени

```
rate = base_rate + intensity_coeff * intensity + stability_term + energy_term

subjective_dt = dt * rate

где:
- intensity ∈ [0..1]: сглаженная интенсивность событий
- stability_term = stability_coeff * (stability - 1.0)  // отрицательный при stability < 1
- energy_term = energy_coeff * (energy / 100.0)        // положительный при высокой энергии
- rate ∈ [rate_min, rate_max] = [0.1, 3.0]            // ограничение скорости
```

**Обоснование:** Линейная модель обеспечивает предсказуемость и простоту анализа, экспоненциальное сглаживание предотвращает резкие скачки.

### 2.3. Архитектура циркадного ритма

**Текущая реализация:**
```python
phase_increment = (dt / circadian_period) * 2π
circadian_phase += phase_increment
circadian_phase %= 2π

recovery_efficiency = 0.4 + 0.6 * sin(phase + π/2)  # пик днем
stability_modifier = 0.7 + 0.6 * sin(phase)        # пик ночью
```

**Расширение для адаптивности:**
- Адаптивная длина периода на основе состояния системы
- Дополнительные фазы (утро/день/вечер/ночь) с разными характеристиками
- Влияние ритма на принятие решений и поведение

### 2.4. Система состояний сознания

**Моменты ясности (Clarity Moments):**
- Активация при высокой стабильности (≥0.8) и энергии (≥70%)
- Длительность ~50 тиков с усилением значимости событий (×1.5)
- Влияние на субъективное время (замедление для лучшего восприятия)

**Состояния замутнения:**
- При низкой стабильности (<0.3) или энергии (<30%)
- Ускоренное субъективное время
- Сниженная эффективность принятия решений

### 2.5. Улучшенный механизм эхо-памяти

**Текущая реализация:**
```python
echo_probability = base_probability * age_modifier * stability_modifier
# age_modifier = min(1.0, age / (30 * 24 * 3600))
# stability_modifier = 1.0 + (1.0 - stability)
```

**Улучшения:**
- Учет субъективного возраста вместо физического
- Зависимость от фазы циркадного ритма
- Разные типы эхо (эмоциональные, когнитивные, спонтанные)

---

## 3. План реализации (пошаговый)

### Фаза 1: Включение базового субъективного времени (1-2 дня)

**Шаг 1.1:** Включить субъективное время в runtime loop
- Раскомментировать код в `src/runtime/loop.py` (строки 291-307)
- Заменить простой инкремент на полный расчет
- Провести тестирование производительности

**Шаг 1.2:** Интеграционное тестирование
- Запуск smoke-тестов с включенным субъективным временем
- Проверка логирования и мониторинга
- Валидация монотонности субъективного времени

### Фаза 2: Расширение циркадного ритма (2-3 дня)

**Шаг 2.1:** Добавить адаптивные периоды
- Модификация `update_circadian_rhythm()` для учета состояния
- Адаптивная длина "дня" на основе стабильности и энергии
- Новые параметры: `circadian_adaptivity`, `day_length_modifier`

**Шаг 2.2:** Дополнительные фазы циркадного ритма
- Разделение на 4 фазы: рассвет/день/закат/ночь
- Разные коэффициенты для каждой фазы
- Влияние на субъективное время в зависимости от фазы

**Шаг 2.3:** Интеграция ритма в принятие решений
- Учет фазы циркадного ритма в decision модуле
- Модификация recovery_efficiency в зависимости от активности
- Адаптация stability_modifier под текущие условия

### Фаза 3: Активация Clarity Moments (1-2 дня)

**Шаг 3.1:** Подготовка к активации
- Аудит ClarityMoments на совместимость с текущей версией
- Обновление интерфейсов для работы с субъективным временем
- Тестирование в изолированной среде

**Шаг 3.2:** Интеграция в runtime loop
- Раскомментировать код в `src/runtime/loop.py` (строки 312-316)
- Изменить флаг `disable_clarity_moments` с True на False
- Настройка параметров активации

**Шаг 3.3:** Тестирование моментов ясности
- Проверка условий активации
- Валидация усиления значимости событий
- Мониторинг влияния на субъективное время

### Фаза 4: Улучшение эхо-памяти (2-3 дня)

**Шаг 4.1:** Учет субъективного времени в эхо
- Модификация `trigger_memory_echo()` для использования subjective_age
- Новые параметры вероятности на основе фазы циркадного ритма
- Разные типы эхо с различными характеристиками

**Шаг 4.2:** Расширение InternalEventGenerator
- Улучшение `generate_memory_echo()` с учетом контекста
- Добавление новых типов внутренних событий
- Интеграция с циркадным ритмом

**Шаг 4.3:** Интеграция эхо в принятие решений
- Обработка memory_echo событий в decision модуле
- Влияние эхо на субъективное восприятие времени
- Запись эхо-событий в память с субъективными timestamp

### Фаза 5: Полная интеграция в модули принятия решений (3-4 дня)

**Шаг 5.1:** Decision модуль
- Углубление использования time_ratio в логике принятия решений
- Учет фазы циркадного ритма при выборе паттернов
- Влияние моментов ясности на decision-making

**Шаг 5.2:** Action модуль
- Адаптация действий под субъективное время
- Учет циркадных ритмов при выборе интенсивности действий
- Модификация эффектов в зависимости от состояния сознания

**Шаг 5.3:** Planning и Intelligence модули
- Интеграция субъективного времени в планирование
- Адаптация intelligence под циркадные ритмы
- Учет моментов ясности для улучшения планирования

### Фаза 6: Тестирование и оптимизация (2-3 дня)

**Шаг 6.1:** Производительность
- Замер накладных расходов на субъективное время
- Оптимизация расчетов при необходимости
- Сравнение с baseline производительности

**Шаг 6.2:** Интеграционное тестирование
- Полный жизненный цикл с новыми компонентами
- Тестирование взаимодействия всех модулей
- Валидация корректности субъективного времени

**Шаг 6.3:** Документация и мониторинг
- Обновление ADR и компонентной документации
- Добавление метрик для новых функций
- Создание примеров использования

---

## 4. Потенциальные риски и их митигация

### 4.1. Риски производительности

**Риск:** Дополнительные расчеты субъективного времени замедлят runtime loop
- **Вероятность:** Высокая
- **Влияние:** Увеличение latency тика на 5-15%
- **Митигация:**
  - Замер baseline производительности перед изменениями
  - Оптимизация через кэширование промежуточных результатов
  - Graceful degradation при перегрузке

### 4.2. Риски регрессии поведения

**Риск:** Изменения в субъективном времени повлияют на симуляции
- **Вероятность:** Средняя
- **Влияние:** Непредсказуемые изменения в поведении системы
- **Митигация:**
  - Детальное логирование всех временных параметров
  - A/B тестирование с возможностью rollback
  - Сохранение старой логики под флагом

### 4.3. Риски интеграции Clarity Moments

**Риск:** Clarity Moments может дестабилизировать систему после долгого отключения
- **Вероятность:** Высокая
- **Влияние:** Неожиданные изменения в поведении
- **Митигация:**
  - Поэтапная активация с мониторингом
  - Изоляция через feature flags
  - Подробное тестирование перед включением

### 4.4. Риски сложности конфигурации

**Риск:** Слишком много параметров для настройки субъективного времени
- **Вероятность:** Средняя
- **Влияние:** Сложность в понимании и настройке
- **Митигация:**
  - Четкая документация всех параметров
  - Sensible defaults для большинства случаев
  - Группировка параметров по назначению

### 4.5. Риски многопоточности

**Риск:** Race conditions при доступе к параметрам циркадного ритма
- **Вероятность:** Низкая
- **Влияние:** Несогласованные состояния
- **Митигация:**
  - Использование существующих thread-safe механизмов SelfState
  - Тестирование на race conditions
  - Атомарные операции для критических параметров

---

## 5. Критерии приемки

### 5.1. Функциональные критерии

**Критерий 1:** Субъективное время включено и работает
- ✅ Субъективное время рассчитывается на каждом тике
- ✅ Время монотонно возрастает
- ✅ Логируется в структурированных логах

**Критерий 2:** Циркадный ритм адаптивен
- ✅ Период ритма зависит от состояния системы
- ✅ Recovery efficiency и stability modifier обновляются корректно
- ✅ 4 фазы ритма (рассвет/день/закат/ночь) реализованы

**Критерий 3:** Clarity Moments активированы
- ✅ Моменты ясности активируются при нужных условиях
- ✅ Значимость событий усиливается во время clarity
- ✅ Clarity события логируются корректно

**Критерий 4:** Эхо-память улучшена
- ✅ Эхо использует субъективное время
- ✅ Вероятность зависит от фазы циркадного ритма
- ✅ Разные типы эхо реализованы

**Критерий 5:** Полная интеграция в принятие решений
- ✅ Все модули (decision, action, planning, intelligence) учитывают субъективное время
- ✅ Циркадный ритм влияет на поведение
- ✅ Моменты ясности изменяют эффективность

### 5.2. Нефункциональные критерии

**Критерий 6:** Производительность
- ✅ Latency тика не увеличился более чем на 10%
- ✅ CPU overhead < 5% от общего времени
- ✅ Память не утекает при длительной работе

**Критерий 7:** Надежность
- ✅ Система стабильна при 1000+ тиков работы
- ✅ Все тесты проходят (unit, integration, performance)
- ✅ Обработка ошибок не приводит к краху

**Критерий 8:** Наблюдаемость
- ✅ Все новые метрики логируются
- ✅ Структурированные логи содержат временные параметры
- ✅ Мониторинг циркадного ритма и моментов ясности

### 5.3. Критерии качества кода

**Критерий 9:** Тестируемость
- ✅ Unit-тесты для всех новых функций (>90% покрытие)
- ✅ Integration-тесты для взаимодействия модулей
- ✅ Property-based тесты для временных инвариантов

**Критерий 10:** Документация
- ✅ ADR обновлены с новыми решениями
- ✅ Компонентная документация актуальна
- ✅ Примеры использования для всех функций

---

## 6. Связь с другими задачами и компонентами проекта

### 6.1. Зависимости от других задач

**Блокирующие задачи:**
- **Задача #2 (Улучшение качества тестирования):** Требуется для надежного тестирования новых функций
- **Задача #3 (Оптимизация производительности):** Критично для включения субъективного времени

**Параллельные задачи:**
- **Задача #4 (Расширение наблюдаемости):** Дополняет новыми метриками для субъективного времени
- **Задача #5 (Архитектурные улучшения):** Улучшает интеграцию с новыми компонентами

### 6.2. Влияние на компоненты проекта

**Core компоненты:**
- `src/runtime/loop.py` - основной цикл с субъективным временем
- `src/state/self_state.py` - расширение состояния новыми параметрами
- `src/decision/decision.py` - углубление логики принятия решений

**Environment компоненты:**
- `src/environment/internal_generator.py` - улучшение генерации внутренних событий
- `src/experimental/clarity_moments.py` - активация системы моментов ясности

**Intelligence компоненты:**
- `src/action/action.py` - адаптация действий к субъективному времени
- `src/planning/planning.py` - учет ритмов в планировании
- `src/intelligence/intelligence.py` - восприятие времени

**Infrastructure:**
- `src/observability/structured_logger.py` - новые метрики логирования
- `src/monitor/console.py` - отображение субъективного времени

### 6.3. Требования к инфраструктуре

**Тестирование:**
- Дополнительные тесты субъективного времени (unit + integration)
- Performance тесты для проверки накладных расходов
- Property-based тесты для временных свойств

**Мониторинг:**
- Новые метрики: subjective_time_rate, circadian_phase, clarity_state
- Логирование моментов ясности и эхо-событий
- Визуализация циркадных ритмов

**Документация:**
- Обновление ADR с архитектурными решениями
- Примеры использования новых функций
- Руководство по настройке параметров

### 6.4. План отката

**При обнаружении проблем:**
1. **Отключение Clarity Moments:** `disable_clarity_moments=True`
2. **Отключение субъективного времени:** Возврат к простому инкременту
3. **Rollback циркадного ритма:** Возврат к фиксированному периоду
4. **Полный откат:** Восстановление из git на точку перед задачей

**Мониторинг после отката:**
- Проверка восстановления производительности
- Валидация корректности поведения
- Анализ причин проблем для будущих итераций

---

## 7. Ресурсы и сроки

### 7.1. Оценка трудозатрат

- **Фаза 1:** 1-2 дня (включение базового субъективного времени)
- **Фаза 2:** 2-3 дня (расширение циркадного ритма)
- **Фаза 3:** 1-2 дня (активация Clarity Moments)
- **Фаза 4:** 2-3 дня (улучшение эхо-памяти)
- **Фаза 5:** 3-4 дня (интеграция в модули принятия решений)
- **Фаза 6:** 2-3 дня (тестирование и оптимизация)

**Итого:** 11-17 дней разработки

### 7.2. Ресурсы

**Команда:**
- 1 разработчик (основная реализация)
- 1 QA инженер (тестирование и валидация)

**Инфраструктура:**
- Тестовое окружение для интеграционного тестирования
- Профилировщик для анализа производительности
- CI/CD для автоматического тестирования

### 7.3. Контрольные точки

- **День 3:** Базовое субъективное время включено и протестировано
- **День 7:** Циркадный ритм расширен, Clarity Moments активированы
- **День 12:** Полная интеграция в модули принятия решений
- **День 15:** Финальное тестирование и оптимизация
- **День 17:** Документация завершена, задача готова к сдаче

---

## 8. Приложения

### 8.1. Список изменяемых файлов

```
src/runtime/loop.py                    # Включение субъективного времени
src/state/self_state.py               # Расширение циркадного ритма
src/experimental/clarity_moments.py   # Активация системы
src/decision/decision.py              # Углубление интеграции
src/action/action.py                  # Учет субъективного времени
src/planning/planning.py              # Адаптация к ритмам
src/intelligence/intelligence.py      # Восприятие времени
src/environment/internal_generator.py # Улучшение эхо-памяти
```

### 8.2. Новые параметры конфигурации

```python
# SelfState параметры
circadian_adaptivity: float = 0.1      # Адаптивность периода ритма
day_length_modifier: float = 1.0       # Модификатор длины дня
clarity_significance_boost: float = 1.5 # Усиление значимости в clarity
echo_subjective_age_weight: float = 0.7 # Вес субъективного возраста в эхо
```

### 8.3. Метрики для мониторинга

- `subjective_time_rate` - текущая скорость субъективного времени
- `circadian_phase` - фаза циркадного ритма (0-2π)
- `clarity_active` - флаг активности момента ясности
- `echo_events_per_hour` - количество эхо-событий в час
- `time_ratio` - отношение субъективного времени к физическому