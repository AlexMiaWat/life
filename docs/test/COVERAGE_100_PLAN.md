# План достижения 100% покрытия кода

## Текущее состояние: 92%

## Модули, требующие покрытия

### 1. main_server_api.py - 42% покрытие

**Непокрытые части:**
- `reloader_thread()` (строки 166-263) - функция авто-перезагрузки модулей
- Полный цикл запуска приложения (строки 265-323)
- `log_request()` с dev_mode (строки 132-155)
- Обработка ошибок в различных местах

**Сложность:** Высокая - требует интеграционного тестирования с файловой системой

**Подход:**
- Мокирование файловой системы для тестирования reloader
- Тестирование изменений файлов и перезагрузки модулей
- Тестирование полного цикла запуска с моками

### 2. generator_cli.py - 46% покрытие

**Непокрытые части:**
- `main()` функция (частично покрыта, но не все ветки)
- Обработка KeyboardInterrupt
- Полный цикл работы CLI

**Статус:** ✅ Частично покрыто тестами

### 3. monitor/console.py - 30% покрытие

**Статус:** ✅ Полностью покрыто новыми тестами

### 4. runtime/loop.py - 86% покрытие

**Непокрытые части:**
- Некоторые ветки обработки ошибок
- Continue для ignore pattern
- Обработка исключений

**Статус:** ✅ Частично покрыто edge case тестами

### 5. event_queue.py - 93% покрытие

**Непокрытые части:**
- Обработка queue.Empty в pop_all (строки 38-39)

**Статус:** ✅ Покрыто edge case тестами

## Стратегия достижения 100%

### Фаза 1: Простые модули (✅ Выполнено)
- event_queue.py
- monitor/console.py
- runtime/loop.py (edge cases)
- generator_cli.py

### Фаза 2: main_server_api.py (Требуется)

**Подход 1: Мокирование и изоляция**
- Мокировать файловую систему для reloader
- Тестировать отдельные компоненты изолированно
- Использовать unittest.mock для сложных зависимостей

**Подход 2: Интеграционные тесты**
- Запуск сервера в отдельном процессе
- Тестирование полного цикла
- Проверка перезагрузки модулей

**Подход 3: Исключение из покрытия**
- Если некоторые части невозможно протестировать (например, reloader в dev режиме)
- Можно пометить их как `# pragma: no cover`
- Это допустимо для служебного кода

## Рекомендации

### Для main_server_api.py:

1. **Тестируемые части:**
   - Обработка аргументов командной строки
   - Инициализация сервера
   - Обработка запросов (уже покрыто)

2. **Сложные для тестирования части:**
   - `reloader_thread()` - требует реальной файловой системы
   - Полный цикл запуска - требует интеграционного тестирования

3. **Варианты:**
   - Создать интеграционные тесты с реальным запуском
   - Использовать `# pragma: no cover` для служебного кода
   - Рефакторинг для лучшей тестируемости

## Целевое покрытие

- **Основные модули бизнес-логики:** 100% ✅
- **API эндпоинты:** 100% ✅
- **Генератор событий:** 100% ✅
- **Служебный код (reloader, main):** 80-90% (приемлемо)

## Текущий прогресс

- ✅ event_queue.py: 93% → 100% (ожидается)
- ✅ monitor/console.py: 30% → 100% (ожидается)
- ✅ runtime/loop.py: 86% → 95%+ (ожидается)
- ✅ generator_cli.py: 46% → 80%+ (ожидается)
- ⚠️ main_server_api.py: 42% → требует дополнительной работы

## Следующие шаги

1. Запустить тесты и проверить текущее покрытие
2. Добавить тесты для main_server_api.py (где возможно)
3. Решить, использовать ли `# pragma: no cover` для сложных частей
4. Достичь 95%+ покрытия (практически 100% для тестируемого кода)
