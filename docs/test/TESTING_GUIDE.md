# Руководство по тестированию проекта Life

## Общая информация

Проект Life состоит из двух основных компонентов:
1. **API сервер** - основной процесс с runtime loop и HTTP API
2. **Генератор событий** - отдельный процесс, отправляющий события на API сервер

## Запуск тестирования

### Шаг 1: Запуск API сервера

В первом терминале запустите сервер:

```bash
python src/main_server_api.py --dev --tick-interval 1.0 --snapshot-period 15
```

**Параметры:**
- `--dev` - режим разработки с авто-перезагрузкой модулей
- `--tick-interval 1.0` - интервал между тиками (секунды)
- `--snapshot-period 15` - период сохранения snapshots (тики)

**Ожидаемый вывод:**
- Запуск API сервера на `http://localhost:8000`
- Запуск runtime loop
- Мониторинг состояния в консоли

### Шаг 2: Запуск генератора событий

Во втором терминале запустите генератор:

```bash
python -m src.environment.generator_cli --interval 1 --host localhost --port 8000
```

**Параметры:**
- `--interval 1` - интервал генерации событий (секунды)
- `--host localhost` - хост API сервера
- `--port 8000` - порт API сервера

**Ожидаемый вывод:**
- Периодическая отправка событий на сервер
- Подтверждения успешной отправки

## Проверка работы Feedback модуля

### 1. Проверка регистрации действий

После запуска сервера и генератора, действия должны регистрироваться в `pending_actions`. Это происходит автоматически в runtime loop после каждого `execute_action()`.

**Что проверить:**
- В консоли сервера должны появляться сообщения о выполнении действий
- Каждое действие должно иметь уникальный `action_id`

### 2. Проверка наблюдения последствий

Feedback наблюдает последствия действий через 3-10 тиков после их выполнения.

**Что проверить:**
- Через 3-10 тиков после действия должны создаваться Feedback записи
- Feedback записи сохраняются в Memory с `event_type="feedback"`

### 3. Проверка через API

Проверьте состояние системы через API:

```bash
curl http://localhost:8000/status
```

**Что проверить в ответе:**
- `memory` - должен содержать записи с `event_type="feedback"`
- `ticks` - количество прошедших тиков
- `energy`, `stability`, `integrity` - параметры состояния

### 4. Проверка snapshots

Snapshots сохраняются каждые 15 тиков в `data/snapshots/snapshot_XXXXXX.json`.

**Что проверить:**
- Файлы snapshots создаются периодически
- В `memory` snapshots должны быть записи с `event_type="feedback"`

### 5. Проверка логов

Логи тиков сохраняются в `data/tick_log.jsonl`.

**Что проверить:**
- Файл создается и обновляется
- Каждая строка - валидный JSON с состоянием системы

## Тестирование конкретных сценариев

### Сценарий 1: Простое действие с последствиями

1. Запустите сервер и генератор
2. Дождитесь нескольких событий (5-10)
3. Проверьте через API наличие Feedback записей в Memory
4. Убедитесь, что записи имеют корректные `timestamp` и `event_type="feedback"`

### Сценарий 2: Проверка задержки наблюдения

1. Запустите сервер и генератор
2. Отследите момент выполнения действия (в логах)
3. Подождите 3-10 тиков
4. Проверьте, что Feedback запись появилась в Memory

### Сценарий 3: Проверка минимальных изменений

1. Запустите сервер
2. Отправьте событие с минимальным impact (например, `idle`)
3. Проверьте, что если изменения < 0.001, Feedback запись не создается

### Сценарий 4: Проверка таймаута

1. Запустите сервер
2. Симулируйте ситуацию, когда действие не проверяется >20 тиков
3. Убедитесь, что запись удаляется без создания Feedback

## Отладка

### Проблемы с запуском

**Сервер не запускается:**
- Проверьте, что порт 8000 свободен
- Проверьте наличие всех зависимостей
- Проверьте корректность путей к модулям

**Генератор не отправляет события:**
- Проверьте, что сервер запущен
- Проверьте правильность host и port
- Проверьте наличие библиотеки `requests`

### Проблемы с Feedback

**Feedback записи не создаются:**
- Проверьте, что действия выполняются (смотрите логи)
- Проверьте, что прошло достаточно тиков (3-10)
- Проверьте, что изменения состояния > 0.001

**Feedback записи создаются слишком часто:**
- Это нормально, если события приходят часто
- Каждое действие регистрируется отдельно

## Полезные команды

### Очистка данных

```bash
curl http://localhost:8000/clear-data
```

Или при запуске:

```bash
python src/main_server_api.py --clear-data yes --dev --tick-interval 1.0 --snapshot-period 15
```

### Просмотр последнего snapshot

```bash
# Linux/Mac
cat data/snapshots/$(ls -t data/snapshots/ | head -1) | jq '.memory[] | select(.event_type=="feedback")'

# Windows PowerShell
Get-Content (Get-ChildItem data/snapshots/*.json | Sort-Object LastWriteTime -Descending | Select-Object -First 1) | ConvertFrom-Json | Select-Object -ExpandProperty memory | Where-Object {$_.event_type -eq "feedback"}
```

### Просмотр логов

```bash
# Последние 10 строк
tail -n 10 data/tick_log.jsonl

# Фильтрация по типу события
grep "feedback" data/tick_log.jsonl
```

## Критерии успешного тестирования

✅ Сервер запускается без ошибок  
✅ Генератор успешно отправляет события  
✅ Действия регистрируются после выполнения  
✅ Feedback записи создаются через 3-10 тиков  
✅ Feedback записи сохраняются в Memory  
✅ Feedback записи видны в snapshots  
✅ API `/status` возвращает корректное состояние  
✅ Архитектурная целостность: Action не знает о Feedback  

## Дополнительные проверки

### Проверка архитектурной целостности

Убедитесь, что:
- В `src/action/action.py` нет импортов или упоминаний Feedback
- Регистрация действий происходит только в `src/runtime/loop.py`
- Feedback не содержит оценок (success/failure)

### Проверка производительности

- Система должна обрабатывать события без задержек
- Memory не должна расти бесконечно (clamp_size=50)
- Snapshots не должны создавать проблем с дисковым пространством
