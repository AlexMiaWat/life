# План выполнения задачи: Вынести политику "weakness/penalties" в `LifePolicy`

**Задача:** Вынести политику "weakness/penalties" в `LifePolicy` (единые пороги, конфиг, тестируемость)

**Дата создания:** 2026-01-20  
**ID задачи:** 1768919280  
**Источник:** [todo/GENERATED_20260120_20260120_094041.md](../../todo/GENERATED_20260120_20260120_094041.md)

## Анализ текущей ситуации

### Статус задачи

✅ **Задача уже выполнена** в рамках задачи 1768916097 (2026-01-20)

Политика "weakness/penalties" уже вынесена в `LifePolicy` и интегрирована в runtime loop.

### Текущее состояние реализации

#### 1. LifePolicy реализован

**Файл:** `src/runtime/life_policy.py`

**Реализовано:**
- Класс `LifePolicy` с конфигурируемыми параметрами:
  - `weakness_threshold: float = 0.05` - порог для определения слабости
  - `penalty_k: float = 0.02` - коэффициент штрафа за слабость
  - `stability_multiplier: float = 2.0` - множитель штрафа для stability
  - `integrity_multiplier: float = 2.0` - множитель штрафа для integrity
- Метод `is_weak(self_state: SelfState) -> bool` - проверка состояния слабости
- Метод `weakness_penalty(dt: float) -> dict[str, float]` - расчет штрафов (чистая функция)
- Валидация параметров (неотрицательные значения)

**Значения по умолчанию:**
- Совпадают с предыдущими константами из `loop.py`
- Обеспечивают обратную совместимость

#### 2. Интеграция в runtime loop

**Файл:** `src/runtime/loop.py`

**Реализовано:**
- Создан экземпляр `LifePolicy` в начале `run_loop()` (строка 221)
- Заменен inline-блок weakness penalties на использование LifePolicy (строки 545-551):
  ```python
  if life_policy.is_weak(self_state):
      penalty_deltas = life_policy.weakness_penalty(dt)
      self_state.apply_delta(penalty_deltas)
  ```
- Удалены старые константы weakness/penalties из `loop.py`

#### 3. Тестирование

**Файл:** `src/test/test_runtime_loop_managers.py`

**Реализовано 6 тестов для LifePolicy:**
- `test_is_weak_at_threshold` - проверка на границе порога
- `test_is_weak_any_parameter` - слабость по любому параметру
- `test_weakness_penalty_calculation` - корректные дельты penalties
- `test_weakness_penalty_monotonicity` - монотонность (при большем dt штраф не меньше)
- `test_weakness_penalty_multipliers` - множители для stability/integrity
- `test_default_values_match_old_constants` - значения по умолчанию совпадают с константами
- `test_life_policy_validation` - валидация параметров

**Результат:** Все тесты проходят успешно ✅

#### 4. Документация

**Обновлено:**
- `docs/adr/005-runtime-loop-managers.md` - ADR о менеджерах runtime loop
- `docs/components/runtime-loop.md` - документация Runtime Loop с описанием LifePolicy
- `docs/results/plan_result_task_1768916097.md` - отчет о выполнении задачи

## План проверки и верификации

### Этап 1: Проверка реализации LifePolicy ✅

**Цель:** Убедиться, что LifePolicy реализован корректно

**Проверки:**
- [x] Класс `LifePolicy` существует в `src/runtime/life_policy.py`
- [x] Параметры конфигурируемы через конструктор
- [x] Методы `is_weak()` и `weakness_penalty()` реализованы
- [x] Валидация параметров работает корректно
- [x] Значения по умолчанию совпадают с предыдущими константами

**Результат:** ✅ Все проверки пройдены

### Этап 2: Проверка интеграции в runtime loop ✅

**Цель:** Убедиться, что LifePolicy используется в runtime loop

**Проверки:**
- [x] `LifePolicy` импортирован в `loop.py`
- [x] Экземпляр `LifePolicy` создается в `run_loop()`
- [x] Методы `is_weak()` и `weakness_penalty()` вызываются в runtime loop
- [x] Старые константы weakness/penalties удалены из `loop.py`

**Результат:** ✅ Все проверки пройдены

### Этап 3: Проверка тестирования ✅

**Цель:** Убедиться, что LifePolicy покрыт тестами

**Проверки:**
- [x] Тесты для LifePolicy существуют в `test_runtime_loop_managers.py`
- [x] Тесты покрывают основные сценарии использования
- [x] Тесты проверяют валидацию параметров
- [x] Тесты проверяют корректность расчетов
- [x] Все тесты проходят успешно

**Результат:** ✅ Все проверки пройдены

### Этап 4: Проверка документации ✅

**Цель:** Убедиться, что документация обновлена

**Проверки:**
- [x] ADR 005 описывает LifePolicy
- [x] Документация Runtime Loop описывает LifePolicy
- [x] Отчет о выполнении задачи существует

**Результат:** ✅ Все проверки пройдены

## Критерии приемки

### Функциональные критерии

✅ **FC1:** Политика "weakness/penalties" вынесена в `LifePolicy`  
✅ **FC2:** `LifePolicy` имеет конфигурируемые параметры (пороги, коэффициенты)  
✅ **FC3:** `LifePolicy` интегрирован в runtime loop  
✅ **FC4:** Значения по умолчанию совпадают с предыдущими константами  
✅ **FC5:** `LifePolicy` покрыт unit-тестами  

### Нефункциональные критерии

✅ **NFC1:** Политика явная и тестируемая (чистая логика без I/O)  
✅ **NFC2:** Параметры конфигурируемы без редактирования runtime  
✅ **NFC3:** Все существующие тесты проходят  
✅ **NFC4:** Документация обновлена  

## Выводы

✅ **Задача выполнена успешно**

Политика "weakness/penalties" полностью вынесена в `LifePolicy`:
- Единые пороги и коэффициенты в одном месте
- Конфигурируемость через параметры конструктора
- Тестируемость через unit-тесты
- Интеграция в runtime loop
- Обновленная документация

Все критерии приемки выполнены. Задача готова к закрытию.

## Следующие шаги

1. ✅ Создать отчет о выполнении задачи
2. ✅ Обновить статус задачи в todo-листе
3. ✅ Закрыть задачу

---

**Автор плана:** AI Agent (Project Executor)  
**Дата:** 2026-01-20  
**Версия:** 1.0
