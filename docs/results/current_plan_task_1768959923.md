# План выполнения задачи DC.5: Улучшение логики выбора паттернов реакции в Decision модуле

## Контекст задачи

**Задача:** Улучшить логику выбора паттернов реакции в Decision модуле (ROADMAP_2026.md, DC.5)

**Текущая логика:**
- Простая проверка максимальной значимости в активированной памяти
- Fallback на логику Meaning (ignore/absorb)
- Ограниченная поддержка паттернов (ignore, absorb, dampen)
- Базовые модификаторы через субъективное время и параметры адаптации

## Анализ текущего состояния

### Текущая реализация в `src/decision/decision.py`:
```python
def decide_response(self_state: SelfState, meaning: Meaning) -> str:
    # Проверка max значимости в activated_memory > порог (0.5)
    if activated and max(e.meaning_significance for e in activated) > dampen_threshold:
        return "dampen"
    # Fallback: ignore если meaning.significance < 0.1, иначе absorb
```

### Доступные паттерны реакции (из MeaningEngine):
- `ignore` — игнорирование события
- `absorb` — полное поглощение эффекта
- `dampen` — ослабление эффекта
- `amplify` — усиление эффекта (НЕ используется в Decision)

## План улучшений

### 1. Анализ требований и проектирование (dc5_design_improvements)
**Цель:** Спроектировать улучшенную логику выбора паттернов
**Результат:** Спецификация новой логики выбора

### 2. Взвешенный анализ памяти (dc5_implement_weighted_analysis)
**Цель:** Заменить простой максимум на взвешенный анализ всей активированной памяти
**Подзадачи:**
- Рассчитывать средневзвешенную значимость
- Учитывать веса записей памяти
- Анализировать распределение значимостей

### 3. Поддержка паттерна amplify (dc5_add_amplify_pattern)
**Цель:** Добавить возможность выбора паттерна усиления
**Подзадачи:**
- Определить условия выбора amplify
- Интегрировать с логикой MeaningEngine
- Добавить соответствующие пороги

### 4. Контекстно-зависимый выбор (dc5_context_aware_selection)
**Цель:** Учитывать состояние системы при выборе паттерна
**Подзадачи:**
- Анализ энергии, стабильности, целостности
- Адаптация порогов на основе состояния
- Контекстуальные правила выбора паттернов

### 5. Паттерны по типам событий (dc5_event_type_patterns)
**Цель:** Специфические правила для разных типов событий
**Подзадачи:**
- Правила для шоковых событий (shock)
- Правила для восстановительных событий (recovery)
- Правила для шумовых событий (noise)
- Правила для социальных событий (social_*)

### 6. Обновление тестов (dc5_update_tests)
**Цель:** Адаптировать тесты под новую логику
**Подзадачи:**
- Обновить существующие тесты
- Добавить тесты для новых паттернов
- Добавить тесты для контекстно-зависимого выбора

### 7. Интеграционные тесты (dc5_integration_test)
**Цель:** Проверить работу в реальных сценариях
**Подзадачи:**
- Тестирование с различными типами событий
- Тестирование при разных состояниях системы
- Тестирование с различными паттернами памяти

## Критерии успеха

1. **Функциональность:** Все паттерны (ignore, absorb, dampen, amplify) доступны для выбора
2. **Интеллект:** Выбор паттерна учитывает состояние системы и тип события
3. **Адаптивность:** Логика использует параметры Learning и Adaptation
4. **Тестируемость:** Полное покрытие новыми тестами
5. **Производительность:** Не ухудшает производительность runtime loop

## Риски и mitigation

1. **Риск:** Слишком сложная логика приведет к непредсказуемому поведению
   - **Mitigation:** Постепенная реализация с промежуточными тестами

2. **Риск:** Изменения нарушат существующее поведение
   - **Mitigation:** Сохранение обратной совместимости, постепенный переход

3. **Риск:** Увеличение сложности тестирования
   - **Mitigation:** Модульная архитектура, разделение на компоненты

## Порядок реализации

1. **Фаза 1:** Анализ и проектирование (dc5_analyze_current_logic, dc5_design_improvements)
2. **Фаза 2:** Базовые улучшения (dc5_implement_weighted_analysis, dc5_add_amplify_pattern)
3. **Фаза 3:** Контекстная логика (dc5_context_aware_selection, dc5_event_type_patterns)
4. **Фаза 4:** Тестирование (dc5_update_tests, dc5_integration_test)

## Ожидаемые результаты

- Более интеллектуальный выбор паттернов реакции
- Улучшенная адаптация к различным ситуациям
- Лучшее использование памяти для принятия решений
- Сохранение принципов минимальности и детерминированности Decision модуля
