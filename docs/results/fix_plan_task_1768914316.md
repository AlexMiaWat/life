# План исправления проблем по задаче 1768914316

**Дата создания:** 2026-01-20  
**Задача:** Исправление выявленных проблем после скептического ревью  
**ID задачи:** 1768914316

## Критические проблемы (требуют немедленного исправления)

### 1. Несоответствие ID задач в документации
**Статус:** ❌ КРИТИЧЕСКАЯ ОШИБКА

**Проблема:**
- План: `current_plan_task_1768914096.md` (ID 1768914096)
- Отчет: `plan_result_task_1768914316.md` (ID 1768914316)
- Тесты: `test_task_1768914316.md` (ID 1768914316, но описывает другую функциональность)

**Решение:**
- Принять ID 1768914316 как правильный (используется в отчете о выполнении)
- Переименовать `current_plan_task_1768914096.md` → `current_plan_task_1768914316.md`
- Обновить ссылки в документации

### 2. Отчет о тестировании описывает другую функциональность
**Статус:** ❌ КРИТИЧЕСКАЯ ОШИБКА

**Проблема:**
- `test_task_1768914316.md` описывает тестирование Learning/Adaptation/MeaningEngine
- Должен описывать тестирование fallback стратегии

**Решение:**
- Переименовать `test_task_1768914316.md` → `test_task_learning_adaptation_meaning.md` (или найти правильный ID)
- Создать новый `test_task_1768914316.md` с отчетом о тестировании fallback стратегии

### 3. Отсутствие автоматических тестов для fallback стратегии
**Статус:** ❌ КРИТИЧЕСКАЯ ОШИБКА

**Решение:**
Создать тесты в `src/test/test_mcp_index_engine_fallback.py`:
- Unit-тест для `_is_index_available()`
- Unit-тест для `_linear_search_in_cache()`
- Unit-тест для `_grep_search_in_files()`
- Интеграционный тест для последовательности fallback уровней
- Тесты для проверки переключения между уровнями при сбоях

### 4. Multi-provider архитектура не интегрирована в mcp_index.py
**Статус:** ❌ КРИТИЧЕСКАЯ ОШИБКА

**Решение:**
Интегрировать в `mcp_index.py`:
- Добавить импорты `SearchManager` и `IndexSearchProvider`
- Создать функцию `_get_search_manager()`
- Модифицировать `search_docs` и `search_todo` для использования `SearchManager`

## Проблемы в коде (важные доработки)

### 5. Дублирование логики применения режимов поиска
**Статус:** ⚠️ Недоработка

**Решение:**
Вынести общую логику в метод `_apply_search_mode()`:
```python
def _apply_search_mode(
    self,
    content: str,
    mode: str,
    tokens_or_phrase: list[str] | str,
    search_and_func,
    search_or_func,
    search_phrase_func,
) -> bool:
    """Применяет режим поиска к содержимому."""
    if mode == "PHRASE":
        return search_phrase_func(content, str(tokens_or_phrase))
    elif mode == "AND" and isinstance(tokens_or_phrase, list):
        return search_and_func(content, tokens_or_phrase)
    elif mode == "OR" and isinstance(tokens_or_phrase, list):
        return search_or_func(content, tokens_or_phrase)
    return False
```

### 6. Неконсистентная обработка ошибок
**Статус:** ⚠️ Недоработка

**Решение:**
Унифицировать обработку ошибок:
- Все уровни fallback используют `logger.warning()` для ошибок
- Уровень 3 (grep) также использует `logger.warning()`, а не `logger.error()`
- Единый формат сообщений об ошибках

### 7. Неконсистентная проверка результатов
**Статус:** ⚠️ Недоработка

**Решение:**
Унифицировать проверку результатов:
- Все уровни проверяют результаты одинаково
- Проверка выполняется после try-except блока

### 8. Отсутствие валидации параметров
**Статус:** ⚠️ Недоработка

**Решение:**
Добавить валидацию в fallback методы:
- Проверка `directory` (не None, существует)
- Проверка `limit` (положительное число)
- Проверка `mode` (валидное значение)
- Проверка `tokens_or_phrase` (не пустое)

## Проблемы в документации

### 9. Несоответствие между планом и реализацией
**Статус:** ⚠️ Недоработка

**Решение:**
Обновить `plan_result_task_1768914316.md`:
- Указать, что multi-provider архитектура создана, но интеграция отложена
- Или выполнить интеграцию согласно плану

### 10. Отсутствие примеров использования
**Статус:** ⚠️ Недоработка

**Решение:**
Добавить в документацию:
- Примеры симуляции сбоя индекса
- Примеры проверки используемого уровня fallback
- Примеры интерпретации логов

### 11. Отсутствие информации о критериях переключения
**Статус:** ⚠️ Недоработка

**Решение:**
Добавить в документацию:
- Описание критериев "недоступности индекса"
- Описание критериев "недоступности кэша"
- Информацию о переключении обратно на уровень 1

## Порядок выполнения

1. ✅ Создать план исправлений (этот файл)
2. ⏳ Исправить несоответствие ID задач
3. ⏳ Переименовать/исправить отчет о тестировании
4. ⏳ Создать автоматические тесты для fallback стратегии
5. ⏳ Интегрировать multi-provider архитектуру
6. ⏳ Улучшить код (вынести общую логику, унифицировать обработку ошибок)
7. ⏳ Добавить валидацию параметров
8. ⏳ Обновить документацию

## Критерии приемки

- ✅ Все критические проблемы исправлены
- ✅ Тесты для fallback стратегии созданы и проходят
- ✅ Multi-provider архитектура интегрирована
- ✅ Код улучшен (DRY, консистентность)
- ✅ Документация обновлена
