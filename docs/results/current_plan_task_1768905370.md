# План выполнения задачи: Зафиксировать проблемы текущего подхода

**Задача ID:** 1768905370  
**Дата создания:** 2026-01-20  
**Статус:** В плане

## Описание задачи

Зафиксировать проблемы текущего подхода, связанные с:
1. **Идентичностью объектов** - проблемы с перезагрузкой модулей через `importlib.reload()`
2. **Висящими потоками/серверами** - потоки и серверы могут оставаться активными после перезагрузки
3. **Непредсказуемостью** - race conditions и неконсистентное состояние при hot reload

## Анализ текущей ситуации

### 1. Проблема идентичности объектов

**Местоположение:** `src/main_server_api.py`, функция `reloader_thread()`

**Проблемы:**
- Использование `importlib.reload()` для перезагрузки модулей в dev-режиме
- При перезагрузке создаются новые объекты классов, но старые ссылки остаются
- Объекты `self_state`, `event_queue`, `monitor`, `log` могут иметь неконсистентные ссылки
- Глобальные переменные (`server`, `api_thread`, `loop_thread`) могут указывать на старые объекты

**Примеры проблемных мест:**
```python
# Строка 234: глобальные переменные
global self_state, server, api_thread, monitor, log, loop_thread, loop_stop, config, event_queue

# Строки 288-293: перезагрузка модулей
importlib.reload(console_module)
importlib.reload(loop_module)
importlib.reload(state_module)
# ... но старые ссылки могут остаться в других местах

# Строки 303-309: обновление ссылок
monitor = console_module.monitor
log = console_module.log
run_loop = loop_module.run_loop
# Но self_state может быть старым объектом
```

**Последствия:**
- Runtime loop может работать со старым объектом `self_state`
- API server может читать из старого состояния
- Логирование может идти в старые файлы/объекты
- Неконсистентное состояние между компонентами

### 2. Проблема висящих потоков/серверов

**Местоположение:** `src/main_server_api.py`, функции `reloader_thread()` и `start_api_server()`

**Проблемы:**
- При перезагрузке старый API сервер может не завершиться корректно
- Поток `api_thread` может остаться активным после `shutdown()`
- Поток `loop_thread` может не завершиться в течение `timeout=5.0`
- Daemon потоки могут продолжать работать с устаревшими модулями

**Примеры проблемных мест:**
```python
# Строки 274-278: остановка сервера
if server:
    server.shutdown()
    if api_thread:
        api_thread.join()  # Может зависнуть, если поток не завершился

# Строки 322-324: остановка loop thread
if loop_thread and loop_thread.is_alive():
    loop_stop.set()
    loop_thread.join(timeout=5.0)  # Может не завершиться за 5 секунд
```

**Последствия:**
- Множественные экземпляры API сервера на одном порту (после перезапуска)
- Старые потоки продолжают работать со старым кодом
- Утечки ресурсов (память, файловые дескрипторы)
- Невозможность корректного перезапуска

### 3. Проблема непредсказуемости

**Местоположение:** `src/main_server_api.py`, весь файл

**Проблемы:**
- Race conditions между перезагрузкой модулей и выполнением кода
- Нет гарантии атомарности перезагрузки
- Глобальные переменные могут изменяться во время выполнения
- Нет механизма синхронизации между перезагрузкой и использованием объектов

**Примеры проблемных мест:**
```python
# Строка 258: бесконечный цикл без синхронизации
while True:
    time.sleep(1)
    # Проверка изменений и перезагрузка
    # Но другие потоки могут использовать объекты во время перезагрузки

# Строки 386-405: создание потоков без проверки существующих
api_thread = threading.Thread(...)
api_thread.start()
# Если старый поток еще не завершился, будет два потока
```

**Последствия:**
- Неконсистентное поведение системы
- Сложно отлаживать проблемы
- Непредсказуемые ошибки при работе в dev-режиме
- Невозможность гарантировать корректное состояние системы

## Документирование проблем

### Этап 1: Создание документа с описанием проблем

**Цель:** Зафиксировать все выявленные проблемы в структурированном виде

**Действия:**
1. Создать документ `docs/development/HOT_RELOAD_PROBLEMS.md`
2. Описать каждую проблему с примерами кода
3. Указать последствия и риски
4. Добавить ссылки на проблемные места в коде

**Структура документа:**
- Обзор проблемы hot reload
- Проблема идентичности объектов (с примерами кода)
- Проблема висящих потоков/серверов (с примерами кода)
- Проблема непредсказуемости (с примерами кода)
- Связь с техническим долгом (DEBT.md #10)
- Рекомендации по решению (для будущей реализации)

### Этап 2: Обновление DEBT.md

**Цель:** Дополнить существующую запись о hot reload детальным описанием проблем

**Действия:**
1. Найти запись #10 в `todo/DEBT.md`
2. Дополнить описанием конкретных проблем:
   - Идентичность объектов
   - Висящие потоки/серверы
   - Непредсказуемость
3. Добавить ссылки на проблемные места в коде
4. Указать приоритет и критичность

### Этап 3: Создание отчета о проблемах

**Цель:** Создать краткий отчет для текущей задачи

**Действия:**
1. Создать отчет в `docs/results/last_result.md`
2. Описать выполненный анализ
3. Перечислить выявленные проблемы
4. Указать созданные документы

## План выполнения

### Шаг 1: Анализ кода и выявление проблем
- [x] Изучить `src/main_server_api.py`
- [x] Изучить `src/runtime/loop.py`
- [x] Изучить `src/state/self_state.py`
- [x] Изучить документацию (DEBT.md)
- [x] Выявить все проблемные места

### Шаг 2: Создание документации проблем
- [ ] Создать `docs/development/HOT_RELOAD_PROBLEMS.md`
- [ ] Описать проблему идентичности объектов
- [ ] Описать проблему висящих потоков/серверов
- [ ] Описать проблему непредсказуемости
- [ ] Добавить примеры кода и ссылки

### Шаг 3: Обновление DEBT.md
- [ ] Найти и дополнить запись #10
- [ ] Добавить детальное описание проблем
- [ ] Указать приоритет и критичность

### Шаг 4: Создание отчета
- [ ] Создать отчет в `docs/results/last_result.md`
- [ ] Описать выполненный анализ
- [ ] Перечислить выявленные проблемы
- [ ] Указать созданные документы

## Критерии успеха

1. ✅ Все проблемы задокументированы в структурированном виде
2. ✅ DEBT.md обновлен с детальным описанием проблем
3. ✅ Создан отчет о выполненной работе
4. ✅ Указаны конкретные места в коде с проблемами
5. ✅ Описаны последствия и риски каждой проблемы

## Риски и митигация

**Риск 1:** Неполное выявление проблем
- **Митигация:** Тщательный анализ кода и документации

**Риск 2:** Неточное описание проблем
- **Митигация:** Использование конкретных примеров кода и ссылок на строки

**Риск 3:** Документация не будет использоваться
- **Митигация:** Интеграция в существующую структуру документации (DEBT.md)

## Связь с другими задачами

- **DEBT.md #10:** Hot reload через importlib — технический долг
- **Задача синхронизации состояния:** Проблемы с идентичностью объектов усугубляют проблемы синхронизации
- **Задача рефакторинга runtime loop:** Проблемы hot reload влияют на архитектуру

## Примечания

- Задача НЕ включает исправление проблем, только их документирование
- Исправление проблем будет выполнено в отдельной задаче согласно DEBT.md
- Документация должна быть достаточно детальной для будущей реализации решения
