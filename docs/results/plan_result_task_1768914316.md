# Отчет: Реализация fallback стратегии без LLM и multi-provider архитектуры

**Дата выполнения:** 2026-01-20  
**ID задачи:** 1768914316  
**Пункт плана:** Пункт 2

## Задача

Спроектировать и реализовать fallback стратегию без LLM (и опционально — multi-provider для LLM, если появится).

## Выполненные работы

### 1. Fallback стратегия (обязательная часть)

Реализована трехуровневая fallback стратегия для обеспечения надежности поиска:

#### Уровень 1: Инвертированный индекс (основной метод)
- **Статус:** ✅ Уже был реализован
- **Описание:** Использует инвертированный индекс для быстрого поиска по токенам
- **Проверка доступности:** Добавлен метод `_is_index_available()` для проверки готовности индекса

#### Уровень 2: Линейный поиск по кэшу
- **Статус:** ✅ Реализовано
- **Метод:** `_linear_search_in_cache()`
- **Описание:** Выполняет линейный поиск по кэшированному содержимому файлов, если индекс недоступен
- **Особенности:**
  - Использует существующий кэш содержимого файлов (`content_cache`)
  - Поддерживает все режимы поиска: AND, OR, PHRASE
  - Сохраняет ранжирование результатов по score
  - Автоматически активируется при недоступности индекса

#### Уровень 3: Grep-поиск по файлам
- **Статус:** ✅ Реализовано
- **Метод:** `_grep_search_in_files()`
- **Описание:** Выполняет простой grep-подобный поиск по файлам, если кэш недоступен
- **Особенности:**
  - Ищет все `.md` файлы в директории рекурсивно
  - Загружает файлы на лету при необходимости
  - Автоматически обновляет кэш и индекс для будущих запросов
  - Последний резервный уровень поиска

#### Интеграция fallback в `search_in_directory()`
- **Статус:** ✅ Реализовано
- **Описание:** Метод `search_in_directory()` модифицирован для автоматического переключения между уровнями
- **Логика работы:**
  1. Проверяет доступность индекса через `_is_index_available()`
  2. Если индекс доступен — использует уровень 1
  3. При ошибке или недоступности индекса — переключается на уровень 2
  4. При недоступности кэша — переключается на уровень 3
  5. Логирует используемый уровень fallback для отладки

### 2. Multi-provider архитектура (опциональная часть)

Реализована архитектура для поддержки множественных провайдеров поиска:

#### Абстракция SearchProvider
- **Файл:** `mcp_search_provider.py`
- **Статус:** ✅ Реализовано
- **Описание:** Абстрактный базовый класс для всех провайдеров поиска
- **Методы:**
  - `search()` — выполнение поиска
  - `is_available()` — проверка доступности провайдера
  - `get_name()` — получение имени провайдера

#### IndexSearchProvider
- **Статус:** ✅ Реализовано
- **Описание:** Провайдер поиска на основе инвертированного индекса
- **Особенности:**
  - Обертка над существующим `IndexEngine`
  - Использует метод `_is_index_available()` для проверки доступности
  - Поддерживает все режимы поиска

#### LLMSearchProvider
- **Статус:** ✅ Реализовано (заглушка)
- **Описание:** Провайдер поиска на основе LLM
- **Особенности:**
  - Готова архитектура для будущей реализации
  - Проверяет доступность LLM клиента
  - Метод `search()` содержит заглушку с предупреждением
  - Легко расширяется для реальной LLM интеграции

#### SearchManager
- **Статус:** ✅ Реализовано
- **Описание:** Менеджер для управления несколькими провайдерами поиска
- **Функциональность:**
  - Поддержка основных и fallback провайдеров
  - Автоматическое переключение между провайдерами
  - Логирование используемого провайдера
  - Обработка ошибок при сбое провайдера

## Измененные файлы

1. **`mcp_index_engine.py`**
   - Добавлен метод `_is_index_available()` (строки ~603-612)
   - Добавлен метод `_linear_search_in_cache()` (строки ~614-672)
   - Добавлен метод `_grep_search_in_files()` (строки ~674-750)
   - Модифицирован метод `search_in_directory()` для использования fallback (строки ~752-850)

2. **`mcp_search_provider.py`** (новый файл)
   - Класс `SearchProvider` (абстракция)
   - Класс `IndexSearchProvider` (реализация для индекса)
   - Класс `LLMSearchProvider` (заглушка для LLM)
   - Класс `SearchManager` (менеджер провайдеров)

## Архитектура решения

### Fallback стратегия

```
┌─────────────────────────────────────┐
│   Поисковый запрос                  │
└──────────────┬──────────────────────┘
               │
               ▼
    ┌──────────────────────┐
    │  Проверка индекса     │
    │  (_is_index_available)│
    └──────────┬────────────┘
               │
       ┌───────┴────────┐
       │                │
   [Доступен]      [Недоступен]
       │                │
       ▼                ▼
┌─────────────┐  ┌──────────────────┐
│ Уровень 1:  │  │ Уровень 2:       │
│ Инвертир.   │  │ Линейный поиск   │
│ индекс      │  │ по кэшу          │
└─────────────┘  └────────┬─────────┘
                          │
                    [Недоступен]
                          │
                          ▼
                   ┌──────────────┐
                   │ Уровень 3:   │
                   │ Grep-поиск   │
                   │ по файлам    │
                   └──────────────┘
```

### Multi-provider архитектура

```
┌─────────────────────────────────────┐
│   SearchProvider (абстракция)      │
└──────────────┬──────────────────────┘
               │
       ┌───────┴────────┐
       │                │
       ▼                ▼
┌─────────────┐  ┌─────────────┐
│ IndexSearch │  │ LLMSearch   │
│ Provider    │  │ Provider    │
│ (реализован)│  │ (заглушка)  │
└─────────────┘  └─────────────┘
       │                │
       └────────┬───────┘
                │
                ▼
        ┌───────────────┐
        │ SearchManager  │
        │ (менеджер)    │
        └───────────────┘
```

## Критерии приемки

### Обязательные (fallback стратегия)

- ✅ Поиск работает через инвертированный индекс (уровень 1)
- ✅ Поиск работает через линейный поиск по кэшу (уровень 2)
- ✅ Поиск работает через grep по файлам (уровень 3)
- ✅ Система автоматически переключается между уровнями
- ✅ Логирование используемого уровня fallback
- ✅ Обработка ошибок на каждом уровне

### Опциональные (multi-provider)

- ✅ Создана абстракция SearchProvider
- ✅ Реализован IndexSearchProvider
- ✅ Реализован LLMSearchProvider (заглушка)
- ✅ Реализован SearchManager
- ✅ Архитектура позволяет добавить LLM провайдер в будущем

## Преимущества реализации

1. **Надежность:**
   - Система продолжает работать даже при сбое индекса
   - Три уровня защиты от отказов
   - Автоматическое восстановление функциональности

2. **Производительность:**
   - Быстрый поиск через индекс (уровень 1)
   - Эффективный поиск через кэш (уровень 2)
   - Резервный поиск через файлы (уровень 3)

3. **Расширяемость:**
   - Легкое добавление новых провайдеров поиска
   - Готовая архитектура для LLM интеграции
   - Модульная структура кода

4. **Прозрачность:**
   - Логирование используемого уровня fallback
   - Понятная структура кода
   - Хорошая документация методов

## Тестирование

### Рекомендуемые тесты

1. **Тест уровня 1 (индекс):**
   - Проверить, что поиск работает через индекс при его доступности
   - Проверить корректность результатов

2. **Тест уровня 2 (линейный поиск):**
   - Очистить индекс, но оставить кэш
   - Проверить, что поиск работает через линейный поиск по кэшу
   - Проверить логирование fallback уровня 2

3. **Тест уровня 3 (grep):**
   - Очистить индекс и кэш
   - Проверить, что поиск работает через grep по файлам
   - Проверить логирование fallback уровня 3

4. **Тест последовательности fallback:**
   - Симулировать сбой индекса
   - Проверить, что система переключается на следующий уровень
   - Проверить корректность результатов на каждом уровне

5. **Тест multi-provider (опционально):**
   - Проверить переключение между провайдерами
   - Проверить использование fallback провайдеров
   - Проверить обработку ошибок провайдеров

## Использование

### Fallback стратегия

Fallback стратегия работает автоматически. При вызове `search_in_directory()` система автоматически выбирает доступный уровень поиска:

```python
from mcp_index_engine import IndexEngine

engine = IndexEngine(docs_dir, todo_dir, src_dir)
engine.initialize()

# Поиск автоматически использует доступный уровень fallback
results = engine.search_in_directory(
    docs_dir,
    "fallback strategy",
    mode="AND",
    limit=10
)
```

### Multi-provider архитектура

Для использования multi-provider архитектуры:

```python
from mcp_search_provider import SearchManager, IndexSearchProvider, LLMSearchProvider
from mcp_index_engine import IndexEngine

# Создаем менеджер
manager = SearchManager()

# Добавляем основной провайдер
engine = IndexEngine(docs_dir, todo_dir, src_dir)
engine.initialize()
manager.add_provider(IndexSearchProvider(engine))

# Опционально: добавляем LLM провайдер (если доступен)
# llm_client = ...  # инициализация LLM клиента
# manager.add_provider(LLMSearchProvider(llm_client))

# Выполняем поиск
results = manager.search(docs_dir, "fallback strategy", mode="AND", limit=10)
```

## Заключение

Реализована полная fallback стратегия без LLM с тремя уровнями защиты:
1. Инвертированный индекс (основной метод)
2. Линейный поиск по кэшу (fallback уровень 2)
3. Grep-поиск по файлам (fallback уровень 3)

Дополнительно реализована multi-provider архитектура для будущего расширения:
- Абстракция SearchProvider
- IndexSearchProvider для текущего индекса
- LLMSearchProvider (заглушка) для будущей LLM интеграции
- SearchManager для управления провайдерами

Система теперь более надежна и готова к расширению новыми провайдерами поиска.

Отчет завершен!
