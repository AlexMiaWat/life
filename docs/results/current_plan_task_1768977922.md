# План выполнения задачи: Интегрировать субъективное время во все модули принятия решений

## Контекст задачи

Необходимо интегрировать субъективное время (`subjective_time`) во все модули принятия решений системы Life:
- **activation** - модуль активации памяти
- **decision** - модуль принятия решений (уже частично интегрирован)
- **action** - модуль выполнения действий (уже частично интегрирован)
- **intelligence** - модуль обработки информации
- **planning** - модуль планирования

## Анализ текущего состояния

### Уже интегрировано:
- **decision.py**: Использует `time_ratio` и `time_perception` для модификации логики выбора паттерна реакции
- **action.py**: Записывает `subjective_timestamp` в записи памяти

### Требует интеграции:
- **activation.py**: Не учитывает субъективное время при активации воспоминаний
- **intelligence.py**: Не учитывает субъективное время при обработке информации
- **planning.py**: Не учитывает субъективное время при фиксации последовательностей

## Дизайн интеграции

### 1. Activation (активация памяти)

**Текущая логика:** Активирует топ-N воспоминаний по значимости с фиксированным лимитом (N=3).

**Новая логика:**
- При **ускоренном восприятии времени** (`time_ratio > 1.1`): Увеличивать лимит активации (до 5) - система более внимательна к прошлому опыту
- При **замедленном восприятии времени** (`time_ratio < 0.9`): Уменьшать лимит активации (до 2) - система менее внимательна
- При **нормальном восприятии времени**: Стандартный лимит (3)

**Математика:**
```python
time_ratio = self_state.subjective_time / self_state.age if self_state.age > 0 else 1.0

if time_ratio > 1.1:
    activation_limit = min(5, len(matching))  # Увеличить до 5
elif time_ratio < 0.9:
    activation_limit = max(2, len(matching))  # Уменьшить до 2
else:
    activation_limit = min(3, len(matching))  # Стандартный лимит 3
```

### 2. Intelligence (обработка информации)

**Текущая логика:** Фиксирует размеры всех доступных источников информации без оценки.

**Новая логика:** Добавить метрики субъективного времени в обработку, модифицировать набор источников в зависимости от восприятия времени.

**Архитектурные ограничения:**
- Не нарушать принцип нейтральности (нет целей, желаний, оценок)
- Только фиксация потенциала обработки информации
- Дополнительные метрики субъективного времени как часть фиксации состояния

**Модификация:**
```python
# Расчет метрик восприятия времени
time_ratio = self_state.subjective_time / self_state.age if self_state.age > 0 else 1.0
time_perception = "accelerated" if time_ratio > 1.1 else "normal" if time_ratio > 0.9 else "slowed"

# Модификация набора источников в зависимости от восприятия времени
if time_perception == "accelerated":
    # При ускоренном восприятии - учитывать все доступные источники
    processed = {
        "memory_proxy_size": len(recent_events),
        "adaptation_proxy": energy,
        "learning_proxy": stability,
        "planning_proxy_size": len(planning.get("potential_sequences", [])),
        "subjective_time_metrics": {
            "current_subjective_time": self_state.subjective_time,
            "time_ratio": time_ratio,
            "time_perception": time_perception,
            "intensity_smoothed": self_state.last_event_intensity
        }
    }
elif time_perception == "slowed":
    # При замедленном восприятии - минимальный набор источников
    processed = {
        "memory_proxy_size": len(recent_events),
        "adaptation_proxy": energy,
        "subjective_time_metrics": {
            "time_perception": time_perception,
            "time_ratio": time_ratio
        }
    }
else:
    # Нормальное восприятие - стандартный набор с базовыми метриками времени
    processed = {
        "memory_proxy_size": len(recent_events),
        "adaptation_proxy": energy,
        "learning_proxy": stability,
        "planning_proxy_size": len(planning.get("potential_sequences", [])),
        "subjective_time_metrics": {
            "current_subjective_time": self_state.subjective_time,
            "time_perception": time_perception
        }
    }
```

### 3. Planning (планирование)

**Текущая логика:** Фиксирует последовательности из последних 2+ событий без оценки.

**Новая логика:** Модифицировать логику фиксации последовательностей на основе восприятия времени.

**Архитектурные ограничения:**
- Не нарушать принцип нейтральности (нет оценки, выбора или предсказания)
- Только фиксация потенциальных последовательностей как нейтральных структур
- Модификация параметров фиксации на основе метрик времени

**Модификация:**
```python
# Расчет метрик восприятия времени
time_ratio = self_state.subjective_time / self_state.age if self_state.age > 0 else 1.0
time_perception = "accelerated" if time_ratio > 1.1 else "normal" if time_ratio > 0.9 else "slowed"

# Модификация параметров фиксации на основе восприятия времени
if time_perception == "accelerated":
    # При ускоренном восприятии - более длинные последовательности, больше вариантов
    min_sequence_length = 3
    max_sequences = 2
elif time_perception == "slowed":
    # При замедленном восприятии - более короткие последовательности, меньше вариантов
    min_sequence_length = 2
    max_sequences = 1
else:
    # Нормальное восприятие - стандартные параметры
    min_sequence_length = 2
    max_sequences = 1

# Фиксация последовательностей с модифицированными параметрами
potential_sequences = []
if len(recent_events) >= min_sequence_length:
    # Создаем последовательности разной длины
    for length in range(min_sequence_length, len(recent_events) + 1):
        if len(potential_sequences) >= max_sequences:
            break
        potential_sequences.append(recent_events[-length:])
```

## План реализации

### Фаза 1: Дизайн и анализ ✅ ЗАВЕРШЕНА
- [x] Анализ текущей интеграции субъективного времени
- [x] Проектирование интеграции в activation.py - динамический лимит активации
- [x] Проектирование интеграции в intelligence.py - модификация набора источников
- [x] Проектирование интеграции в planning.py - модификация параметров последовательностей

### Фаза 2: Реализация изменений ✅ ЗАВЕРШЕНА
- [x] Модификация activation.py - добавлен расчет лимита на основе time_ratio
- [x] Модификация intelligence.py - добавлены метрики субъективного времени
- [x] Модификация planning.py - модификация min_sequence_length и max_sequences
- [x] Обновление вызова activate_memory в runtime loop

### Фаза 3: Тестирование и документация ✅ ЗАВЕРШЕНА
- [x] Добавление unit-тестов для всех модулей (18 новых тестов)
- [x] Интеграционное тестирование - runtime loop работает корректно
- [x] Проверка совместимости - все существующие тесты проходят
- [x] Обновление документации компонентов

## Критерии успеха

1. **Функциональность:** Все модули принятия решений учитывают субъективное время в своей логике
2. **Совместимость:** Изменения не нарушают существующие API и поведение
3. **Тестируемость:** Все изменения покрыты тестами
4. **Документация:** Обновлена документация всех затронутых компонентов

## Риски и mitigation

- **Риск:** Изменения повлияют на детерминированность системы
  - **Митигация:** Субъективное время является детерминированной функцией состояния

- **Риск:** Снижение производительности
  - **Митигация:** Дополнительные расчеты минимальны, аналогичны decision.py

- **Риск:** Нарушение архитектурных принципов модулей
  - **Митигация:** Интеграция следует паттернам из decision.py, не нарушает ограничения модулей

## Следующие шаги

1. Завершить проектирование интеграции для intelligence и planning
2. Начать реализацию с activation.py
3. Протестировать каждое изменение отдельно
4. Провести интеграционное тестирование всей системы принятия решений