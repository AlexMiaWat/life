# План выполнения задачи: "Преобразовать API в канал среды (внешние воздействия вместо админки)"

## Дата создания: 2026-01-21

## Цель задачи
Преобразовать HTTP API системы Life из административного интерфейса в канал внешних воздействий, ориентированный на симуляцию окружающей среды.

## Текущий анализ API

### Административные функции (подлежат удалению)
- `GET /clear-data` - очистка логов и snapshots
- `GET /refresh-cache` - no-op кэширование

### Функции чтения состояния (ограниченное использование)
- `GET /status` - чтение состояния системы с query-параметрами для фильтрации

### Функции внешних воздействий (расширению)
- `POST /event` - добавление одиночных событий в очередь

## Архитектурные принципы новой среды API

### 1. Канал внешних воздействий
API становится интерфейсом для симуляции внешней среды, а не инструментом администрирования системы.

### 2. Разнообразие воздействий
Поддержка различных типов внешних воздействий через специализированные endpoints.

### 3. Валидация и безопасность
Строгая валидация входящих данных, предотвращение некорректных воздействий.

### 4. Асинхронность
Возможность пакетной отправки событий и асинхронного подтверждения.

## План реализации

### Этап 1: Анализ и проектирование (1-2 дня)
- [x] Анализ текущей структуры API
- [ ] Проектирование новой архитектуры канала среды
- [ ] Определение новых типов воздействий и endpoints

### Этап 2: Удаление административных функций (1 день)
- [ ] Удалить endpoint `GET /clear-data`
- [ ] Удалить endpoint `GET /refresh-cache`
- [ ] Ограничить `GET /status` для отладки (опционально)

### Этап 3: Расширение канала воздействий (2-3 дня)
- [ ] Улучшить `POST /event` с валидацией типов событий
- [ ] Добавить `POST /events` для пакетной отправки событий
- [ ] Добавить `POST /environment/{type}` для типизированных воздействий
- [ ] Добавить `POST /stimulus/{category}` для категоризированных воздействий

### Этап 4: Новая функциональность среды (2-3 дня)
- [ ] Добавить endpoint для симуляции времени (`POST /time/advance`)
- [ ] Добавить endpoint для изменения контекста (`POST /context/change`)
- [ ] Добавить endpoint для комплексных сценариев (`POST /scenario/play`)

### Этап 5: Документация и тестирование (2 дня)
- [ ] Создать ADR для новой архитектуры API
- [ ] Обновить README.md с новой документацией API
- [ ] Обновить интеграционные тесты
- [ ] Добавить тесты для новых endpoints

## Новые endpoints API

### Базовые воздействия
```
POST /event          # Улучшенный одиночный event с валидацией
POST /events         # Пакетная отправка событий
POST /stimulus/{type} # Типизированные стимулы (physical, social, cognitive, existential)
```

### Специализированные воздействия
```
POST /environment/physical   # Физические воздействия (shock, recovery, decay)
POST /environment/social     # Социальные воздействия (presence, conflict, harmony)
POST /environment/cognitive  # Когнитивные воздействия (doubt, clarity, confusion)
POST /environment/existential # Экзистенциальные воздействия (void, purpose, finitude)
```

### Контекст и сценарии
```
POST /time/speed     # Изменение скорости течения времени
POST /context/set    # Установка контекста среды
POST /scenario/start # Запуск предопределенного сценария
```

## Технические требования

### Валидация данных
- Строгая типизация типов событий
- Валидация диапазонов интенсивности
- Проверка корректности метаданных

### Производительность
- Поддержка высоконагруженных сценариев
- Асинхронная обработка больших пакетов событий
- Ограничение частоты запросов для предотвращения перегрузки

### Безопасность
- Валидация всех входных данных
- Предотвращение injection атак
- Логирование всех воздействий для аудита

## Критерии успеха

### Функциональные
- [ ] API больше не содержит административных функций
- [ ] Все типы событий из EventGenerator поддерживаются
- [ ] Возможность симуляции комплексных сценариев среды

### Технические
- [ ] Все тесты проходят
- [ ] Документация обновлена
- [ ] Backward compatibility для /event сохранена

### Архитектурные
- [ ] API соответствует концепции "канала среды"
- [ ] Код чистый и поддерживаемый
- [ ] Новая архитектура документирована в ADR

## Риски и mitigation

### Риск: Нарушение работы существующих клиентов
**Mitigation:** Сохранить backward compatibility для `POST /event`

### Риск: Перегрузка системы большим количеством событий
**Mitigation:** Добавить rate limiting и валидацию размеров пакетов

### Риск: Сложность новой архитектуры
**Mitigation:** Постепенная реализация с тщательным тестированием

## Следующие шаги

1. Создать ADR для новой архитектуры API
2. Начать с удаления административных endpoints
3. Постепенно добавлять новые endpoints для воздействий
4. Обновить тесты и документацию параллельно с разработкой
