# Отчет о тестировании fallback стратегии

**Дата:** 2026-01-20  
**Задача:** Тестирование fallback стратегии без LLM (задача 1768914316)

## Обзор

Проведено полное тестирование fallback стратегии для поиска в проекте Life, включающее:
- Проверку доступности индекса (`_is_index_available()`)
- Линейный поиск по кэшу (уровень 2)
- Grep-поиск по файлам (уровень 3)
- Последовательность переключения между уровнями fallback

## Созданные тесты

### Файл: `src/test/test_mcp_index_engine_fallback.py`

**Количество тестов:** 19

### 1. Тесты проверки доступности индекса (4 теста)

**Класс:** `TestFallbackIndexAvailability`

- ✅ `test_is_index_available_false_when_not_initialized` - индекс недоступен до инициализации
- ✅ `test_is_index_available_false_when_empty_index` - индекс недоступен при пустом индексе
- ✅ `test_is_index_available_false_when_empty_cache` - индекс недоступен при пустом кэше
- ✅ `test_is_index_available_true_when_ready` - индекс доступен когда все готово

### 2. Тесты линейного поиска по кэшу (6 тестов)

**Класс:** `TestFallbackLinearSearch`

- ✅ `test_linear_search_empty_cache` - поиск при пустом кэше
- ✅ `test_linear_search_with_cache` - поиск с кэшем
- ✅ `test_linear_search_and_mode` - поиск в режиме AND
- ✅ `test_linear_search_or_mode` - поиск в режиме OR
- ✅ `test_linear_search_phrase_mode` - поиск в режиме PHRASE
- ✅ `test_linear_search_limit` - ограничение количества результатов

### 3. Тесты grep-поиска по файлам (4 теста)

**Класс:** `TestFallbackGrepSearch`

- ✅ `test_grep_search_no_files` - поиск при отсутствии файлов
- ✅ `test_grep_search_with_files` - поиск с файлами
- ✅ `test_grep_search_updates_cache` - обновление кэша после grep-поиска
- ✅ `test_grep_search_limit` - ограничение количества результатов

### 4. Тесты последовательности fallback (5 тестов)

**Класс:** `TestFallbackSequence`

- ✅ `test_fallback_level_1_index_available` - использование уровня 1 когда индекс доступен
- ✅ `test_fallback_level_2_no_index` - переключение на уровень 2 при недоступности индекса
- ✅ `test_fallback_level_3_no_cache` - переключение на уровень 3 при недоступности кэша
- ✅ `test_fallback_sequence_index_error` - переключение при ошибке индекса
- ✅ `test_fallback_all_levels_fail` - возврат пустого списка если все уровни не дали результатов

## Результаты запуска тестов

```
============================= test session starts ==============================
platform linux -- Python 3.10.12, pytest-9.0.2, pluggy-1.6.0
collected 19 items

src/test/test_mcp_index_engine_fallback.py::TestFallbackIndexAvailability::test_is_index_available_false_when_not_initialized PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackIndexAvailability::test_is_index_available_false_when_empty_index PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackIndexAvailability::test_is_index_available_false_when_empty_cache PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackIndexAvailability::test_is_index_available_true_when_ready PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackLinearSearch::test_linear_search_empty_cache PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackLinearSearch::test_linear_search_with_cache PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackLinearSearch::test_linear_search_and_mode PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackLinearSearch::test_linear_search_or_mode PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackLinearSearch::test_linear_search_phrase_mode PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackLinearSearch::test_linear_search_limit PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackGrepSearch::test_grep_search_no_files PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackGrepSearch::test_grep_search_with_files PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackGrepSearch::test_grep_search_updates_cache PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackGrepSearch::test_grep_search_limit PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackSequence::test_fallback_level_1_index_available PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackSequence::test_fallback_level_2_no_index PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackSequence::test_fallback_level_3_no_cache PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackSequence::test_fallback_sequence_index_error PASSED
src/test/test_mcp_index_engine_fallback.py::TestFallbackSequence::test_fallback_all_levels_fail PASSED

============================== 19 passed in 1.68s ==============================
```

**Результат:** ✅ **19/19 тестов прошли успешно (100%)**

## Покрытие функциональности

### Уровень 1: Инвертированный индекс
- ✅ Проверка доступности индекса
- ✅ Использование индекса при его доступности
- ✅ Обработка ошибок при сбое индекса

### Уровень 2: Линейный поиск по кэшу
- ✅ Поиск по кэшированному содержимому
- ✅ Поддержка всех режимов поиска (AND, OR, PHRASE)
- ✅ Ограничение количества результатов
- ✅ Обработка пустого кэша

### Уровень 3: Grep-поиск по файлам
- ✅ Поиск по файлам на диске
- ✅ Автоматическое обновление кэша после поиска
- ✅ Поддержка всех режимов поиска
- ✅ Ограничение количества результатов

### Последовательность fallback
- ✅ Автоматическое переключение между уровнями
- ✅ Переключение при недоступности индекса
- ✅ Переключение при недоступности кэша
- ✅ Переключение при ошибках
- ✅ Возврат пустого списка если все уровни не дали результатов

## Выявленные и исправленные проблемы

### 1. Обработка ошибок в `_is_index_available()`
**Проблема:** Метод не обрабатывал случай когда `inverted_index` равен `None`

**Исправление:** Добавлена проверка на `None` и обработка исключений:
```python
def _is_index_available(self) -> bool:
    try:
        return (
            self._initialized
            and self.inverted_index is not None
            and len(self.inverted_index) > 0
            and len(self.content_cache) > 0
        )
    except (AttributeError, TypeError):
        return False
```

### 2. Унификация обработки ошибок
**Проблема:** Разные уровни логирования для разных fallback уровней

**Исправление:** Все уровни используют `logger.warning()` для ошибок

### 3. Валидация параметров
**Проблема:** Отсутствие валидации входных параметров в fallback методах

**Исправление:** Добавлена валидация в `_linear_search_in_cache()` и `_grep_search_in_files()`

## Примеры использования

### Пример 1: Симуляция сбоя индекса

```python
from mcp_index_engine import IndexEngine
from pathlib import Path

engine = IndexEngine(docs_dir, todo_dir, src_dir)

# Очищаем индекс для симуляции сбоя
engine.inverted_index.clear()
engine._initialized = False

# Но оставляем кэш
engine.content_cache["test.md"] = "test content"

# Поиск автоматически переключится на уровень 2 (линейный поиск)
results = engine.search_in_directory(
    docs_dir,
    "test",
    mode="AND",
    limit=10
)
```

### Пример 2: Проверка используемого уровня fallback

```python
import logging

# Настройка логирования для отслеживания fallback уровней
logging.basicConfig(level=logging.INFO)

# При использовании fallback уровней 2 или 3 в логах будет:
# INFO: Использован fallback уровень 2 (линейный поиск)
# или
# INFO: Использован fallback уровень 3 (grep-поиск)
```

### Пример 3: Полная симуляция всех уровней fallback

```python
# Уровень 1: Индекс доступен
engine.initialize()
results = engine.search_in_directory(docs_dir, "test")

# Уровень 2: Индекс недоступен, но есть кэш
engine.inverted_index.clear()
engine._initialized = False
results = engine.search_in_directory(docs_dir, "test")

# Уровень 3: Индекс и кэш недоступны
engine.content_cache.clear()
results = engine.search_in_directory(docs_dir, "test")
```

## Критерии переключения между уровнями

### Уровень 1 → Уровень 2
**Условие:** Индекс недоступен или произошла ошибка при поиске через индекс

**Критерии недоступности индекса:**
- `_initialized == False`
- `len(inverted_index) == 0`
- `len(content_cache) == 0`
- `inverted_index == None` (поврежденный индекс)
- Исключение при поиске через индекс

### Уровень 2 → Уровень 3
**Условие:** Кэш пуст или произошла ошибка при линейном поиске

**Критерии недоступности кэша:**
- `len(content_cache) == 0`
- Исключение при линейном поиске

### Переключение обратно на уровень 1
**Условие:** Индекс восстановлен (после переиндексации)

**Критерии восстановления:**
- Вызов `engine.initialize()` или `engine.reindex()`
- `_is_index_available()` возвращает `True`

## Заключение

Все тесты fallback стратегии успешно пройдены. Система корректно переключается между уровнями fallback при сбоях индекса или кэша. Обработка ошибок унифицирована, добавлена валидация параметров.

**Тестирование завершено!**
