# План выполнения задачи "Добавить метрики производительности для всех стадий жизненного цикла"

## Обзор задачи

**Цель:** Реализовать комплексную систему метрик производительности для всех стадий жизненного цикла системы Life, включая измерение времени выполнения, сбор статистики и предоставление API для доступа к метрикам.

**Текущий статус:**
- ✅ Существует базовая инфраструктура `PerformanceMetrics` в `src/runtime/performance_metrics.py`
- ✅ StructuredLogger логирует базовые runtime метрики (tick_duration, queue_size, events_processed)
- ✅ Метрики используются в отдельных операциях (save_snapshot, archive_old_entries, decay_weights)
- ❌ Отсутствуют метрики производительности для всех стадий жизненного цикла

## Анализ стадий жизненного цикла

На основе анализа `src/runtime/loop.py` определены следующие стадии жизненного цикла:

### Основные стадии обработки событий:
1. **Environment** - получение и обработка событий из очереди
2. **Meaning** - интерпретация событий через MeaningEngine
3. **Activation** - активация релевантных воспоминаний
4. **Decision** - принятие решения о паттерне реакции
5. **Action** - выполнение действий и применение эффектов
6. **Feedback** - наблюдение и регистрация последствий действий

### Служебные стадии:
7. **Memory Operations** - операции с памятью (decay, archive)
8. **Learning** - медленное обучение на статистике
9. **Adaptation** - медленная адаптация поведения
10. **Planning/Intelligence** - планирование и обработка информации
11. **Internal Generation** - генерация внутренних событий
12. **State Updates** - обновление состояния системы
13. **Monitoring** - вызов функций мониторинга
14. **Snapshot Management** - управление снапшотами

## План реализации

### Фаза 1: Расширение инфраструктуры метрик (1 неделя)

#### 1.1 Расширение StructuredLogger
**Цель:** Добавить методы для логирования метрик производительности каждой стадии

**Реализация:**
- Добавить методы `log_stage_start()` и `log_stage_end()` для измерения времени стадий
- Добавить методы `log_stage_metrics()` для логирования специфичных метрик стадий
- Расширить формат логов для включения метрик производительности
- Добавить корреляцию метрик с существующими correlation_id

**Новые методы StructuredLogger:**
```python
def log_stage_start(self, stage: str, correlation_id: Optional[str] = None) -> str
def log_stage_end(self, stage: str, duration_ms: float, correlation_id: str, additional_metrics: Optional[Dict] = None) -> None
def log_stage_metrics(self, stage: str, metrics: Dict[str, Any], correlation_id: Optional[str] = None) -> None
```

#### 1.2 Улучшение PerformanceMetrics
**Цель:** Расширить класс для поддержки стадий жизненного цикла

**Реализация:**
- Добавить методы для агрегации метрик по стадиям
- Реализовать расчет перцентилей и статистик
- Добавить экспорт метрик в структурированном формате
- Интегрировать с StructuredLogger

### Фаза 2: Интеграция в Runtime Loop (1-2 недели)

#### 2.1 Добавление замеров времени в основной цикл
**Цель:** Обернуть каждую стадию измерениями производительности

**Реализация в `src/runtime/loop.py`:**
- Environment: измерение времени получения событий из очереди
- Meaning: время обработки каждого события MeaningEngine
- Activation: время активации памяти
- Decision: время принятия решения
- Action: время выполнения действия
- Feedback: время обработки обратной связи
- Memory Operations: время decay и archive операций
- Learning: время обработки статистики
- Adaptation: время применения адаптаций
- Planning/Intelligence: время планирования
- Internal Generation: время генерации внутренних событий
- State Updates: время применения изменений состояния
- Monitoring: время вызова функций мониторинга
- Snapshot Management: время создания снапшотов

#### 2.2 Интеграция с StructuredLogger
**Цель:** Автоматическое логирование метрик производительности стадий

**Реализация:**
- Добавить вызовы `log_stage_start()` и `log_stage_end()` вокруг каждой стадии
- Передавать correlation_id для связывания с цепочками событий
- Логировать специфичные метрики стадий (например, количество активированных воспоминаний, размер очереди)

### Фаза 3: API и агрегация метрик (1 неделя)

#### 3.1 Создание Metrics API
**Цель:** Предоставить доступ к метрикам производительности через HTTP API

**Реализация:**
- Расширить существующий API сервер новыми endpoints:
  - `GET /metrics/performance` - текущие метрики производительности
  - `GET /metrics/stages` - метрики по стадиям жизненного цикла
  - `GET /metrics/history` - исторические метрики
- Добавить поддержку query параметров для фильтрации (стадия, временной диапазон)

#### 3.2 Система агрегации метрик
**Цель:** Реализовать сбор и агрегацию метрик в реальном времени

**Реализация:**
- Создать `MetricsAggregator` класс для обработки сырых метрик
- Реализовать скользящие окна агрегации (1 мин, 5 мин, 1 час)
- Добавить расчет трендов и аномалий
- Интегрировать с существующей системой логирования

### Фаза 4: Тестирование и оптимизация (1 неделя)

#### 4.1 Написание тестов
**Цель:** Обеспечить корректность работы метрик производительности

**Реализация:**
- Unit тесты для новых методов StructuredLogger
- Integration тесты с Runtime Loop
- Performance тесты для проверки накладных расходов
- Тесты точности измерений времени

#### 4.2 Оптимизация производительности
**Цель:** Минимизировать влияние измерений на производительность системы

**Реализация:**
- Оптимизировать частоту логирования метрик
- Добавить конфигурацию уровней детализации метрик
- Провести профилирование накладных расходов
- Реализовать асинхронную обработку метрик при необходимости

## Технические детали

### Формат логов метрик производительности
```json
{
  "timestamp": 1705708800.0,
  "stage": "meaning|decision|action|...",
  "correlation_id": "chain_123",
  "duration_ms": 15.7,
  "metrics": {
    "events_processed": 3,
    "memory_activated": 5,
    "state_changes": 2
  }
}
```

### API Endpoints
```
GET /metrics/performance
- Возвращает текущие метрики производительности по стадиям

GET /metrics/stages/{stage_name}
- Детальные метрики для конкретной стадии

GET /metrics/history?stage={stage}&window={1h}
- Исторические метрики с фильтрацией
```

### Конфигурация
```python
performance_config = {
    "enabled_stages": ["meaning", "decision", "action", "feedback"],
    "aggregation_windows": ["1m", "5m", "1h"],
    "log_level": "detailed"  # minimal|basic|detailed
}
```

## Критерии успеха

### Функциональные:
- ✅ Метрики производительности измеряются для всех 14 стадий жизненного цикла
- ✅ API предоставляет доступ к метрикам в реальном времени
- ✅ Метрики интегрированы в существующие логи с correlation_id
- ✅ Система работает без влияния на основную функциональность

### Производительность:
- ✅ Накладные расходы измерений < 5% от общего времени тика
- ✅ Метрики агрегируются эффективно без утечек памяти
- ✅ Логирование не блокирует основной цикл

### Качество:
- ✅ 95%+ покрытие тестами новых функций
- ✅ Документация обновлена и актуальна
- ✅ Backward compatibility с существующими логами

## Риски и mitigation

1. **Производительность:** Регулярное профилирование и оптимизация замеров
2. **Сложность интеграции:** Поэтапное внедрение с флагами включения
3. **Объем логов:** Конфигурируемые уровни детализации
4. **Точность измерений:** Калибровка и валидация точности таймеров

## План выполнения по неделям

### Неделя 1: Фундамент
- [ ] Расширить StructuredLogger методами для метрик стадий
- [ ] Улучшить PerformanceMetrics для агрегации
- [ ] Создать базовые тесты инфраструктуры

### Неделя 2: Интеграция в Runtime Loop
- [ ] Добавить замеры времени для основных стадий (Environment, Meaning, Decision, Action)
- [ ] Интегрировать логирование метрик с correlation_id
- [ ] Тестирование базовой функциональности

### Неделя 3: Полная интеграция
- [ ] Добавить метрики для всех оставшихся стадий
- [ ] Реализовать Metrics API
- [ ] Создать систему агрегации

### Неделя 4: Финализация
- [ ] Полное тестирование и оптимизация
- [ ] Обновление документации
- [ ] Performance benchmarking

---

**Дата создания:** 2026-01-21
**Статус:** План создан, анализ завершен
**Следующие шаги:** Приступить к реализации расширения StructuredLogger
