# План выполнения задачи: Спроектировать dev-mode как перезапуск процесса

**Задача:** Спроектировать dev-mode как перезапуск процесса (например через внешний watcher) или строгое "stop → start" внутри одного процесса

**Дата создания:** 2026-01-20

**Приоритет:** Высокий (решает критические проблемы dev-режима)

## Анализ проблемы

Текущая реализация dev-mode имеет серьезные проблемы с использованием `importlib.reload()`:

1. **Идентичность объектов**: При перезагрузке создаются новые классы, но старые ссылки остаются
2. **Висящие потоки**: Старые потоки могут не завершиться корректно
3. **Непредсказуемость**: Race conditions между перезагрузкой и использованием объектов
4. **Технический долг**: Проблема #10 в todo/DEBT.md

## Архитектурное решение

### Основной принцип
Заменить hot reload на **перезапуск всего процесса** при обнаружении изменений в исходных файлах.

### Два варианта реализации

#### Вариант 1: Перезапуск процесса (рекомендуемый)
- **ProcessRestarter**: Мониторит изменения файлов и инициирует перезапуск
- **Graceful Shutdown**: Корректное завершение всех компонентов
- **State Persistence**: Сохранение состояния для восстановления
- **Restart Detection**: Обнаружение перезапуска при старте

#### Вариант 2: Strict "stop → start" внутри процесса
- **Component Lifecycle**: Четкий lifecycle для всех компонентов
- **Clean Restart**: Полная остановка всех компонентов и их перезапуск
- **State Preservation**: Сохранение состояния между циклами
- **No Hot Reload**: Полное исключение importlib.reload

## План реализации

### Этап 1: Дизайн архитектуры (Текущий статус: В работе)
- [x] Анализ текущих проблем hot reload
- [x] Изучение существующей документации (SAFE_DEV_MODE.md)
- [ ] Проектирование протокола перезапуска процесса
- [ ] Определение формата сохранения состояния
- [ ] Дизайн механизма graceful shutdown
- [ ] Выбор между вариантами: перезапуск процесса vs strict stop-start

### Этап 2: Реализация базовой инфраструктуры
- [ ] Создать модуль `src/dev/process_restarter.py`
- [ ] Реализовать `GracefulShutdownManager`
- [ ] Добавить `StateSerializer` для сохранения/восстановления
- [ ] Создать механизм обнаружения перезапуска
- [ ] Реализовать мониторинг изменений файлов

### Этап 3: Интеграция в main_server_api.py
- [ ] Заменить `reloader_thread()` на новый механизм
- [ ] Удалить весь код importlib.reload
- [ ] Интегрировать graceful shutdown в основной цикл
- [ ] Добавить логику восстановления состояния при старте
- [ ] Тестирование базовой функциональности

### Этап 4: Расширенное тестирование
- [ ] Создать unit-тесты для всех новых компонентов
- [ ] Добавить интеграционные тесты dev-mode
- [ ] Протестировать сценарии с большими состояниями
- [ ] Проверить корректность восстановления после перезапуска
- [ ] Тестирование производительности и надежности

### Этап 5: Документация и финализация
- [ ] Обновить `docs/development/SAFE_DEV_MODE.md`
- [ ] Обновить `docs/development/HOT_RELOAD_PROBLEMS.md`
- [ ] Обновить README.md (удалить предупреждения о hot reload)
- [ ] Добавить документацию по новой системе dev-mode
- [ ] Удалить технический долг #10 из `todo/DEBT.md`

## Технические детали

### Протокол перезапуска (Вариант 1)

1. **Обнаружение изменений**: Мониторинг mtime файлов каждые 1 сек
2. **Инициирование shutdown**: Установка флага graceful_shutdown
3. **Ожидание завершения**: Таймаут 10 сек на завершение всех потоков
4. **Сохранение состояния**: Сериализация в `restart_state.json`
5. **Перезапуск процесса**: `os.execv(sys.executable, [sys.executable] + sys.argv + ['--restart'])`

### Протокол strict stop-start (Вариант 2)

1. **Обнаружение изменений**: Мониторинг файлов
2. **Stop всех компонентов**: Последовательное завершение с таймаутами
3. **Сохранение состояния**: В памяти или временном файле
4. **Clean start**: Перезапуск всех компонентов с чистым состоянием
5. **Восстановление**: Загрузка сохраненного состояния

### Формат сохранения состояния

```json
{
  "restart_marker": true,
  "timestamp": 1705708800.0,
  "self_state": {...},
  "event_queue": [...],
  "config": {...}
}
```

### Механизм graceful shutdown

- API сервер: `server.shutdown()` + `thread.join(timeout=5)`
- Runtime loop: `loop_stop.set()` + `thread.join(timeout=5)`
- Event queue: сохранение текущих событий
- State: сериализация в restart_state.json

## Риски и mitigation

### Риск: Длительное завершение потоков
**Mitigation:** Увеличить таймауты до 10 сек, добавить force kill как fallback

### Риск: Потеря данных при перезапуске
**Mitigation:** Двойное сохранение (snapshot + restart_state), валидация восстановления

### Риск: Race conditions при сохранении
**Mitigation:** Синхронизация через threading.Lock, атомарные операции

## Критерии успеха

- [ ] Dev-mode работает без importlib.reload
- [ ] Все компоненты корректно завершаются перед перезапуском
- [ ] Состояние полностью восстанавливается после перезапуска
- [ ] Нет утечек ресурсов (потоки, память, соединения)
- [ ] Тесты проходят в dev-mode
- [ ] Производительность не ухудшилась
- [ ] Отсутствуют проблемы идентичности объектов

## Следующие шаги

1. Завершить дизайн архитектуры и выбрать оптимальный вариант
2. Начать реализацию с базовой инфраструктуры
3. Тестировать поэтапно каждый компонент
4. Интегрировать в основной цикл
5. Провести полное тестирование системы

---

**Статус:** Проектирование архитектуры (в работе)
**Следующий этап:** Реализация базовой инфраструктуры
