# План выполнения задачи: Создать событийную очередь для внутренних событий системы

**Идентификатор задачи:** 1768991110

**Дата создания:** 2026-01-21

**Статус:** Активный

## Описание задачи

Создать отдельную событийную очередь для внутренних событий системы, которая будет отличаться от основной EventQueue, используемой для внешних событий. Это позволит разделить обработку внутренних и внешних событий, обеспечить разные стратегии обработки и улучшить архитектуру системы.

## Текущая архитектура

### Существующая обработка событий
- **EventQueue** (`src/environment/event_queue.py`): Thread-safe очередь для всех событий (maxsize=100)
- **InternalEventGenerator** (`src/environment/internal_generator.py`): Генерирует внутренние события (memory_echo)
- **Интеграция**: Внутренние события добавляются напрямую в основную EventQueue в runtime loop

### Проблемы текущей архитектуры
- Смешивание внутренних и внешних событий в одной очереди
- Отсутствие возможности разных стратегий обработки
- Сложность разделения логики обработки разных типов событий

## Цели реализации

1. **Разделение ответственности**: Отдельная очередь для внутренних событий
2. **Гибкость обработки**: Возможность разных стратегий для внутренних/внешних событий
3. **Улучшение архитектуры**: Четкое разделение компонентов
4. **Потокобезопасность**: Thread-safe реализация
5. **Конфигурируемость**: Настраиваемые параметры очереди

## План реализации

### Этап 1: Проектирование архитектуры
- [x] Анализ текущей архитектуры обработки событий
- [ ] Проектирование InternalEventQueue API
- [ ] Определение интерфейса интеграции с runtime loop
- [ ] Определение конфигурационных параметров

### Этап 2: Реализация InternalEventQueue
- [ ] Создание класса InternalEventQueue в `src/environment/internal_event_queue.py`
- [ ] Реализация основных методов (push, pop, pop_all, size, is_empty)
- [ ] Добавление thread-safe механизмов (queue.Queue)
- [ ] Добавление статистики и мониторинга (dropped events count)
- [ ] Добавление конфигурации (maxsize, processing strategy)

### Этап 3: Интеграция в runtime loop
- [ ] Обновление `src/runtime/loop.py` для использования InternalEventQueue
- [ ] Изменение логики генерации внутренних событий
- [ ] Добавление обработки внутренних событий в основной цикл
- [ ] Тестирование совместимости с существующей логикой

### Этап 4: Обновление InternalEventGenerator
- [ ] Изменение интерфейса InternalEventGenerator для работы с InternalEventQueue
- [ ] Добавление методов для пакетной генерации событий
- [ ] Обновление логики принятия решения о генерации (should_generate_echo)

### Этап 5: Конфигурация и параметры
- [ ] Добавление параметров конфигурации в runtime loop
- [ ] Определение разумных значений по умолчанию
- [ ] Добавление валидации параметров

### Этап 6: Тестирование
- [ ] Unit-тесты для InternalEventQueue
- [ ] Интеграционные тесты с runtime loop
- [ ] Тесты производительности
- [ ] Тесты потокобезопасности

### Этап 7: Документация
- [ ] Обновление `docs/components/environment.md`
- [ ] Обновление `docs/components/runtime-loop.md`
- [ ] Добавление примеров использования
- [ ] Архитектурное обоснование решения

## Архитектурные решения

### InternalEventQueue API
```python
class InternalEventQueue:
    def __init__(self, maxsize: int = 50):
        # Thread-safe очередь для внутренних событий

    def push(self, event: Event) -> None:
        # Добавление события с обработкой переполнения

    def pop(self) -> Event | None:
        # Извлечение одного события

    def pop_all(self) -> list[Event]:
        # Извлечение всех событий атомарно

    def size(self) -> int:
        # Текущий размер очереди

    def is_empty(self) -> bool:
        # Проверка пустоты

    def get_dropped_events_count(self) -> int:
        # Статистика потерянных событий
```

### Интеграция в runtime loop
```python
# Инициализация в начале loop
internal_event_queue = InternalEventQueue(maxsize=50)

# В цикле генерации внутренних событий
if internal_generator.should_generate_echo(...):
    internal_event = internal_generator.generate_memory_echo(...)
    if internal_event:
        internal_event_queue.push(internal_event)

# В цикле обработки событий
internal_events = internal_event_queue.pop_all()
for event in internal_events:
    # Обработка внутренних событий
    process_internal_event(event)
```

## Критерии успеха

1. **Функциональность**: InternalEventQueue корректно обрабатывает внутренние события
2. **Совместимость**: Не нарушает существующую логику обработки внешних событий
3. **Производительность**: Не ухудшает производительность runtime loop
4. **Потокобезопасность**: Корректная работа в многопоточной среде
5. **Тестируемость**: Полное покрытие тестами
6. **Документированность**: Обновлена вся необходимая документация

## Риски и mitigation

### Риски
1. **Регрессии**: Нарушение существующей логики обработки событий
   - **Mitigation**: Исчерпывающие тесты, постепенная интеграция

2. **Производительность**: Дополнительная очередь может замедлить систему
   - **Mitigation**: Профилирование, оптимизация, разумные значения по умолчанию

3. **Сложность**: Увеличение сложности архитектуры
   - **Mitigation**: Четкая документация, простые интерфейсы

### Тестирование рисков
- Performance тесты перед/после изменений
- Интеграционные тесты всей системы
- Нагрузочное тестирование с большим количеством событий

## Следующие шаги

1. **Немедленно**: Завершить проектирование InternalEventQueue API
2. **Сегодня**: Реализовать базовый класс InternalEventQueue
3. **Завтра**: Интегрировать в runtime loop и протестировать
4. **Неделя**: Полное тестирование и документация

## Связанные документы

- [docs/components/environment.md](../components/environment.md) - Текущая документация Environment
- [docs/components/runtime-loop.md](../components/runtime-loop.md) - Документация Runtime Loop
- [src/environment/event_queue.py](../../src/environment/event_queue.py) - Реализация EventQueue
- [src/environment/internal_generator.py](../../src/environment/internal_generator.py) - InternalEventGenerator

## Контакты

**Ответственный:** AI Assistant
**Дата следующего отчета:** 2026-01-22