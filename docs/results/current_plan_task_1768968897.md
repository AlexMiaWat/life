# План выполнения задачи: Архитектурная эволюция: Реализация субъективного времени и жизненных ритмов

**Идентификатор задачи:** task_1768968897
**Дата создания:** 2026-01-21
**Статус:** Активный план выполнения

---

## 1. Обзор задачи

### 1.1. Цель
Реализовать полную систему субъективного времени с адаптивными жизненными ритмами, позволяющую системе Life моделировать восприятие времени подобное живым организмам.

### 1.2. Текущий статус реализации
**Уже реализовано:**
- ✅ Базовая математическая модель субъективного времени (`src/runtime/subjective_time.py`)
- ✅ Циркадный ритм с параметрами recovery_efficiency и stability_modifier
- ✅ Clarity Moments система (отключена по умолчанию)
- ✅ Базовый механизм эхо-памяти с trigger_memory_echo
- ✅ Частичная интеграция в decision модуль (time_ratio)

**Требует доработки:**
- ⚠️ Включение субъективного времени в runtime loop (отключено из соображений производительности)
- ⚠️ Расширение циркадного ритма до полноценной системы день/ночь с адаптивными периодами
- ⚠️ Активация Clarity Moments после стабилизации системы
- ⚠️ Улучшение эхо-памяти с учетом субъективного времени
- ⚠️ Полная интеграция во все модули принятия решений

### 1.3. Архитектурные принципы
1. **Субъективное время как метрика восприятия** - не управляющий цикл, а измерение
2. **Детерминированные функции** без side effects
3. **Экспоненциальное сглаживание** для плавных переходов
4. **Независимость внутренних ритмов** от внешнего времени
5. **Интеграция через состояние** - единый источник истины

---

## 2. Подробный план реализации

### Фаза 1: Включение базового субъективного времени (1-2 дня)
**Цель:** Активировать субъективное время в runtime loop с минимальными рисками

#### Задачи:
1. **Анализ производительности** - замер baseline перед изменениями
2. **Включение расчетов** - раскомментировать код в `src/runtime/loop.py` (строки 291-307)
3. **Замена простого инкремента** на полный расчет субъективного времени
4. **Smoke-тестирование** - проверка стабильности системы с новыми расчетами
5. **Валидация монотонности** - обеспечение субъективное время всегда возрастает
6. **Производительность** - проверка что latency тика не увеличился >10%

#### Риски:
- Увеличение latency тика на 5-15%
- Потенциальная нестабильность при высоких нагрузках

#### Критерии успеха:
- Субъективное время рассчитывается на каждом тике
- Монотонность: `subjective_time` всегда возрастает
- Логирование в структурированных логах
- Производительность: latency < baseline + 10%

### Фаза 2: Расширение циркадного ритма (2-3 дня)
**Цель:** Преобразовать базовый циркадный ритм в полноценную систему день/ночь с адаптивными периодами

#### Задачи:
1. **Добавление адаптивных периодов**
   - Модификация `update_circadian_rhythm()` для учета состояния системы
   - Адаптивная длина "дня" на основе стабильности и энергии
   - Новые параметры: `circadian_adaptivity`, `day_length_modifier`

2. **Дополнительные фазы циркадного ритма**
   - Разделение на 4 фазы: рассвет/день/закат/ночь
   - Разные коэффициенты для каждой фазы
   - Влияние на субъективное время в зависимости от фазы

3. **Интеграция ритма в принятие решений**
   - Учет фазы циркадного ритма в decision модуле
   - Модификация recovery_efficiency в зависимости от активности
   - Адаптация stability_modifier под текущие условия

#### Риски:
- Изменение поведения системы при разных фазах
- Сложность настройки параметров адаптивности

#### Критерии успеха:
- Период ритма зависит от состояния системы
- 4 фазы ритма реализованы и работают корректно
- Recovery efficiency и stability modifier обновляются правильно
- Влияние на принятие решений документировано

### Фаза 3: Активация Clarity Moments (1-2 дня)
**Цель:** Включить систему моментов ясности после стабилизации базовых компонентов

#### Задачи:
1. **Подготовка к активации**
   - Аудит ClarityMoments на совместимость с текущей версией
   - Обновление интерфейсов для работы с субъективным временем
   - Тестирование в изолированной среде

2. **Интеграция в runtime loop**
   - Раскомментировать код в `src/runtime/loop.py` (строки 312-316)
   - Изменить флаг `disable_clarity_moments` с True на False
   - Настройка параметров активации

3. **Тестирование моментов ясности**
   - Проверка условий активации (стабильность ≥0.8, энергия ≥70%)
   - Валидация усиления значимости событий (×1.5)
   - Мониторинг влияния на субъективное время

#### Риски:
- Дестабилизация системы при неожиданных изменениях поведения
- Влияние на производительность принятия решений

#### Критерии успеха:
- Моменты ясности активируются при нужных условиях
- Значимость событий усиливается во время clarity
- Clarity события логируются корректно
- Система остается стабильной

### Фаза 4: Улучшение эхо-памяти (2-3 дня)
**Цель:** Интегрировать субъективное время в механизм эхо-памяти

#### Задачи:
1. **Учет субъективного времени в эхо**
   - Модификация `trigger_memory_echo()` для использования subjective_age
   - Новые параметры вероятности на основе фазы циркадного ритма
   - Разные типы эхо с различными характеристиками

2. **Расширение InternalEventGenerator**
   - Улучшение `generate_memory_echo()` с учетом контекста
   - Добавление новых типов внутренних событий
   - Интеграция с циркадным ритмом

3. **Интеграция эхо в принятие решений**
   - Обработка memory_echo событий в decision модуле
   - Влияние эхо на субъективное восприятие времени
   - Запись эхо-событий в память с субъективными timestamp

#### Риски:
- Увеличение частоты внутренних событий
- Изменение паттернов поведения из-за новых воспоминаний

#### Критерии успеха:
- Эхо использует субъективное время вместо физического
- Вероятность зависит от фазы циркадного ритма
- Разные типы эхо реализованы и работают
- Интеграция в decision модуль корректна

### Фаза 5: Полная интеграция в модули принятия решений (3-4 дня)
**Цель:** Распространить влияние субъективного времени на все модули принятия решений

#### Задачи:
1. **Decision модуль**
   - Углубление использования time_ratio в логике принятия решений
   - Учет фазы циркадного ритма при выборе паттернов
   - Влияние моментов ясности на decision-making

2. **Action модуль**
   - Адаптация действий под субъективное время
   - Учет циркадных ритмов при выборе интенсивности действий
   - Модификация эффектов в зависимости от состояния сознания

3. **Planning и Intelligence модули**
   - Интеграция субъективного времени в планирование
   - Адаптация intelligence под циркадные ритмы
   - Учет моментов ясности для улучшения планирования

#### Риски:
- Сложность координации изменений между модулями
- Потенциальные конфликты в логике принятия решений

#### Критерии успеха:
- Все модули (decision, action, planning, intelligence) учитывают субъективное время
- Циркадный ритм влияет на поведение системы
- Моменты ясности изменяют эффективность принятия решений

### Фаза 6: Тестирование и оптимизация (2-3 дня)
**Цель:** Обеспечить надежность и производительность новой функциональности

#### Задачи:
1. **Производительность**
   - Замер накладных расходов на субъективное время
   - Оптимизация расчетов при необходимости
   - Сравнение с baseline производительности

2. **Интеграционное тестирование**
   - Полный жизненный цикл с новыми компонентами
   - Тестирование взаимодействия всех модулей
   - Валидация корректности субъективного времени

3. **Документация и мониторинг**
   - Обновление ADR и компонентной документации
   - Добавление метрик для новых функций
   - Создание примеров использования

#### Риски:
- Регрессии в существующей функциональности
- Недостаточное покрытие тестами

#### Критерии успеха:
- Latency тика не увеличился более чем на 10%
- Все тесты проходят (unit, integration, performance)
- Новая функциональность полностью документирована

---

## 3. Ресурсы и сроки

### 3.1. Оценка трудозатрат
- **Фаза 1:** 1-2 дня (включение базового субъективного времени)
- **Фаза 2:** 2-3 дня (расширение циркадного ритма)
- **Фаза 3:** 1-2 дня (активация Clarity Moments)
- **Фаза 4:** 2-3 дня (улучшение эхо-памяти)
- **Фаза 5:** 3-4 дня (интеграция в модули принятия решений)
- **Фаза 6:** 2-3 дня (тестирование и оптимизация)

**Итого:** 11-17 дней разработки

### 3.2. Контрольные точки
- **День 3:** Базовое субъективное время включено и протестировано
- **День 7:** Циркадный ритм расширен, Clarity Moments активированы
- **День 12:** Полная интеграция в модули принятия решений
- **День 15:** Финальное тестирование и оптимизация
- **День 17:** Документация завершена, задача готова к сдаче

### 3.3. Риски и митигация
1. **Производительность:** Замер baseline, graceful degradation
2. **Регрессии поведения:** Детальное логирование, A/B тестирование
3. **Сложность Clarity Moments:** Поэтапная активация, feature flags
4. **Конфигурация:** Sensible defaults, четкая документация

---

## 4. Критерии приемки

### 4.1. Функциональные критерии
- ✅ Субъективное время включено и работает корректно
- ✅ Циркадный ритм адаптивен с 4 фазами
- ✅ Clarity Moments активированы и влияют на поведение
- ✅ Эхо-память улучшена с учетом субъективного времени
- ✅ Полная интеграция во все модули принятия решений

### 4.2. Нефункциональные критерии
- ✅ Производительность: latency тика < baseline + 10%
- ✅ Надежность: стабильность при 1000+ тиков работы
- ✅ Наблюдаемость: новые метрики логируются
- ✅ Тестируемость: покрытие тестами >90%

### 4.3. Документационные критерии
- ✅ ADR обновлены с новыми решениями
- ✅ Компонентная документация актуальна
- ✅ Примеры использования для всех функций

---

## 5. Связанные документы

- [docs/components/subjective-time.md](../components/subjective-time.md) — документация модуля
- [docs/adr/006-subjective-time.md](../adr/006-subjective-time.md) — архитектурное решение
- [docs/planning/task_1_20260120_212346.md](../planning/task_1_20260120_212346.md) — детальное планирование
- [todo/ROADMAP_2026.md](../../todo/ROADMAP_2026.md) — общий план развития (ST.1-ST.10)

---

**Последнее обновление:** 2026-01-21
**Статус плана:** Готов к выполнению