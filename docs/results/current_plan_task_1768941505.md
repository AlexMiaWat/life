# План выполнения задачи: Добавить smoke-тест на dev-mode

**Задача:** Добавить smoke-тест на dev-mode (старт → изменение → рестарт → сохранение/восстановление snapshot)

**Дата создания:** 2026-01-20

**Приоритет:** Высокий (тестирование критической функциональности dev-mode)

## Анализ текущего состояния

### Существующая функциональность dev-mode
- ✅ Реализован безопасный dev-mode с перезапуском процесса (`src/dev/process_restarter.py`)
- ✅ Компоненты: ProcessRestarter, StateSerializer, GracefulShutdownManager
- ✅ Интеграция в `main_server_api.py` (замена проблематичного hot reload)

### Существующие тесты
- ✅ Статические тесты: 16 тестов (проверка структуры, сигнатур, типов)
- ✅ Дымовые тесты: 27 тестов (базовая функциональность, edge cases)
- ✅ Интеграционные тесты: 13 тестов (полные циклы, многопоточность)

### Пробел в тестировании
- ❌ Отсутствует end-to-end smoke-тест полного цикла dev-mode
- ❌ Нет тестирования реального процесса старт → изменение → рестарт → восстановление
- ❌ Нет интеграции с реальным main_server_api.py

## Архитектурное решение

### Требования к smoke-тесту
1. **Изоляция:** Тест должен работать в изолированной среде
2. **Реалистичность:** Тестировать реальный процесс Life с API
3. **Полнота:** Покрывать полный цикл: старт → изменение файла → рестарт → восстановление состояния
4. **Надежность:** Минимизировать flaky behavior, использовать таймауты
5. **Скорость:** Тест должен выполняться за разумное время (< 30 сек)

### Дизайн теста
- **Тип:** End-to-end smoke тест (pytest.mark.smoke)
- **Подход:** Запуск реального процесса Life в dev-mode, симуляция изменений файлов
- **Валидация:** Проверка сохранения/восстановления состояния через API
- **Очистка:** Автоматическая остановка процесса и cleanup

## План реализации

### Этап 1: Дизайн и подготовка (Текущий)
- [x] Анализ требований и существующих тестов
- [x] Проектирование архитектуры end-to-end теста
- [x] Определение сценария тестирования
- [x] Выбор инструментов и подходов

### Этап 2: Реализация базового теста
- [ ] Создать `src/test/test_dev_mode_smoke_e2e.py`
- [ ] Реализовать запуск процесса Life в dev-mode
- [ ] Добавить симуляцию изменения файла
- [ ] Реализовать ожидание перезапуска
- [ ] Добавить валидацию восстановления состояния

### Этап 3: Расширенная функциональность
- [ ] Добавить проверку сохранения snapshot
- [ ] Реализовать валидацию состояния через API
- [ ] Добавить проверку логов перезапуска
- [ ] Обработать edge cases (таймауты, ошибки)

### Этап 4: Интеграция и оптимизация
- [ ] Интегрировать с pytest фреймворком проекта
- [ ] Добавить маркеры и конфигурацию
- [ ] Оптимизировать время выполнения
- [ ] Добавить подробное логирование

### Этап 5: Тестирование и документация
- [ ] Протестировать на разных платформах
- [ ] Провести нагрузочное тестирование
- [ ] Обновить документацию тестирования
- [ ] Добавить примеры использования

## Технические детали

### Сценарий теста
```python
def test_dev_mode_full_cycle():
    # 1. Запуск процесса Life в dev-mode
    process = start_life_process(dev_mode=True)

    # 2. Ожидание запуска и инициализации
    wait_for_api_ready()

    # 3. Получение начального состояния через API
    initial_state = get_status_via_api()

    # 4. Симуляция изменения файла
    modify_watched_file()

    # 5. Ожидание перезапуска процесса
    wait_for_restart()

    # 6. Валидация восстановления состояния
    restored_state = get_status_via_api()
    validate_state_restoration(initial_state, restored_state)

    # 7. Остановка и cleanup
    stop_process_and_cleanup()
```

### Инструменты и зависимости
- **subprocess:** Для управления процессом Life
- **requests:** Для взаимодействия с API
- **tempfile:** Для создания изолированной среды
- **time:** Для управления таймаутами
- **pytest fixtures:** Для setup/teardown

### Обработка edge cases
- Таймаут запуска процесса
- Ошибки API запросов
- Повреждение файлов состояния
- Проблемы с graceful shutdown
- Race conditions при перезапуске

## Риски и mitigation

### Риск: Flaky тесты из-за timing
**Mitigation:** Увеличенные таймауты, retry логика, детальное логирование

### Риск: Зависимость от внешней среды
**Mitigation:** Полная изоляция через tempfile, mock внешних зависимостей

### Риск: Проблемы с многопоточностью
**Mitigation:** Синхронизация через events, проверка состояния процессов

### Риск: Разные поведения на платформах
**Mitigation:** Кросс-платформенные утилиты, conditional логика

## Критерии успеха

- [ ] Тест успешно запускается и проходит
- [ ] Полный цикл dev-mode протестирован
- [ ] Состояние корректно сохраняется и восстанавливается
- [ ] Тест стабилен (не flaky)
- [ ] Время выполнения < 30 секунд
- [ ] Подробная диагностика при сбоях
- [ ] Интеграция с CI/CD pipeline

## Следующие шаги

1. Начать реализацию базового теста
2. Протестировать на локальной машине
3. Добавить расширенную функциональность
4. Провести интеграционное тестирование
5. Финализировать документацию

---

**Статус:** Дизайн завершен, переход к реализации
**Следующий этап:** Реализация базового теста
