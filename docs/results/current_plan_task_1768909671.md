# План выполнения задачи: Добавить обновление/перестроение индекса отдельной MCP-командой

**ID задачи:** 1768909671  
**Дата создания:** 2026-01-20  
**Статус:** ✅ Выполнено (команда уже реализована)

## Цель задачи

Добавить обновление/перестроение индекса отдельной MCP-командой, чтобы агент мог "refresh index" перед поиском.

## Анализ текущего состояния

### ✅ Команда уже реализована

После изучения кода выявлено, что команда `refresh_index()` уже реализована в файле `mcp_index.py`:

**Расположение:** `mcp_index.py`, строки 628-652

**Реализация:**
```python
@app.tool()
async def refresh_index() -> str:
    """Обновить индекс документации и TODO файлов.
    
    Выполняет полную переиндексацию всех директорий (docs/, todo/).
    Полезно использовать после массового изменения файлов или если индекс устарел.
    
    Returns:
        Сообщение о статусе обновления индекса
    """
    try:
        engine = _get_index_engine()
        engine.reindex()
        
        # Подсчитываем статистику
        cache_size = len(engine.content_cache)
        index_size = len(engine.inverted_index)
        
        return (
            f"Индекс успешно обновлен.\n\n"
            f"- Проиндексировано файлов: {cache_size}\n"
            f"- Уникальных токенов в индексе: {index_size}"
        )
    except Exception as e:
        return f"Ошибка при обновлении индекса: {str(e)}"
```

### ✅ Функциональность проверена

Команда успешно протестирована:
- ✅ Выполняет полную переиндексацию всех директорий (docs/, todo/)
- ✅ Возвращает статистику обновления (количество файлов и токенов)
- ✅ Обработка ошибок реализована
- ✅ Интегрирована в MCP сервер через декоратор `@app.tool()`

**Результат тестирования:**
```
Индекс успешно обновлен.

- Проиндексировано файлов: 185
- Уникальных токенов в индексе: 10870
```

### ✅ Документация присутствует

Команда задокументирована в:
- `docs/testing/MCP_TESTING_GUIDE.md` - описание доступных инструментов MCP
- `docs/testing/MCP_TEST_RESULTS.md` - результаты тестирования
- Docstring функции `refresh_index()` в коде

## План действий

### Этап 1: Проверка текущей реализации ✅

**Статус:** Выполнено

1. ✅ Изучить реализацию команды `refresh_index()` в `mcp_index.py`
2. ✅ Проверить интеграцию с `IndexEngine.reindex()`
3. ✅ Протестировать работу команды
4. ✅ Проверить наличие документации

**Результат:** Команда полностью реализована и работает корректно.

### Этап 2: Верификация функциональности ✅

**Статус:** Выполнено

1. ✅ Проверить, что команда доступна через MCP протокол
2. ✅ Убедиться, что команда возвращает корректную статистику
3. ✅ Проверить обработку ошибок
4. ✅ Убедиться, что команда обновляет индекс для всех директорий

**Результат:** Все проверки пройдены успешно.

### Этап 3: Документирование ✅

**Статус:** Выполнено

1. ✅ Команда описана в `MCP_TESTING_GUIDE.md`
2. ✅ Результаты тестирования зафиксированы в `MCP_TEST_RESULTS.md`
3. ✅ Docstring функции содержит полное описание

**Результат:** Документация полная и актуальная.

## Технические детали

### Архитектура

Команда `refresh_index()` использует следующую архитектуру:

1. **MCP Tool:** `@app.tool()` декоратор делает функцию доступной через MCP протокол
2. **IndexEngine:** Использует глобальный экземпляр `IndexEngine` через `_get_index_engine()`
3. **Метод reindex():** Вызывает `engine.reindex()` для полной переиндексации

### Метод `reindex()` в IndexEngine

**Расположение:** `mcp_index_engine.py`, строки 382-391

```python
def reindex(self):
    """Выполняет полную переиндексацию всех директорий."""
    logger.info("Начало полной переиндексации")
    self.content_cache.clear()
    self.inverted_index.clear()
    self.file_mtimes.clear()
    self.file_tokens.clear()
    self._initialized = False
    self.initialize()
    logger.info("Переиндексация завершена")
```

### Что происходит при вызове `refresh_index()`

1. Получается экземпляр `IndexEngine` (ленивая инициализация при первом использовании)
2. Вызывается `engine.reindex()`, который:
   - Очищает все кэши и индексы
   - Сбрасывает флаг инициализации
   - Выполняет полную переиндексацию директорий `docs/` и `todo/`
3. Подсчитывается статистика:
   - Количество проиндексированных файлов (`len(content_cache)`)
   - Количество уникальных токенов в индексе (`len(inverted_index)`)
4. Возвращается сообщение со статистикой

## Использование

### Через MCP протокол

Команда доступна как MCP tool с именем `refresh_index`:

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "refresh_index",
    "arguments": {}
  }
}
```

### Через Cursor Chat

Агент может использовать команду следующим образом:
```
Используй MCP инструмент refresh_index для обновления индекса перед поиском
```

### Программно

```python
from mcp_index import refresh_index
import asyncio

result = asyncio.run(refresh_index())
print(result)
```

## Критерии приемки

- ✅ Команда `refresh_index()` реализована как MCP tool
- ✅ Команда выполняет полную переиндексацию всех директорий (docs/, todo/)
- ✅ Команда возвращает статистику обновления
- ✅ Команда обрабатывает ошибки корректно
- ✅ Команда задокументирована
- ✅ Команда протестирована

## Выводы

**Задача уже выполнена.** Команда `refresh_index()` полностью реализована, протестирована и задокументирована. Агент может использовать эту команду для обновления индекса перед поиском.

**Рекомендации:**
- Задача может быть помечена как выполненная в TODO списке
- Дополнительных действий не требуется
- Команда готова к использованию в продакшене

## Следующие шаги (опционально)

Если потребуется расширение функциональности в будущем:

1. **Добавить возможность частичного обновления:**
   - Обновление только для конкретной директории (docs/ или todo/)
   - Обновление только для конкретного файла

2. **Добавить параметры:**
   - `force` - принудительное обновление даже если файлы не изменились
   - `directory` - обновление только указанной директории

3. **Улучшить статистику:**
   - Время выполнения переиндексации
   - Количество добавленных/удаленных/измененных файлов
   - Размер индекса в памяти

Но текущая реализация полностью соответствует требованиям задачи.
