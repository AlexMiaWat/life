# Промежуточный отчет: Реализация `search_mode` (AND/OR/PHRASE) для `search_docs`/`search_todo`

> **Дата:** 2026-01-20  
> **Пункт плана:** 2 из `current_plan_task_1768894189.md` (в репозитории найден план-эквивалент: `docs/results/current_plan_task_1768893889.md`)  
> **Источник:** План `mcp_engine_redesign_ab76d85d`

## Что сделано

- **Поддержка `search_mode` в `search_docs`/`search_todo`** уже присутствовала в `mcp_index.py`; выполнена корректировка, чтобы поведение соответствовало примерам из плана.
- **Исправлена логика `_tokenize_query`**:
  - `search_mode` теперь **нормализуется и валидируется** (регистр/неизвестные значения).
  - **Приоритет явного `search_mode` над кавычками**: если запрос в кавычках, но `search_mode="OR"` или `"AND"`, то кавычки **не принудительно включают** PHRASE (как в примере плана).
  - **Явный `search_mode="PHRASE"`** теперь работает **и без кавычек** (ищется точная фраза как строка).
- **Добавлен тест на кейс “quoted query + OR mode”** в `src/test/test_mcp_server.py`.

## Измененные файлы

- `mcp_index.py`
  - обновлена `_tokenize_query` (нормализация/валидация режима, корректный приоритет режима над кавычками, явный PHRASE без кавычек)
- `src/test/test_mcp_server.py`
  - добавлен `test_search_docs_or_mode_with_quoted_query()`
  - добавлен вызов теста в `main()`

## Проверки

- Запущена компиляция: `python3 -m compileall -q .` — ✅
- Запущен тестовый прогон: `python3 src/test/test_mcp_server.py` — ✅ (все тесты прошли, включая новый)

## Примечания/выводы

- Ранее режим PHRASE фактически определялся только кавычками и не позволял воспроизвести пример из плана, где `"test query"` при `search_mode="OR"` должен обрабатываться как OR по токенам. Теперь это поведение исправлено.

Отчет завершен!
