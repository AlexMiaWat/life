# План выполнения задачи: "Интегрировать новые события в генератор с адаптивными интенсивностями"

**Дата:** 2026-01-21
**Задача:** task_1768979912
**Цель:** Реализовать адаптивные интенсивности событий в EventGenerator, где сила воздействия зависит от текущего состояния системы Life

---

## Обзор

Данная задача направлена на расширение EventGenerator адаптивными интенсивностями, где сила генерируемых событий зависит от текущего состояния системы (энергия, стабильность, целостность). Это позволит создать более реалистичную и взаимосвязанную среду, где события реагируют на состояние Life, а не генерируются полностью случайно.

---

## Текущий статус реализации

### ✅ Выполненные компоненты (предварительный анализ)
- **Изучена архитектура EventGenerator:** Текущая реализация использует фиксированные диапазоны интенсивности
- **Определены точки интеграции:** Runtime loop, CLI, API эндпоинты
- **Проанализированы новые типы событий:** 17 новых типов с социальными, когнитивными и экзистенциальными категориями
- **Текущее состояние:** Все новые события интегрированы с фиксированными диапазонами интенсивности

### ❌ Требуемые обновления
- **Адаптивная логика:** Реализовать зависимость интенсивности от состояния системы
- **Интеграция с SelfState:** Передавать текущее состояние в генератор
- **Обратная совместимость:** Сохранить работу без состояния для CLI/API
- **Тестирование:** Валидация адаптивного поведения

---

## Анализ текущей реализации EventGenerator

### Текущая структура генерации

```python
class EventGenerator:
    def generate(self) -> Event:
        # Выбор типа события по вероятностям
        event_type = random.choices(types, weights=weights)[0]

        # Генерация интенсивности в фиксированных диапазонах
        if event_type == "noise":
            intensity = random.uniform(-0.3, 0.3)
        elif event_type == "shock":
            intensity = random.uniform(-1.0, 1.0)
        # ... аналогично для всех типов

        return Event(type=event_type, intensity=intensity, ...)
```

### Проблемы текущего подхода
1. **Отсутствие адаптивности:** Интенсивность не зависит от состояния системы
2. **Фиксированные диапазоны:** Не учитывается чувствительность Life к событиям
3. **Отсутствие контекста:** События генерируются в вакууме без учета истории

---

## Проектирование адаптивных интенсивностей

### Основные принципы адаптации

#### 1. Зависимость от состояния системы
- **Низкая энергия:** Увеличение интенсивности негативных событий (усиление стресса)
- **Низкая стабильность:** Повышение чувствительности к социальным и когнитивным событиям
- **Низкая целостность:** Увеличение вероятности экзистенциальных кризисов
- **Высокая стабильность:** Снижение интенсивности негативных воздействий

#### 2. Категориальная адаптация
- **Физические события:** Адаптация к энергии и целостности
- **Социальные события:** Адаптация к стабильности
- **Когнитивные события:** Адаптация к текущему уровню ясности
- **Экзистенциальные события:** Адаптация к общему благополучию системы

#### 3. Механизмы адаптации
- **Базовый диапазон:** Сохранение оригинальных диапазонов как baseline
- **Модификаторы состояния:** Коэффициенты усиления/ослабления
- **Плавные переходы:** Экспоненциальное сглаживание изменений
- **Ограничения:** Предотвращение экстремальных значений

### Математическая модель адаптации

```python
# Базовый диапазон для типа события
base_min, base_max = get_base_range(event_type)

# Расчет модификатора состояния
state_modifier = calculate_state_modifier(self_state, event_type)

# Адаптивный диапазон
adaptive_min = base_min * (1 + state_modifier)
adaptive_max = base_max * (1 + state_modifier)

# Ограничение экстремальных значений
adaptive_min = clamp(adaptive_min, ABSOLUTE_MIN, ABSOLUTE_MAX)
adaptive_max = clamp(adaptive_max, ABSOLUTE_MIN, ABSOLUTE_MAX)

# Генерация интенсивности
intensity = random.uniform(adaptive_min, adaptive_max)
```

---

## План действий

### Этап 1: Проектирование и анализ (2 дня)
**Цель:** Определить детальную архитектуру адаптивных интенсивностей

**Задачи:**
1. **Анализ требований:** Изучить принципы адаптивности в контексте Life
2. **Проектирование модификаторов:** Определить формулы расчета для каждого типа событий
3. **Архитектурное решение:** Определить интерфейс EventGenerator с опциональным состоянием
4. **Обратная совместимость:** Обеспечить работу без состояния для существующих вызовов

### Этап 2: Реализация базовой адаптации (3 дня)
**Цель:** Добавить адаптивную логику в EventGenerator

**Задачи:**
1. **Обновить интерфейс:** Добавить опциональный параметр self_state в generate()
2. **Реализовать модификаторы:** Создать функции расчета адаптивных коэффициентов
3. **Обновить генерацию интенсивности:** Интегрировать адаптацию для всех типов событий
4. **Добавить валидацию:** Обеспечить корректность адаптивных диапазонов

### Этап 3: Интеграция в систему (2 дня)
**Цель:** Интегрировать адаптивный генератор во все точки использования

**Задачи:**
1. **Runtime Loop:** Добавить передачу состояния в генерацию внутренних событий
2. **API эндпоинты:** Обновить /event эндпоинт для поддержки адаптивной генерации
3. **Generator CLI:** Добавить опции для работы с адаптивными интенсивностями
4. **InternalEventGenerator:** Интегрировать адаптацию в генерацию memory echoes

### Этап 4: Тестирование и валидация (3 дня)
**Цель:** Полная проверка адаптивного поведения

**Задачи:**
1. **Модульные тесты:** Тесты для различных состояний системы
2. **Интеграционные тесты:** Проверка в полном runtime loop
3. **Property-based тесты:** Автоматическая проверка инвариантов адаптации
4. **Регрессионное тестирование:** Подтверждение совместимости

### Этап 5: Документация и финализация (2 дня)
**Цель:** Полная документация и подготовка к релизу

**Задачи:**
1. **Обновить документацию:** Описать адаптивные интенсивности в docs/components/
2. **Добавить примеры:** Показать влияние состояния на генерацию событий
3. **Обновить API документацию:** Документировать новые возможности
4. **Финальное тестирование:** Полная проверка всех компонентов

---

## Архитектурные решения

### Интерфейс EventGenerator

```python
class EventGenerator:
    def generate(self, self_state: SelfState | None = None) -> Event:
        """
        Генерирует событие с адаптивными интенсивностями.

        Args:
            self_state: Текущее состояние системы для адаптации интенсивности.
                       Если None, используется базовая генерация.
        """
        # ... реализация с адаптацией
```

### Логика модификаторов состояния

```python
def calculate_state_modifier(self_state: SelfState, event_type: str) -> float:
    """Расчет модификатора интенсивности на основе состояния."""

    # Базовые коэффициенты чувствительности
    energy_sensitivity = 0.3      # Влияние низкой энергии
    stability_sensitivity = 0.4   # Влияние низкой стабильности
    integrity_sensitivity = 0.2   # Влияние низкой целостности

    # Расчет модификатора на основе типа события
    if event_type in PHYSICAL_EVENTS:
        modifier = calculate_physical_modifier(self_state, energy_sensitivity, integrity_sensitivity)
    elif event_type in SOCIAL_EVENTS:
        modifier = calculate_social_modifier(self_state, stability_sensitivity)
    elif event_type in COGNITIVE_EVENTS:
        modifier = calculate_cognitive_modifier(self_state, stability_sensitivity)
    elif event_type in EXISTENTIAL_EVENTS:
        modifier = calculate_existential_modifier(self_state)
    else:
        modifier = 0.0

    # Ограничение модификатора
    return clamp(modifier, -0.5, 0.5)  # -50% до +50%
```

### Категории событий для адаптации

```python
PHYSICAL_EVENTS = ["noise", "decay", "recovery", "shock", "idle"]
SOCIAL_EVENTS = ["social_presence", "social_conflict", "social_harmony", "connection", "isolation"]
COGNITIVE_EVENTS = ["cognitive_doubt", "cognitive_clarity", "cognitive_confusion", "insight", "confusion", "curiosity"]
EXISTENTIAL_EVENTS = ["existential_void", "existential_purpose", "existential_finitude", "meaning_found", "void", "acceptance"]
INTERNAL_EVENTS = ["memory_echo"]  # Специальная обработка
```

---

## Критерии успеха

### Функциональные критерии
- ✅ **Адаптивная генерация:** Интенсивность зависит от состояния системы
- ✅ **Категориальная адаптация:** Разные правила для разных типов событий
- ✅ **Обратная совместимость:** Работа без состояния для существующих вызовов
- ✅ **Ограничения диапазонов:** Предотвращение экстремальных значений
- ✅ **Производительность:** Без degradation runtime loop

### Нефункциональные критерии
- ✅ **Тестовое покрытие:** >90% для адаптивной функциональности
- ✅ **Документация:** Полное описание адаптивных механизмов
- ✅ **Расширяемость:** Легкое добавление новых правил адаптации
- ✅ **Мониторинг:** Логирование адаптивных решений

---

## Риски и mitigation

### Риски
1. **Изменение поведения:** Адаптивные интенсивности могут изменить паттерны поведения системы
2. **Сложность:** Увеличение сложности генератора событий
3. **Производительность:** Дополнительные вычисления могут замедлить генерацию
4. **Тестируемость:** Сложно тестировать вероятностные адаптивные правила

### Mitigation
1. **Пошаговое внедрение:** Начинать с простых модификаторов
2. **Мониторинг:** Отслеживание изменения паттернов через структурированные логи
3. **Оптимизация:** Кэширование расчетов модификаторов
4. **Тестирование:** Property-based тесты для проверки инвариантов

---

## Временная оценка

- **Общее время:** 12 дней
- **Этапы:** 2 + 3 + 2 + 3 + 2 дней
- **Приоритет:** Средний (расширение функциональности Environment)
- **Зависимости:** Требует стабильной работы SelfState и базовых компонентов

---

## Следующие шаги после реализации

1. **Мониторинг поведения:** Анализ влияния адаптивных интенсивностей на долгосрочное поведение
2. **Калибровка параметров:** Корректировка коэффициентов на основе реальных данных
3. **Расширение адаптации:** Добавление новых факторов влияния (субъективное время, история)
4. **Интеграция с Learning:** Адаптивное изменение чувствительности через обучение

---

**Текущий статус:** План разработан, анализ завершен, готовность к выполнению 100%