# План выполнения задачи: Архитектурная эволюция - Реализация субъективного времени и жизненных ритмов

**Идентификатор задачи:** task_1769012470

**Дата создания:** 2026-01-21

**Статус:** Планирование

**Ответственный:** Project Executor Agent

---

## 1. Обзор задачи

Реализовать полную систему субъективного времени с адаптивными жизненными ритмами для проекта Life. Система должна моделировать восприятие времени подобное живым организмам с циркадными ритмами, моментами ясности и улучшенной эхо-памятью.

### 1.1. Цели
- **Субъективное восприятие времени**: скорость течения времени зависит от интенсивности событий, стабильности и энергии
- **Адаптивные жизненные ритмы**: циркадные ритмы (день/ночь) с внутренней логикой
- **Моменты ясности**: состояния повышенной восприимчивости при благоприятных условиях
- **Эхо-памяти**: спонтанные всплывания воспоминаний с вероятностной логикой
- **Интеграция в принятие решений**: субъективное время влияет на все модули

### 1.2. Текущий статус
- ✅ Базовая математическая модель субъективного времени реализована (`src/runtime/subjective_time.py`)
- ✅ Циркадный ритм частично реализован в SelfState
- ✅ Clarity Moments система существует но отключена
- ❌ Субъективное время отключено в runtime loop (используется простой инкремент)
- ❌ Циркадный ритм не адаптивен (фиксированный период)
- ❌ Эхо-память не учитывает субъективное время

---

## 2. Поэтапный план реализации

### Фаза 1: Включение базового субъективного времени (1-2 дня)
**Цель:** Активировать расчет субъективного времени в runtime loop

**Задачи:**
1. Раскомментировать код расчета субъективного времени в `src/runtime/loop.py` (строки 375-385)
2. Заменить простой инкремент на полный расчет через `compute_subjective_dt()`
3. Включить обновление циркадного ритма `update_circadian_rhythm(dt)`
4. Провести smoke-тестирование с новыми расчетами
5. Измерить производительность и сравнить с baseline

**Критерии успеха:**
- Субъективное время рассчитывается на каждом тике
- Время монотонно возрастает
- Логируется в структурированных логах
- Производительность не ухудшилась >10%

### Фаза 2: Расширение циркадного ритма (2-3 дня)
**Цель:** Сделать циркадный ритм адаптивным с 4 фазами

**Задачи:**
1. Модифицировать `update_circadian_rhythm()` в SelfState для адаптивных периодов
2. Добавить расчет длины "дня" на основе стабильности и энергии
3. Реализовать 4 фазы: рассвет/день/закат/ночь с разными коэффициентами
4. Добавить новые параметры: `circadian_adaptivity`, `day_length_modifier`
5. Интегрировать фазы ритма в логику принятия решений

**Критерии успеха:**
- Период ритма зависит от состояния системы
- 4 фазы реализованы с корректными коэффициентами
- Recovery efficiency и stability modifier обновляются динамически
- Фазы влияют на поведение системы

### Фаза 3: Активация Clarity Moments (1-2 дня)
**Цель:** Включить систему моментов ясности

**Задачи:**
1. Аудит `src/experimental/clarity_moments.py` на совместимость
2. Обновить интерфейсы для работы с субъективным временем
3. Раскомментировать код в runtime loop (строки 312-316)
4. Изменить флаг `disable_clarity_moments` с True на False
5. Настроить параметры активации и тестировать

**Критерии успеха:**
- Моменты ясности активируются при стабильности ≥0.8 и энергии ≥70%
- Значимость событий усиливается ×1.5 во время clarity
- Субъективное время замедляется для лучшего восприятия
- Clarity события корректно логируются

### Фаза 4: Улучшение эхо-памяти (2-3 дня)
**Цель:** Интегрировать субъективное время в механизм эхо-памяти

**Задачи:**
1. Модифицировать `trigger_memory_echo()` для использования subjective_age вместо physical_age
2. Добавить зависимость вероятности эхо от фазы циркадного ритма
3. Реализовать разные типы эхо: эмоциональные, когнитивные, спонтанные
4. Улучшить `generate_memory_echo()` в InternalEventGenerator
5. Интегрировать эхо-события в decision модуль

**Критерии успеха:**
- Эхо использует субъективное время вместо физического
- Вероятность зависит от циркадной фазы
- Разные типы эхо реализованы
- Эхо влияет на субъективное восприятие времени

### Фаза 5: Полная интеграция в модули принятия решений (3-4 дня)
**Цель:** Углубить влияние субъективного времени на все модули

**Задачи:**
1. **Decision модуль**: Углубить использование time_ratio в логике выбора паттернов
2. **Action модуль**: Адаптировать интенсивность действий под циркадные ритмы
3. **Planning модуль**: Интегрировать субъективное время в планирование
4. **Intelligence модуль**: Адаптировать под циркадные ритмы и моменты ясности
5. Тестировать взаимодействие всех модулей

**Критерии успеха:**
- Все модули учитывают субъективное время
- Циркадный ритм влияет на паттерны поведения
- Моменты ясности повышают эффективность принятия решений
- Субъективное время влияет на планирование

### Фаза 6: Тестирование и оптимизация (2-3 дня)
**Цель:** Обеспечить стабильность и производительность

**Задачи:**
1. Измерить накладные расходы на новые функции
2. Оптимизировать расчеты при необходимости
3. Провести интеграционное тестирование полного жизненного цикла
4. Обновить документацию (ADR, компоненты, примеры)
5. Добавить новые метрики мониторинга

**Критерии успеха:**
- Latency тика не увеличился >10%
- Все тесты проходят (unit, integration, performance)
- Система стабильна при 1000+ тиков работы
- Документация обновлена

---

## 3. Риски и митигация

### Риск производительности
- **Описание:** Дополнительные расчеты могут замедлить runtime loop на 5-15%
- **Митигация:** Baseline замеры, оптимизация, graceful degradation

### Риск регрессии поведения
- **Описание:** Изменения могут непредсказуемо повлиять на симуляции
- **Митигация:** Детальное логирование, A/B тестирование, возможность rollback

### Риск интеграции Clarity Moments
- **Описание:** Отключенная система может дестабилизировать после активации
- **Митигация:** Поэтапная активация, feature flags, изоляция

### Риск сложности конфигурации
- **Описание:** Много параметров для настройки
- **Митигация:** Sensible defaults, четкая документация, группировка

---

## 4. Ресурсы и сроки

### Оценка трудозатрат: 11-17 дней
- **Фаза 1:** 1-2 дня
- **Фаза 2:** 2-3 дня
- **Фаза 3:** 1-2 дня
- **Фаза 4:** 2-3 дня
- **Фаза 5:** 3-4 дня
- **Фаза 6:** 2-3 дня

### Контрольные точки
- **День 3:** Базовое субъективное время включено
- **День 7:** Циркадный ритм расширен, Clarity Moments активированы
- **День 12:** Полная интеграция в модули принятия решений
- **День 15:** Финальное тестирование завершено
- **День 17:** Документация готова, задача сдана

### Требования к инфраструктуре
- Тестовое окружение для интеграционного тестирования
- Профилировщик производительности
- CI/CD для автоматического тестирования
- Мониторинг для новых метрик

---

## 5. Критерии приемки

### Функциональные
1. ✅ Субъективное время рассчитывается и монотонно возрастает
2. ✅ Циркадный ритм адаптивен с 4 фазами
3. ✅ Clarity Moments активируются при нужных условиях
4. ✅ Эхо-память использует субъективное время
5. ✅ Полная интеграция во все модули принятия решений

### Нефункциональные
6. ✅ Производительность не ухудшилась >10%
7. ✅ Система стабильна при длительной работе
8. ✅ Все метрики логируются корректно

### Качество кода
9. ✅ >90% покрытие новыми unit-тестами
10. ✅ Документация обновлена и актуальна

---

## 6. План отката

При обнаружении критических проблем:

1. **Отключение Clarity Moments:** `disable_clarity_moments=True`
2. **Отключение субъективного времени:** Возврат к простому инкременту
3. **Rollback циркадного ритма:** Фиксированный период вместо адаптивного
4. **Полный откат:** Восстановление из git

После отката провести мониторинг производительности и анализ причин.

---

## 7. Следующие шаги

1. **Немедленно:** Начать с Фазы 1 (включение базового субъективного времени)
2. **Параллельно:** Изучить текущую реализацию циркадного ритма в SelfState
3. **Подготовка:** Проверить совместимость Clarity Moments системы

**Начало реализации:** После утверждения плана