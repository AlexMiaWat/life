# План выполнения: Реализация эхо памяти (спонтанные всплывания старых воспоминаний)

**Задача:** Реализовать полноценный механизм эхо памяти
**ID задачи:** 1768957431
**Дата создания:** 2026-01-21
**Приоритет:** Высокий

## Описание задачи

Текущая реализация эхо памяти в `InternalEventGenerator` очень базовая - она просто создает абстрактные события `memory_echo` с небольшой вероятностью, без выбора конкретных воспоминаний из архивной памяти.

Необходимо реализовать полноценный механизм, где:
1. Выбирается конкретное старое воспоминание из архивной памяти
2. Создается событие `memory_echo` с данными этого воспоминания
3. Событие проходит через весь pipeline обработки (MeaningEngine → Decision → Action)

## Архитектурные принципы

1. **Конкретность**: Эхо должно основываться на реальных воспоминаниях из архива
2. **Вероятностность**: Механизм должен учитывать различные факторы для определения вероятности всплывания
3. **Влияние**: Всплывшие воспоминания должны оказывать эмоциональное влияние
4. **Ограниченность**: Частота эхо должна быть разумной, чтобы не перегружать систему

## Анализ текущего состояния

### Текущая реализация
- `InternalEventGenerator.generate_memory_echo()` создает абстрактные события
- Вероятность генерации: 2% на тик
- Интенсивность: случайная от -0.2 до 0.2
- Влияние через MeaningEngine: умеренное (вес 0.8, небольшие изменения состояния)

### Недостатки
- Нет связи с реальными воспоминаниями
- Отсутствует эмоциональная глубина
- Не учитывается контекст состояния системы
- Не влияет на поведение через Decision/Action pipeline

## План реализации

### Этап 1: Анализ и проектирование (1 день)

#### 1.1 Изучение компонентов памяти
- Анализ `ArchiveMemory` для понимания структуры хранения
- Изучение `MemoryEntry` и доступных полей для эхо
- Анализ интеграции с `InternalEventGenerator`

#### 1.2 Проектирование механизма выбора воспоминаний
- Определение критериев выбора воспоминаний (возраст, значимость, тип события)
- Разработка алгоритма взвешенного случайного выбора
- Проектирование механизма учета контекста состояния

### Этап 2: Реализация логики выбора воспоминаний (2 дня)

#### 2.1 Создание MemoryEchoSelector
```
src/environment/
└── memory_echo_selector.py
```

Функциональность:
- `select_memory_for_echo(memory: Memory, context_state: SelfState) -> Optional[MemoryEntry]`
- Взвешенный выбор на основе возраста, значимости, типа события
- Учет текущего эмоционального состояния для предпочтений

#### 2.2 Алгоритм выбора:
- **Возраст**: Старые воспоминания (>7 дней) имеют повышенную вероятность
- **Значимость**: Более значимые воспоминания всплывают чаще
- **Тип события**: Эмоциональные события (shock, recovery) предпочтительнее нейтральных
- **Контекст**: При низкой стабильности - тревожные воспоминания, при высокой - позитивные

### Этап 3: Улучшение генерации событий (2 дня)

#### 3.1 Модификация InternalEventGenerator
- Интеграция с MemoryEchoSelector
- Создание событий с данными конкретного воспоминания
- Передача метаданных о всплывшем воспоминании

#### 3.2 Формат события memory_echo:
```python
Event(
    type="memory_echo",
    intensity=calculated_intensity,  # На основе значимости воспоминания
    timestamp=time.time(),
    metadata={
        "internal": True,
        "source": "spontaneous_recall",
        "echo_type": "specific_memory",
        "original_memory": {
            "event_type": memory.event_type,
            "meaning_significance": memory.meaning_significance,
            "timestamp": memory.timestamp,
            "age_days": age_in_days,
        }
    }
)
```

### Этап 4: Обновление MeaningEngine (1 день)

#### 4.1 Улучшение обработки memory_echo
- Учет данных конкретного воспоминания при расчете значимости
- Эмоциональное влияние на основе типа оригинального события
- Контекстуальная модификация в зависимости от текущего состояния

#### 4.2 Эмоциональное влияние:
- **Позитивные воспоминания** (recovery, social_harmony): повышение энергии и стабильности
- **Негативные воспоминания** (shock, decay): временное снижение стабильности
- **Нейтральные воспоминания** (noise, idle): минимальное рефлексивное влияние

### Этап 5: Интеграция и тестирование (2 дня)

#### 5.1 Интеграция в runtime loop
- Обновление вызова InternalEventGenerator в `loop.py`
- Передача доступа к памяти для выбора воспоминаний
- Логирование деталей эхо-событий

#### 5.2 Тестирование
- Unit тесты для MemoryEchoSelector
- Integration тесты с runtime loop
- Тесты вероятностного поведения
- Проверка эмоционального влияния

### Этап 6: Документация и оптимизация (1 день)

#### 6.1 Обновление документации
- Обновление `docs/components/environment.md`
- Обновление `docs/concepts/activation-concept.md`
- Добавление примеров в README

#### 6.2 Профилирование производительности
- Измерение влияния на производительность runtime loop
- Оптимизация алгоритмов выбора при необходимости

## Критерии успеха

### Функциональные критерии
- [ ] Эхо основывается на реальных воспоминаниях из архива
- [ ] Вероятность эхо зависит от возраста и значимости воспоминаний
- [ ] Эхо оказывает эмоциональное влияние на состояние
- [ ] События проходят через полный pipeline обработки
- [ ] Частота эхо не превышает 1 раз в 20-50 тиков

### Нефункциональные критерии
- [ ] Производительность: не более 5% замедления runtime loop
- [ ] Стабильность: отсутствие сбоев при пустом архиве
- [ ] Наблюдаемость: детальное логирование эхо-событий
- [ ] Тестируемость: покрытие тестами > 90%

## Риски и mitigation

### Риски:
1. **Производительность**: Выбор из большого архива может быть медленным
2. **Эмоциональная перегрузка**: Слишком частые негативные воспоминания
3. **Отсутствие воспоминаний**: Пустой архив в начале работы

### Mitigation:
1. **Кэширование**: Предварительная подготовка кандидатов для эхо
2. **Балансировка**: Ограничение частоты и интенсивности эхо
3. **Graceful degradation**: При пустом архиве использовать старую логику

## Временная оценка

- Общее время: 7-9 дней
- Команды: 1 разработчик
- Зависимости: Знание архитектуры памяти и событийной системы

## Следующие шаги

1. Завершить анализ текущей реализации
2. Спроектировать MemoryEchoSelector
3. Реализовать логику выбора воспоминаний
4. Улучшить генерацию событий
5. Обновить MeaningEngine
6. Интегрировать и протестировать
