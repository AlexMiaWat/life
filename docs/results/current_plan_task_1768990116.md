# План выполнения задачи "Создать систему метрик производительности для всех стадий жизненного цикла"

## Обзор задачи

**Цель:** Реализовать комплексную систему метрик производительности для всех стадий жизненного цикла системы Life, обеспечивающую измерение времени выполнения, сбор статистики, анализ трендов и предоставление API для доступа к метрикам.

**Текущий статус:**
- ✅ Существует базовая инфраструктура метрик (StructuredLogger, PerformanceMetrics)
- ✅ Реализована система baseline и проверки регрессий производительности
- ✅ Есть базовые runtime метрики (tick_duration, queue_size, events_processed)
- ❌ Отсутствует полное покрытие всех стадий жизненного цикла метриками производительности

## Анализ стадий жизненного цикла

На основе анализа `src/runtime/loop.py` и архитектуры системы определены следующие стадии жизненного цикла, требующие метрик производительности:

### Основные стадии обработки событий:
1. **Environment Processing** - получение и обработка событий из очереди
2. **Meaning Processing** - интерпретация событий через MeaningEngine
3. **Memory Activation** - активация релевантных воспоминаний
4. **Decision Making** - принятие решения о паттерне реакции
5. **Action Execution** - выполнение действий и применение эффектов
6. **Feedback Observation** - наблюдение и регистрация последствий действий

### Служебные стадии:
7. **Memory Operations** - операции с памятью (decay, archive, search)
8. **Learning Processing** - медленное обучение на статистике
9. **Adaptation Processing** - медленная адаптация поведения
10. **Planning/Intelligence** - планирование и обработка информации
11. **Internal Event Generation** - генерация внутренних событий
12. **State Updates** - обновление состояния системы
13. **Monitoring** - вызов функций мониторинга
14. **Snapshot Management** - управление снапшотами
15. **Tick Management** - управление тиками и интервалами

## Архитектура системы метрик

### 1. LifecycleStages - Перечисление стадий
```python
class LifecycleStage(Enum):
    ENVIRONMENT = "environment"
    MEANING = "meaning"
    ACTIVATION = "activation"
    DECISION = "decision"
    ACTION = "action"
    FEEDBACK = "feedback"
    MEMORY_OPS = "memory_ops"
    LEARNING = "learning"
    ADAPTATION = "adaptation"
    PLANNING = "planning"
    INTERNAL_GEN = "internal_gen"
    STATE_UPDATE = "state_update"
    MONITORING = "monitoring"
    SNAPSHOT = "snapshot"
    TICK_MGMT = "tick_mgmt"
```

### 2. StageMetrics - Метрики стадии
```python
@dataclass
class StageMetrics:
    stage: LifecycleStage
    duration_ms: float
    start_time: float
    end_time: float
    correlation_id: Optional[str]
    additional_metrics: Dict[str, Any]
    success: bool
    error_message: Optional[str]
```

### 3. MetricsAggregator - Агрегатор метрик
- Сбор метрик в реальном времени
- Агрегация по скользящим окнам (1m, 5m, 15m, 1h)
- Расчет статистик (среднее, перцентили, тренды)
- Детекция аномалий и регрессий

### 4. Performance API - HTTP API
- `GET /metrics/performance` - текущие метрики производительности
- `GET /metrics/stages/{stage}` - метрики конкретной стадии
- `GET /metrics/history` - исторические метрики с фильтрами
- `GET /metrics/anomalies` - детекция аномалий

## План реализации

### Фаза 1: Базовая инфраструктура (1 неделя)

#### 1.1 Расширение StructuredLogger
**Цель:** Добавить поддержку метрик производительности стадий

**Задачи:**
- Добавить методы `log_stage_start()`, `log_stage_end()`, `log_stage_metrics()`
- Расширить формат логов для включения метрик производительности
- Добавить корреляцию метрик с существующими correlation_id
- Поддержать специфичные метрики стадий (events_count, memory_size, etc.)

#### 1.2 Создание LifecycleStages
**Цель:** Определить все стадии жизненного цикла

**Задачи:**
- Создать enum LifecycleStage со всеми 15 стадиями
- Определить обязательные и опциональные метрики для каждой стадии
- Создать StageMetrics dataclass для унифицированного представления

#### 1.3 Создание базового MetricsAggregator
**Цель:** Реализовать базовую агрегацию метрик

**Задачи:**
- Создать MetricsAggregator класс
- Реализовать сбор метрик в кольцевые буферы
- Добавить базовые статистики (среднее, min/max, count)
- Интегрировать с существующими baseline механизмами

### Фаза 2: Интеграция в Runtime Loop (2 недели)

#### 2.1 Добавление замеров времени
**Цель:** Обернуть каждую стадию измерениями производительности

**Задачи:**
- Environment: время получения событий + размер очереди
- Meaning: время обработки каждого события + количество обработанных
- Activation: время активации + количество активированных воспоминаний
- Decision: время принятия решения + выбранный паттерн
- Action: время выполнения + эффекты на состояние
- Feedback: время обработки + количество записей feedback

#### 2.2 Интеграция служебных стадий
**Цель:** Добавить метрики для фоновых операций

**Задачи:**
- Memory Operations: время decay/archive + количество обработанных записей
- Learning: время обработки статистики + изменения параметров
- Adaptation: время применения адаптаций + количество изменений
- Planning/Intelligence: время выполнения + результаты
- Internal Generation: время генерации + количество созданных событий
- State Updates: время применения изменений + количество полей
- Monitoring: время вызова + результаты
- Snapshot: время создания + размер снапшота

#### 2.3 Оптимизация накладных расходов
**Цель:** Минимизировать влияние на производительность

**Задачи:**
- Использовать time.perf_counter() для точных измерений
- Добавить конфигурируемые уровни детализации
- Реализовать асинхронную запись метрик при необходимости
- Провести профилирование накладных расходов

### Фаза 3: API и продвинутые возможности (1 неделя)

#### 3.1 Реализация Performance API
**Цель:** Предоставить доступ к метрикам через HTTP

**Задачи:**
- Добавить endpoints в main_server_api.py
- Реализовать фильтрацию по стадиям и временным диапазонам
- Добавить экспорт метрик в JSON/CSV форматы
- Интегрировать с существующей системой аутентификации

#### 3.2 Продвинутые возможности агрегации
**Цель:** Реализовать анализ трендов и аномалий

**Задачи:**
- Добавить расчет перцентилей (P50, P95, P99)
- Реализовать детекцию аномалий на основе статистических методов
- Добавить сравнение с baseline значениями
- Создать алертинг для критических регрессий

### Фаза 4: Тестирование и оптимизация (1 неделя)

#### 4.1 Комплексное тестирование
**Цель:** Обеспечить корректность и надежность

**Задачи:**
- Unit тесты для всех компонентов метрик
- Integration тесты с Runtime Loop
- Performance тесты для проверки накладных расходов
- Нагрузочное тестирование с большим количеством метрик

#### 4.2 Финализация и документация
**Цель:** Подготовить систему к production

**Задачи:**
- Обновить документацию архитектуры
- Создать руководства по использованию метрик
- Провести финальное профилирование
- Создать примеры использования API

## Технические детали

### Формат логов метрик производительности
```json
{
  "timestamp": 1705708800.0,
  "stage": "meaning",
  "correlation_id": "chain_123",
  "duration_ms": 15.7,
  "success": true,
  "metrics": {
    "events_processed": 3,
    "avg_significance": 0.7,
    "patterns_used": ["dampen", "absorb"]
  }
}
```

### API Endpoints
```
GET /metrics/performance
- Возвращает текущие метрики по всем стадиям

GET /metrics/stages/{stage_name}?window=5m
- Детальные метрики стадии с агрегацией

GET /metrics/history?stages=meaning,decision&from=1705708800&to=1705708900
- Исторические метрики с фильтрацией

GET /metrics/anomalies?threshold=2.0
- Детекция аномалий производительности
```

### Конфигурация системы метрик
```python
performance_config = {
    "enabled_stages": ["*"],  # все стадии или список конкретных
    "aggregation_windows": ["1m", "5m", "15m", "1h"],
    "log_level": "detailed",  # none|basic|detailed
    "anomaly_detection": {
        "enabled": True,
        "threshold_stddev": 2.0,
        "min_samples": 10
    },
    "api_limits": {
        "max_history_hours": 24,
        "max_response_size": 1000
    }
}
```

## Критерии успеха

### Функциональные:
- ✅ Метрики производительности для всех 15 стадий жизненного цикла
- ✅ API предоставляет доступ к метрикам в реальном времени
- ✅ Детекция аномалий и регрессий производительности
- ✅ Полная интеграция с существующими логами и correlation_id

### Производительность:
- ✅ Накладные расходы измерений < 5% от общего времени тика
- ✅ Метрики агрегируются эффективно без утечек памяти
- ✅ Система выдерживает высокую нагрузку без degradation

### Качество:
- ✅ >95% покрытие тестами новых функций
- ✅ Полная документация и примеры использования
- ✅ Backward compatibility с существующими компонентами

## Риски и mitigation

1. **Производительность:** Регулярное профилирование и оптимизация, конфигурируемые уровни детализации
2. **Сложность интеграции:** Поэтапное внедрение, автоматизированное тестирование
3. **Объем данных:** Компрессия логов, ротация, конфигурируемые лимиты
4. **Точность измерений:** Калибровка таймеров, валидация в тестах

## План выполнения по неделям

### Неделя 1: Фундамент
- [ ] Создать LifecycleStages enum и StageMetrics
- [ ] Расширить StructuredLogger для метрик стадий
- [ ] Создать базовый MetricsAggregator
- [ ] Написать unit тесты инфраструктуры

### Неделя 2: Интеграция основных стадий
- [ ] Добавить замеры для Environment, Meaning, Decision, Action
- [ ] Интегрировать с correlation_id и существующими логами
- [ ] Создать базовые performance тесты
- [ ] Проверить накладные расходы

### Неделя 3: Полная интеграция
- [ ] Добавить метрики для всех оставшихся стадий
- [ ] Реализовать Performance API endpoints
- [ ] Создать продвинутую агрегацию и анализ трендов
- [ ] Интегрировать детекцию аномалий

### Неделя 4: Финализация
- [ ] Полное тестирование и оптимизация
- [ ] Создание документации и примеров
- [ ] Финальное профилирование производительности
- [ ] Подготовка к production

---

**Дата создания:** 2026-01-21
**Статус:** План создан, анализ завершен
**Следующие шаги:** Приступить к реализации LifecycleStages и расширению StructuredLogger