# План выполнения задачи: Dev-mode без "горячего" importlib.reload

**Задача:** Реализовать безопасный dev-mode с перезапуском процесса вместо hot reload через importlib.reload

**Дата создания:** 2026-01-20

**Приоритет:** Средний (критично для dev-режима)

## Анализ проблемы

Текущая реализация hot reload через `importlib.reload()` имеет следующие проблемы:

1. **Идентичность объектов**: При перезагрузке создаются новые классы, но старые ссылки остаются
2. **Висящие потоки**: Старые потоки могут не завершиться корректно, оставаясь активными
3. **Непредсказуемость**: Race conditions между перезагрузкой и использованием объектов

## Архитектурное решение

### Основной принцип
Заменить hot reload на **перезапуск всего процесса** при обнаружении изменений в исходных файлах.

### Ключевые компоненты решения

1. **Process Restarter**: Мониторит изменения файлов и инициирует перезапуск
2. **Graceful Shutdown**: Корректное завершение всех компонентов перед перезапуском
3. **State Persistence**: Сохранение состояния для восстановления после перезапуска
4. **Restart Detection**: Обнаружение перезапуска при старте и восстановление состояния

## План реализации

### Этап 1: Дизайн архитектуры (Текущий статус: В работе)
- [x] Анализ текущих проблем hot reload
- [ ] Проектирование протокола перезапуска процесса
- [ ] Определение формата сохранения состояния
- [ ] Дизайн механизма graceful shutdown

### Этап 2: Реализация базовой инфраструктуры
- [ ] Создать модуль `src/dev/process_restarter.py` для мониторинга и перезапуска
- [ ] Реализовать `GracefulShutdownManager` для корректного завершения
- [ ] Добавить `StateSerializer` для сохранения/восстановления состояния
- [ ] Создать механизм обнаружения перезапуска

### Этап 3: Интеграция в main_server_api.py
- [ ] Заменить `reloader_thread()` на новый `process_restarter_thread()`
- [ ] Удалить весь код importlib.reload
- [ ] Интегрировать graceful shutdown в основной цикл
- [ ] Добавить логику восстановления состояния при старте

### Этап 4: Тестирование и отладка
- [ ] Создать unit-тесты для новых компонентов
- [ ] Добавить интеграционные тесты dev-mode
- [ ] Протестировать сценарии с большими состояниями
- [ ] Проверить корректность восстановления после перезапуска

### Этап 5: Документация и cleanup
- [ ] Обновить `docs/development/HOT_RELOAD_PROBLEMS.md`
- [ ] Обновить README.md (удалить предупреждения о hot reload)
- [ ] Добавить документацию по новому dev-mode
- [ ] Удалить технический долг из `todo/DEBT.md`

## Технические детали

### Протокол перезапуска

1. **Обнаружение изменений**: Мониторинг mtime файлов каждые 1 сек
2. **Инициирование shutdown**: Установка флага graceful_shutdown
3. **Ожидание завершения**: Таймаут 10 сек на завершение всех потоков
4. **Сохранение состояния**: Сериализация self_state в специальный файл
5. **Перезапуск процесса**: `os.execv(sys.executable, [sys.executable] + sys.argv + ['--restart'])`

### Формат сохранения состояния

```json
{
  "restart_marker": true,
  "timestamp": 1705708800.0,
  "self_state": {...},
  "event_queue": [...],
  "config": {...}
}
```

### Механизм graceful shutdown

- API сервер: `server.shutdown()` + `thread.join(timeout=5)`
- Runtime loop: `loop_stop.set()` + `thread.join(timeout=5)`
- Event queue: сохранение текущих событий
- State: сериализация в restart_state.json

## Риски и mitigation

### Риск: Длительное завершение потоков
**Mitigation:** Увеличить таймауты до 10 сек, добавить force kill как fallback

### Риск: Потеря данных при перезапуске
**Mitigation:** Двойное сохранение (snapshot + restart_state), валидация восстановления

### Риск: Race conditions при сохранении
**Mitigation:** Синхронизация через threading.Lock, атомарные операции

## Критерии успеха

- [ ] Dev-mode работает без importlib.reload
- [ ] Все компоненты корректно завершаются перед перезапуском
- [ ] Состояние полностью восстанавливается после перезапуска
- [ ] Нет утечек ресурсов (потоки, память, соединения)
- [ ] Тесты проходят в dev-mode
- [ ] Производительность не ухудшилась

## Следующие шаги

1. Завершить дизайн архитектуры
2. Начать реализацию с `process_restarter.py`
3. Тестировать поэтапно каждый компонент
4. Интегрировать в основной цикл
5. Провести полное тестирование системы

---

**Статус:** Проектирование архитектуры (в работе)
**Следующий этап:** Реализация базовой инфраструктуры
