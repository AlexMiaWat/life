# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–≤—å—é –∑–∞–¥–∞—á–∏ 1768916097: –†–∞–∑–≥—Ä—É–∑–∏—Ç—å `src/runtime/loop.py`

**–†–æ–ª—å:** –°–∫–µ–ø—Ç–∏–∫  
**–î–∞—Ç–∞:** 2026-01-20  
**–ó–∞–¥–∞—á–∞:** –†–∞–∑–≥—Ä—É–∑–∏—Ç—å `src/runtime/loop.py`: –≤—ã–¥–µ–ª–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—ã –∏ —É–±—Ä–∞—Ç—å "—Å–∫—Ä—ã—Ç—ã–µ" —Ä–∞—Å—Ö–æ–¥—ã

## –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞

–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ —Ü–µ–ª–æ–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, –Ω–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–µ–¥–æ—Ä–∞–±–æ—Ç–∫–∏** –∏ **–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –ø–ª–∞–Ω–∞**, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –ø—Ä–∏–Ω—è—Ç–∏–µ–º –∑–∞–¥–∞—á–∏.

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. –ù–µ–ø–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ `print()` –Ω–∞ `logger`

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –∫–æ–¥–µ –æ—Å—Ç–∞–ª—Å—è –ø—Ä—è–º–æ–π –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å —á–µ—Ä–µ–∑ `traceback.print_exc()` (—Å—Ç—Ä–æ–∫–∞ 578 –≤ `src/runtime/loop.py`).

**–ö–æ–¥:**
```python
except Exception as e:
    self_state.apply_delta({"integrity": -ERROR_INTEGRITY_PENALTY})
    logger.error(f"[LOOP] –û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ: {e}", exc_info=True)
    traceback.print_exc()  # ‚ùå –ü–†–Ø–ú–û–ô –í–´–í–û–î –í –ö–û–ù–°–û–õ–¨
    log_manager.maybe_flush(self_state, phase="exception")
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è  
**–ü—Ä–∏—á–∏–Ω–∞:** 
- –ù–∞—Ä—É—à–∞–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–π –ø—Ä–∏–µ–º–∫–∏ **FC4**: "`print()` —É–¥–∞–ª–µ–Ω—ã –∏–∑ hot-path `run_loop` –∏ –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `logger`"
- `traceback.print_exc()` ‚Äî —ç—Ç–æ –ø—Ä—è–º–æ–π –≤—ã–≤–æ–¥ –≤ `stderr`, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `logger`
- –ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å `exc_info=True` –≤ `logger.error()` —ç—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞
- –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ü–µ–ª–∏ –∑–∞–¥–∞—á–∏: —É–±—Ä–∞—Ç—å –Ω–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π –≤—ã–≤–æ–¥ –∏–∑ hot-path

**–†–µ—à–µ–Ω–∏–µ:** –£–¥–∞–ª–∏—Ç—å `traceback.print_exc()`, —Ç–∞–∫ –∫–∞–∫ `logger.error(..., exc_info=True)` —É–∂–µ –≤—ã–≤–æ–¥–∏—Ç –ø–æ–ª–Ω—ã–π traceback.

**–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–ª–∞–Ω:** –≠—Ç–∞–ø 4, –∑–∞–¥–∞—á–∞ 1: "–ó–∞–º–µ–Ω–∏—Ç—å `print()` –Ω–∞ `logger` –≤ `run_loop()`"

---

### 2. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `snapshot_was_made` –≤ `LogManager.maybe_flush()`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–∞—Ä–∞–º–µ—Ç—Ä `snapshot_was_made` –æ–±—ä—è–≤–ª–µ–Ω –≤ —Å–∏–≥–Ω–∞—Ç—É—Ä–µ –º–µ—Ç–æ–¥–∞ `maybe_flush()`, –Ω–æ **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

**–ö–æ–¥:**
```python
def maybe_flush(
    self,
    self_state: SelfState,
    *,
    phase: Literal["tick", "before_snapshot", "exception", "shutdown"],
    snapshot_was_made: bool = False,  # ‚ùå –ü–ê–†–ê–ú–ï–¢–† –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø
) -> None:
    # ... —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç snapshot_was_made
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–ü—Ä–∏—á–∏–Ω–∞:**
- –í docstring –µ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π "(–¥–ª—è flush –ø–æ—Å–ª–µ —Å–Ω–∞–ø—à–æ—Ç–∞, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)" ‚Äî —ç—Ç–æ –ø—Ä–∏–∑–Ω–∞–∫ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã
- –ü–ª–∞–Ω –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–ª –ø–æ–¥–¥–µ—Ä–∂–∫—É flush –ø–æ—Å–ª–µ —Å–Ω–∞–ø—à–æ—Ç–∞ (—Å–º. –ø–ª–∞–Ω, —ç—Ç–∞–ø 2: "flush –Ω–∞ '–≥—Ä–∞–Ω–∏—Ü–∞—Ö': –ø–µ—Ä–µ–¥/–ø–æ—Å–ª–µ —Å–Ω–∞–ø—à–æ—Ç–∞")
- –õ–∏–±–æ –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –ª–∏–±–æ —É–¥–∞–ª–∏—Ç—å (–µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –Ω–µ –Ω—É–∂–Ω–∞)

**–†–µ—à–µ–Ω–∏–µ:** 
- –í–∞—Ä–∏–∞–Ω—Ç 1: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É flush –ø–æ—Å–ª–µ —Å–Ω–∞–ø—à–æ—Ç–∞, –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–æ –∑–∞–¥—É–º–∞–Ω–æ
- –í–∞—Ä–∏–∞–Ω—Ç 2: –£–¥–∞–ª–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –Ω–µ –Ω—É–∂–Ω–∞

**–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–ª–∞–Ω:** –≠—Ç–∞–ø 2, –∑–∞–¥–∞—á–∞ 2: "flush –Ω–∞ '–≥—Ä–∞–Ω–∏—Ü–∞—Ö': –ø–µ—Ä–µ–¥/–ø–æ—Å–ª–µ —Å–Ω–∞–ø—à–æ—Ç–∞"

---

## ‚ö†Ô∏è –°–ï–†–¨–ï–ó–ù–´–ï –ù–ï–î–û–†–ê–ë–û–¢–ö–ò

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ `None` –¥–ª—è `event_queue` –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –∫–æ–¥–µ –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ `if event_queue and not event_queue.is_empty():`, –Ω–æ –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö `event_queue` –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏.

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–ü—Ä–∏—á–∏–Ω–∞:** –ï—Å–ª–∏ `event_queue` –º–æ–∂–µ—Ç –±—ã—Ç—å `None` (—Å—É–¥—è –ø–æ —Å–∏–≥–Ω–∞—Ç—É—Ä–µ —Ñ—É–Ω–∫—Ü–∏–∏), —Ç–æ –Ω—É–∂–Ω–∞ —è–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–∑–¥–µ, –≥–¥–µ –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –í —Å—Ç—Ä–æ–∫–µ 273 –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ `if event_queue and not event_queue.is_empty():`, —á—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ù–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Å—Ç–∏ –∞—É–¥–∏—Ç –≤—Å–µ—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π `event_queue` –≤ `loop.py`.

---

### 4. –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è `LogManager`

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (`docs/components/runtime-loop.md`) –æ–ø–∏—Å–∞–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∞–∑—ã `"after_snapshot"`, –Ω–æ –≤ –∫–æ–¥–µ —Ç–∞–∫–æ–π —Ñ–∞–∑—ã –Ω–µ—Ç.

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
```markdown
- `maybe_flush(self_state, phase, snapshot_was_made)` ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –±—É—Ñ–µ—Ä –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ –ø–æ–ª–∏—Ç–∏–∫–µ
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
phase: Literal["tick", "before_snapshot", "exception", "shutdown"]
# ‚ùå –ù–µ—Ç —Ñ–∞–∑—ã "after_snapshot"
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–ü—Ä–∏—á–∏–Ω–∞:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥—É. –õ–∏–±–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∞–∑—É, –ª–∏–±–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é.

**–†–µ—à–µ–Ω–∏–µ:** –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π.

---

## ‚ö†Ô∏è –°–û–ú–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–®–ï–ù–ò–Ø

### 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `last_flush_tick = 0` –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–º—É flush

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `LogManager.__init__()` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `self.last_flush_tick = 0`. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ `maybe_flush()` —Å `phase="tick"` –Ω–∞ —Ç–∏–∫–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, 5, —É—Å–ª–æ–≤–∏–µ `ticks_since_flush >= flush_period_ticks` –±—É–¥–µ—Ç `True` (5 - 0 >= 10? –ù–µ—Ç, –Ω–æ –µ—Å–ª–∏ —Ç–∏–∫ 10, —Ç–æ –¥–∞).

**–ö–æ–¥:**
```python
def __init__(self, ...):
    self.last_flush_tick = 0  # ‚ö†Ô∏è –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–ü—Ä–∏—á–∏–Ω–∞:** 
- –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Ç–∏–∫ = 10, —Ç–æ flush –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç —Å—Ä–∞–∑—É (10 - 0 >= 10)
- –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∂–µ–ª–∞–µ–º—ã–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º, –Ω–æ –Ω–µ–æ—á–µ–≤–∏–¥–Ω–æ
- –õ—É—á—à–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ `-flush_period_ticks`, —á—Ç–æ–±—ã –ø–µ—Ä–≤—ã–π flush –±—ã–ª –Ω–∞ —Ç–∏–∫–µ `flush_period_ticks`

**–†–µ—à–µ–Ω–∏–µ:** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é `self.last_flush_tick = -self.flush_policy.flush_period_ticks` –¥–ª—è –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è.

---

### 6. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞—Ö `SnapshotManager`, `LogManager`, `LifePolicy` –Ω–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

**–ü—Ä–∏–º–µ—Ä—ã:**
- `SnapshotManager(period_ticks=-1, ...)` ‚Äî –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥
- `LifePolicy(weakness_threshold=-1.0, ...)` ‚Äî –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥
- `FlushPolicy(flush_period_ticks=0, ...)` ‚Äî –Ω—É–ª–µ–≤–æ–π –ø–µ—Ä–∏–æ–¥

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `pydantic`/`dataclasses` —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π).

---

## üìã –û–¢–ö–õ–û–ù–ï–ù–ò–Ø –û–¢ –ü–õ–ê–ù–ê

### 7. –ù–µ–ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏ flush "–ø–æ—Å–ª–µ —Å–Ω–∞–ø—à–æ—Ç–∞"

**–ü–ª–∞–Ω (–≠—Ç–∞–ø 2):**
> flush –Ω–∞ "–≥—Ä–∞–Ω–∏—Ü–∞—Ö": –ø–µ—Ä–µ–¥/–ø–æ—Å–ª–µ —Å–Ω–∞–ø—à–æ—Ç–∞, —Ä–∞–∑ –≤ N —Ç–∏–∫–æ–≤, –ø—Ä–∏ exception, –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- ‚úÖ –ü–µ—Ä–µ–¥ —Å–Ω–∞–ø—à–æ—Ç–æ–º ‚Äî —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (`phase="before_snapshot"`)
- ‚ùå –ü–æ—Å–ª–µ —Å–Ω–∞–ø—à–æ—Ç–∞ ‚Äî **–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ** (–ø–∞—Ä–∞–º–µ—Ç—Ä `snapshot_was_made` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- ‚úÖ –†–∞–∑ –≤ N —Ç–∏–∫–æ–≤ ‚Äî —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- ‚úÖ –ü—Ä–∏ exception ‚Äî —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- ‚úÖ –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ ‚Äî —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–†–µ—à–µ–Ω–∏–µ:** –õ–∏–±–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å flush –ø–æ—Å–ª–µ —Å–Ω–∞–ø—à–æ—Ç–∞, –ª–∏–±–æ —è–≤–Ω–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ —ç—Ç–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

---

### 8. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ `docs/components/runtime-loop.md` –≤ —Ä–∞–º–∫–∞—Ö –∑–∞–¥–∞—á–∏

**–ü–ª–∞–Ω (–≠—Ç–∞–ø 6):**
> –û–±–Ω–æ–≤–∏—Ç—å `docs/components/runtime-loop.md`, –µ—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞, –Ω–æ –µ—Å—Ç—å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è (—Å–º. –ø—Ä–æ–±–ª–µ–º—É #4).

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π.

---

## ‚úÖ –ß–¢–û –°–î–ï–õ–ê–ù–û –•–û–†–û–®–û

1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤:** –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É `SnapshotManager`, `LogManager`, `LifePolicy`
2. **–¢–µ—Å—Ç—ã:** –•–æ—Ä–æ—à–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ unit-—Ç–µ—Å—Ç–∞–º–∏ (19 —Ç–µ—Å—Ç–æ–≤)
3. **–ó–∞–º–µ–Ω–∞ `print()`:** –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ `print()` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `logger` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏
4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ `run_loop()`
5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ—à–∏–±–∫–∏ –±–µ–∑ –ø–∞–¥–µ–Ω–∏—è —Ü–∏–∫–ª–∞
6. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –•–æ—Ä–æ—à–∏–µ docstrings –≤ –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Å–∞—Ö

---

## üìä –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –ö–†–ò–¢–ï–†–ò–Ø–ú –ü–†–ò–ï–ú–ö–ò

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-------------|
| **FC1:** –ù–µ—Ç inline-–ª–æ–≥–∏–∫–∏ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `SnapshotManager` |
| **FC2:** –ù–µ—Ç "flush –Ω–∞ –∫–∞–∂–¥–æ–º —Ç–∏–∫–µ" | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `LogManager` —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π |
| **FC3:** –õ–æ–≥–∏–∫–∞ "weakness/penalties" –≤ `LifePolicy` | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ | –í—ã–Ω–µ—Å–µ–Ω–æ –≤ `LifePolicy` |
| **FC4:** `print()` —É–¥–∞–ª–µ–Ω—ã –∏–∑ hot-path | ‚ùå **–ù–ï –í–´–ü–û–õ–ù–ï–ù–û** | –û—Å—Ç–∞–ª—Å—è `traceback.print_exc()` |
| **FC5:** Unit-—Ç–µ—Å—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ | 19 —Ç–µ—Å—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ |

### –ù–µ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-------------|
| **NFC1:** –ù–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ I/O –Ω–∞ –∫–∞–∂–¥–æ–º —Ç–∏–∫–µ | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ | Flush –ø–æ –ø–æ–ª–∏—Ç–∏–∫–µ |
| **NFC2:** –ö–æ–¥ —á–∏—Ç–∞–±–µ–ª–µ–Ω –∫–∞–∫ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ | –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –≤—ã–¥–µ–ª–µ–Ω—ã |
| **NFC3:** –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ | –ü–æ –æ—Ç—á–µ—Ç—É –≤—Å–µ –ø—Ä–æ—Ö–æ–¥—è—Ç |

---

## üîç –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

### 9. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å `snapshot_was_made` –≤ –≤—ã–∑–æ–≤–µ

**–ö–æ–¥:**
```python
snapshot_was_made = snapshot_manager.maybe_snapshot(self_state)
log_manager.maybe_flush(self_state, phase="tick", snapshot_was_made=snapshot_was_made)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–∞—Ä–∞–º–µ—Ç—Ä `snapshot_was_made` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –ª–æ–∂–Ω–æ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞.

**–†–µ—à–µ–Ω–∏–µ:** –õ–∏–±–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä, –ª–∏–±–æ —É–¥–∞–ª–∏—Ç—å –µ–≥–æ –∏–∑ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã.

---

### 10. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ `None` –¥–ª—è `saver` –≤ `SnapshotManager`

**–ö–æ–¥:**
```python
def __init__(self, period_ticks: int, saver: Callable[[SelfState], None]):
    self.period_ticks = period_ticks
    self.saver = saver  # ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ None
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ `saver=None`, –æ—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `maybe_snapshot()`, –∞ –Ω–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `if saver is None: raise ValueError("saver cannot be None")`.

---

### 11. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ `None` –¥–ª—è `flush_fn` –≤ `LogManager`

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø—Ä–æ–±–ª–µ–º–µ #10:** –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ `flush_fn` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ `LogManager`.

---

## üìù –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ (—Ç—Ä–µ–±—É—é—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –ø—Ä–∏–Ω—è—Ç–∏–µ–º)

1. **–£–¥–∞–ª–∏—Ç—å `traceback.print_exc()`** –∏–∑ —Å—Ç—Ä–æ–∫–∏ 578 –≤ `src/runtime/loop.py`
2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å** –ø–∞—Ä–∞–º–µ—Ç—Ä `snapshot_was_made` –≤ `LogManager.maybe_flush()`

### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ (—É–ª—É—á—à–∞—Ç –∫–∞—á–µ—Å—Ç–≤–æ)

3. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π
5. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é `last_flush_tick` –¥–ª—è –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
6. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ `None` –¥–ª—è callback-—Ñ—É–Ω–∫—Ü–∏–π

---

## üéØ –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–¢–†–ï–ë–£–ï–¢–°–Ø –î–û–†–ê–ë–û–¢–ö–ê**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –Ω–µ–ø–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ `print()` –Ω–∞ `logger` (–æ—Å—Ç–∞–ª—Å—è `traceback.print_exc()`)
- –°–µ—Ä—å–µ–∑–Ω–∞—è –Ω–µ–¥–æ—Ä–∞–±–æ—Ç–∫–∞: –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `snapshot_was_made`
- –ù–µ—Å–∫–æ–ª—å–∫–æ –º–µ–ª–∫–∏—Ö –Ω–µ–¥–æ—Ä–∞–±–æ—Ç–æ–∫ –∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –æ—Ç –ø–ª–∞–Ω–∞

**–í—ã–≤–æ–¥:** –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω –Ω–∞ **~85%**, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –ø–µ—Ä–µ–¥ –ø—Ä–∏–Ω—è—Ç–∏–µ–º. –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–Ω—è—Ç–∞.

---

–û—Ç—á–µ—Ç –≥–æ—Ç–æ–≤!
