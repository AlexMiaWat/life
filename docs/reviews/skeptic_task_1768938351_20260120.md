# Ревью Скептика: Текущие доработки и документация (2026-01-20)

## Общий анализ

Проведен анализ текущего состояния проекта после реализации высокоприоритетных задач из ROADMAP_2026. Обнаружены серьезные проблемы в коде и тестах, которые ставят под сомнение корректность реализации и стабильность системы.

## Критические проблемы в коде

### 1. Архитектурные нарушения в ArchiveMemory

**Проблема:** Класс `ArchiveMemory` имеет некорректную реализацию, которая приводит к загрузке данных из файла `data/archive/memory_archive.json` во все экземпляры, независимо от параметров инициализации.

**Текущее поведение:**
- При создании любого экземпляра `ArchiveMemory` (включая тестовые) загружаются данные из глобального файла архива
- Тесты `TestArchiveMemory` падают с `assert 4391 == 0`, что указывает на наличие 4391 записей в памяти вместо ожидаемого 0
- Нарушение принципа изоляции компонентов и непредсказуемое поведение

**Последствия:**
- Невозможность изолированного тестирования компонентов памяти
- Потенциальные проблемы с производительностью при большом объеме архивных данных
- Нарушение инкапсуляции данных

**Рекомендация:** Переработать логику загрузки архива, сделать ее строго контролируемой через параметры `load_existing` и `archive_file`.

### 2. Проблемы с загрузкой состояния в SelfState

**Проблема:** В методе `load_snapshot_from_file` происходит принудительная загрузка архивной памяти:

```python
state.archive_memory = ArchiveMemory()
state.archive_memory._load_archive()  # Принудительная загрузка без проверки
```

**Проблемы:**
- Архив загружается всегда, даже если это не требуется
- Нет обработки ошибок при загрузке архива
- Нарушение декларативного подхода к загрузке состояния

### 3. Отклонения от плана в реализации субъективного времени

**Проблема:** Реализация `SubjectiveTime` выглядит корректной, но отсутствует интеграция с `MemoryEntry` для хранения `subjective_timestamp`.

**Текущий код MemoryEntry:**
```python
subjective_timestamp: Optional[float] = None
```

**Проблема:** В `runtime/loop.py` субъективное время не записывается в память при создании записей. Отсутствует логика обновления `MemoryEntry.subjective_timestamp`.

### 4. Неконсистентность в SnapshotManager

**Проблема:** `SnapshotManager` не интегрирован с `LogManager` для синхронизации flush логов перед сохранением.

**Текущая реализация:** Метод `maybe_snapshot` делает снимок без координации с логированием, что может привести к несогласованным состояниям.

## Проблемы в тестах

### 1. Массовые провалы тестов

Из 652 тестов 74 провалены (11.3% failure rate), что недопустимо для проекта.

**Критические категории:**
- **Monitor (6 тестов):** Файлы логов не создаются, `tick_log.jsonl` отсутствует
- **Memory (10 тестов):** Проблемы с ArchiveMemory и подсчетом записей
- **State Management (13 тестов):** Валидация полей не работает, логирование состояния сломано
- **Performance (4 теста):** Производительность ниже требуемой в 2-8 раз
- **Learning/Adaptation (13 тестов):** Отсутствующие импорты, неправильные параметры, проблемы с интеграцией

### 2. Async-тесты MCP Server

Все MCP-тесты падают с ошибкой "async def functions are not natively supported". Отсутствует `pytest-asyncio` в зависимостях, хотя код использует async/await.

## Отклонения от плана

### 1. Незавершенная реализация субъективного времени

**План:** "Протянуть субъективный timestamp в MemoryEntry и привязать воспоминания к субъективному времени"

**Реальность:** Поле добавлено, но логика записи отсутствует. Субъективное время вычисляется, но не сохраняется в памяти.

### 2. Отсутствие интеграции менеджеров в runtime loop

**План:** Вынести менеджеры и убрать "скрытые" расходы

**Реальность:** Менеджеры `SnapshotManager`, `LogManager`, `LifePolicy` реализованы, но интеграция в `runtime/loop.py` неполная. Отсутствует координация между менеджерами.

### 3. Проблемы с потокобезопасностью

**План:** Ввести "immutable snapshot для API" и синхронизацию доступа

**Реальность:** Реализация отсутствует. API все еще может читать изменяющееся состояние.

## Сомнительные решения

### 1. Глобальный файл архива

Наличие глобального файла `data/archive/memory_archive.json` с реальными данными в репозитории проекта создает проблемы:
- Тесты не изолированы
- Разные среды могут иметь разные данные
- Нарушение принципа чистоты тестов

### 2. Диагностические print в runtime

Несмотря на план "Убрать print() из hot-path runtime", в коде остаются отладочные выводы.

### 3. Неправильная обработка ошибок

В `SnapshotManager.maybe_snapshot` ошибки логируются, но не возвращают информацию о неудаче. Это может скрывать проблемы с сохранением состояния.

## Рекомендации

1. **Исправить ArchiveMemory** - сделать загрузку строго контролируемой
2. **Добавить интеграцию субъективного времени** в память
3. **Исправить async-тесты** - добавить pytest-asyncio в зависимости
4. **Реализовать потокобезопасность** для API
5. **Улучшить обработку ошибок** в менеджерах
6. **Добавить интеграционные тесты** для новых менеджеров
7. **Очистить глобальный архив** из репозитория

## Заключение

Текущие доработки имеют серьезные архитектурные проблемы, которые делают систему нестабильной и трудно тестируемой. Необходима существенная переработка ключевых компонентов перед продолжением развития.

Отчет готов!